pfp
–ü—Ä–∏–≤—ñ—Ç! –¢–∏ –Ω–µ –±–∞—á–∏—à –æ—Å—Ç–∞–Ω–Ω—ñ—ó –º–æ—ó—Ö –ø–∏—Ç–∞–Ω—å?

–ü—Ä–∏–≤—ñ—Ç! –Ø –±–∞—á—É —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ —Ç–∏ –ø–∏—à–µ—à –º–µ–Ω—ñ –∑–∞—Ä–∞–∑, —ñ –Ω–µ –º–∞—é –¥–æ—Å—Ç—É–ø—É –¥–æ —Ç–≤–æ—ó—Ö –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø–∏—Ç–∞–Ω—å, —è–∫—â–æ –≤–æ–Ω–∏ –±—É–ª–∏ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω—ñ –Ω–µ –º–µ–Ω—ñ —á–∏ –≤ —ñ–Ω—à–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ. –Ø–∫ —è –º–æ–∂—É —Ç–æ–±—ñ –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ?

–≤ –º–µ–Ω–µ —î –¥–æ–¥–∞—Ç–æ–∫ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —è–∫–æ–≥–æ –º–æ–∂–Ω–∞ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç, –∑
–º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö —á–∞—Ç—ñ–≤ –∞–∫–∫–∞—É–Ω—Ç—É —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –¥–æ–¥–∞—Ç–∫—É:
–õ–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É —Å–∏—Å—Ç–µ–º—ñ.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É.
–ü–µ—Ä–µ–≥–ª—è–¥ —É—Å—ñ—Ö —á–∞—Ç—ñ–≤ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ–≥–æ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É.
–ü–µ—Ä–µ–≥–ª—è–¥ —É—Å—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –æ–±—Ä–∞–Ω–æ–≥–æ —á–∞—Ç—É.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –≤–∏—Ö–æ–¥—É –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ–≥–æ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –≤–∏—Ö–æ–¥—É —ñ–∑ —Å–∏—Å—Ç–µ–º–∏.
–í–∏–º–æ–≥–∏:
–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ —á–∞—Å—Ç–∏–Ω–∞: React –∞–±–æ Next.js.
–°–µ—Ä–≤–µ—Ä–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞: Fastapi.–†–æ–∑—Ä–æ–±–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —è–∫–æ–≥–æ –º–æ–∂–Ω–∞ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç, –∑
–º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö —á–∞—Ç—ñ–≤ –∞–∫–∫–∞—É–Ω—Ç—É —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –¥–æ–¥–∞—Ç–∫—É:
–õ–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É —Å–∏—Å—Ç–µ–º—ñ.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É.
–ü–µ—Ä–µ–≥–ª—è–¥ —É—Å—ñ—Ö —á–∞—Ç—ñ–≤ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ–≥–æ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É.
–ü–µ—Ä–µ–≥–ª—è–¥ —É—Å—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –æ–±—Ä–∞–Ω–æ–≥–æ —á–∞—Ç—É.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –≤–∏—Ö–æ–¥—É –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ–≥–æ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É.
–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –≤–∏—Ö–æ–¥—É —ñ–∑ —Å–∏—Å—Ç–µ–º–∏.
–í–∏–º–æ–≥–∏:
–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ —á–∞—Å—Ç–∏–Ω–∞: React –∞–±–æ Next.js.
–°–µ—Ä–≤–µ—Ä–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞: Fastapi. import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from telethon.errors import FloodWaitError
from dotenv import load_dotenv
from telethon.errors import FloodWaitError, SessionExpiredError
from pydantic import BaseModel, ConfigDict
from typing import Optional
from telethon import types
import asyncio

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è

load_dotenv()

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É

app = FastAPI()

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS

app.add_middleware(
CORSMiddleware,
allow_origins=["http://localhost:3000"],
allow_credentials=True,
allow_methods=["*"],
allow_headers=["*"],
)

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è JWT

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Telegram

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

# –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# –°—Ö–µ–º–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")

# –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏—Ö —Å–µ—Å—ñ–π Telegram

tg_clients = {}

# –ú–æ–¥–µ–ª—ñ –∑–∞–ø–∏—Ç—ñ–≤

class UserCreate(BaseModel):
username: str
password: str

class UserLogin(BaseModel):
username: str
password: str

class TelegramSendCode(BaseModel):
phone: str

class TelegramConnect(BaseModel):
code: str # –û–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ
password: Optional[str] = None # –ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ
phone: Optional[str] = None # –î–æ–¥–∞—î–º–æ —è–∫ –Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–µ

class TelegramSession(BaseModel):
phone: str
phone_code_hash: str
client: Optional[types.User] = None # –¶–µ –ø–æ–ª–µ –≤–∏–∫–ª–∏–∫–∞—î –ø—Ä–æ–±–ª–µ–º—É

    model_config = ConfigDict(arbitrary_types_allowed=True)  # ‚úÖ –î–æ–∑–≤–æ–ª—è—î –¥–æ–≤—ñ–ª—å–Ω—ñ —Ç–∏–ø–∏

    # –¢–∏–º—á–∞—Å–æ–≤–µ —Å—Ö–æ–≤–∏—â–µ –¥–ª—è —Å–µ—Å—ñ–π (–º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ Redis –∞–±–æ –ë–î)

temp_sessions = {}

# –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

async def get_db():
async with AsyncSessionLocal() as session:
yield session

    # –õ–æ–≥—É–≤–∞–Ω–Ω—è –º—ñ–¥–ª–≤–∞—Ä

@app.middleware("http")
async def log_requests(request, call_next):
print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
response = await call_next(request)
print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
return response

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ

@app.on_event("startup")
async def startup():
async with engine.begin() as conn:
await conn.run_sync(Base.metadata.create_all)

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω–∞

def create_access_token(data: dict):
to_encode = data.copy()
expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
to_encode.update({"exp": expire})
return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

async def get_current_user(
token: str = Depends(oauth2_scheme),
db: AsyncSession = Depends(get_db)
):
try:
payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
username = payload.get("sub")
if not username:
raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        return user
    except JWTError:
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

# –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
result = await db.execute(select(User).filter(User.username == user.username))
if result.scalar():
raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await db.commit()
    return {"message": "User created successfully"}

# –õ–æ–≥—ñ–Ω

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
result = await db.execute(select(User).filter(User.username == user.username))
db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
print(f"üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è: {current_user.username}")

    if not current_user.telegram_phone:
        return {"connected": False}
    return {"connected": True}

# –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram

@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
try:
session_data = temp_sessions.get(current_user.id)
if not session_data or "client" not in session_data:
raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        await client.sign_in(
            phone=session_data["phone"],
            code=auth.code,
            phone_code_hash=session_data["phone_code_hash"],
            password=auth.password
        )

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é –Ω–∞ –¥–∏—Å–∫
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        await client.sign_in(phone=session_data["phone"], code=auth.code, phone_code_hash=session_data["phone_code_hash"])

        current_user.telegram_phone = session_data["phone"]
        await db.commit()
        await client.disconnect()
        del temp_sessions[current_user.id]

        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
if not current_user.telegram_phone:
raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f'sessions/session_{current_user.id}', API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")  # –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É

@app.post("/send-code")
async def send_code(
data: TelegramSendCode,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
try:
if current_user.id in temp_sessions:
await temp_sessions[current_user.id]["client"].disconnect()
del temp_sessions[current_user.id]

        client = TelegramClient(f"session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        raise HTTPException(400, detail=str(e))

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —á–∞—Ç–∞

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
chat_id: int,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
client = tg_clients.get(current_user.telegram_phone)
if not client:
raise HTTPException(status_code=404, detail="Telegram not connected")

    messages = await client.get_messages(chat_id, limit=20)
    return [{"id": m.id, "text": m.text, "date": m.date} for m in messages]

# –í–∏—Ö—ñ–¥ –∑ Telegram

@app.post("/logout-telegram")
async def logout_telegram(
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
client = tg_clients.pop(current_user.telegram_phone, None)
if client:
await client.disconnect()
current_user.telegram_phone = None
await db.commit()
return {"message": "Telegram disconnected"}

# –í–∏—Ö—ñ–¥ –∑ —Å–∏—Å—Ç–µ–º–∏

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
return {"message": "Logged out from system"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è

@app.get("/health")
async def health_check():
return {"status": "OK"} —Ü–µ —Å–µ—Ä–≤–µ—Ä–Ω–∞ —á–∞–≤—Ç–∏–Ω–∞. –∞ —Ü–µ –∫–ª—ñ–µ–Ω—Ç—Å—å–∫–∞ –Ω–∞ –Ω–µ–∫—Å—Ç—ñ: import { useEffect } from "react";
import { useRouter } from "next/router";

export default function HomePage() {
const router = useRouter();

    useEffect(() => {
        const token = localStorage.getItem("token");
        router.push(token ? "/dashboard" : "/login");
    }, []);

    return null; // –ê–±–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

} import { useState } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Login() {
const [username, setUsername] = useState("");
const [password, setPassword] = useState("");
const [error, setError] = useState("");
const router = useRouter();

    const handleLogin = async (e) => {
        e.preventDefault();

        try {
            const res = await fetch("http://localhost:8000/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password }),
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.detail || "Login failed");

            localStorage.setItem("token", data.access_token);
            router.push("/dashboard");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
            <h1 className="text-2xl font-bold mb-6">–í—Ö—ñ–¥</h1>
            {error && <p className="text-red-500 mb-4">{error}</p>}
            <form onSubmit={handleLogin} className="space-y-4">
                <input
                    type="text"
                    placeholder="–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="w-full p-2 border rounded"
                />
                <input
                    type="password"
                    placeholder="–ü–∞—Ä–æ–ª—å"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full p-2 border rounded"
                />
                <button
                    type="submit"
                    className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                >
                    –£–≤—ñ–π—Ç–∏
                </button>
            </form>
            <p className="mt-4 text-center">
                –ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞?{" "}
                <Link
                    href="/register"
                    className="text-blue-500 hover:underline"
                >
                    –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è
                </Link>
            </p>
        </div>
    );

}
import { useState } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Register() {
const [username, setUsername] = useState("");
const [password, setPassword] = useState("");
const [error, setError] = useState("");
const router = useRouter();

    const handleSubmit = async (e) => {
        e.preventDefault();

        try {
            const res = await fetch("http://localhost:8000/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password }),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "Registration failed");
            }

            router.push("/login");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
            <h1 className="text-2xl font-bold mb-6">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
            {error && <p className="text-red-500 mb-4">{error}</p>}
            <form onSubmit={handleSubmit} className="space-y-4">
                <input
                    type="text"
                    placeholder="–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="w-full p-2 border rounded"
                />
                <input
                    type="password"
                    placeholder="–ü–∞—Ä–æ–ª—å"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full p-2 border rounded"
                />
                <button
                    type="submit"
                    className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                >
                    –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è
                </button>
            </form>
            <p className="mt-4 text-center">
                –í–∂–µ –º–∞—î—Ç–µ –∞–∫–∞—É–Ω—Ç?{" "}
                <Link href="/login" className="text-blue-500 hover:underline">
                    –£–≤—ñ–π—Ç–∏
                </Link>
            </p>
        </div>
    );

}
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
const [phone, setPhone] = useState("");
const [code, setCode] = useState("");
const [chats, setChats] = useState([]);
const [isConnected, setIsConnected] = useState(false);
const [isCodeSent, setIsCodeSent] = useState(false);
const [error, setError] = useState("");
const router = useRouter();
const [twoFactorPassword, setTwoFactorPassword] = useState("");
// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
useEffect(() => {
const checkConnection = async () => {
const token = localStorage.getItem("token");
if (!token) {
router.push("/login");
return;
}

            try {
                const res = await fetch(
                    "http://localhost:8000/check-connection",
                    {
                        headers: { Authorization: `Bearer ${token}` },
                    }
                );

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(
                        data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è"
                    );
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    // –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
    const sendCode = async (e) => {
        e.preventDefault();
        setError("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok)
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");

            setIsCodeSent(true);
        } catch (err) {
            setError(err.message);
        }
    };

    // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await fetchChats(); // –î–æ—á–µ–∫–∞–π—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
        } catch (err) {
            setError(err.message);
        }
    };

    // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤
    const fetchChats = async () => {
        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/chats", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
            }

            const data = await res.json();
            setChats(data);
        } catch (err) {
            setError(err.message);
        }
    };

    // –ü–æ–∫–∞–∑—É—î–º–æ —á–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ Telegram –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ
    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}

            {!isConnected ? (
                // –§–æ—Ä–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        // –ö—Ä–æ–∫ 1: –í–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) =>
                                    setTwoFactorPassword(e.target.value)
                                }
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        // –ö—Ä–æ–∫ 2: –í–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É –∑ Telegram
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                // –°–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={() => setIsConnected(false)}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-4">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="p-4 border rounded hover:bg-gray-50"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-blue-500 hover:underline"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );

}
import { useState, useEffect } from "react";
import { useRouter } from "next/router";

export default function Chats() {
const [chats, setChats] = useState([]);
const [error, setError] = useState("");
const router = useRouter();

    useEffect(() => {
        const fetchChats = async () => {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/chats", {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
                const data = await res.json();
                setChats(data);
            } catch (err) {
                setError(err.message);
            }
        };
        fetchChats();
    }, [router]);

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6">–í–∞—à—ñ —á–∞—Ç–∏</h1>
            {error && <p className="text-red-500 mb-4">{error}</p>}
            <div className="space-y-4">
                {chats.map((chat) => (
                    <div key={chat.id} className="p-4 border rounded">
                        <p>{chat.name}</p>
                    </div>
                ))}
            </div>
        </div>
    );

}
–ø–æ –ø–µ—Ä—à–µ –∫—Ä–∏–≤–æ –ø—Ä–∞—Ü—é—î –≤–∏—Ö—ñ–¥ –∑ —å–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç—É, –≤–æ–Ω–æ –ø–æ–≤–µ—Ä—Ç–∞—î –Ω–µ –¥–æ –≤–æ–¥—É –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∞ –¥–æ –≤–≤–æ–¥—É –∫–æ–¥—É, –ø–æ –¥—Ä—É–≥–µ –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –æ—Ç—Ä–∏–º–∞—Ç–∏ —á–∞—Ç–∏ –ø—ñ—Å–ª—è –≤–≤–æ–¥—É –∫–æ–¥—É –∑ —Ç–µ–ª–µ–≥—Ä–∞–º - —Ü–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ–µ–Ω—Ç–∞ G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:121

           GET http://localhost:8000/chats 500 (Internal Server Error)

fetchChats @ G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:121
Dashboard.useEffect @ G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:140
react-stack-bottom-frame @ react-dom-client.development.js:22510
runWithFiberInDEV @ react-dom-client.development.js:544
commitHookEffectListMount @ react-dom-client.development.js:10759
commitHookPassiveMountEffects @ react-dom-client.development.js:10879
commitPassiveMountOnFiber @ react-dom-client.development.js:12654
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12658
flushPassiveEffects @ react-dom-client.development.js:15461
eval @ react-dom-client.development.js:15325
performWorkUntilDeadline @ scheduler.development.js:44Understand this errorAI
G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:121

           GET http://localhost:8000/chats 500 (Internal Server Error)

fetchChats @ G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:121
Dashboard.useEffect @ G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:140
react-stack-bottom-frame @ react-dom-client.development.js:22510
runWithFiberInDEV @ react-dom-client.development.js:544
commitHookEffectListMount @ react-dom-client.development.js:10759
commitHookPassiveMountEffects @ react-dom-client.development.js:10879
commitPassiveMountOnFiber @ react-dom-client.development.js:12654
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12756
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12647
recursivelyTraversePassiveMountEffects @ react-dom-client.development.js:12628
commitPassiveMountOnFiber @ react-dom-client.development.js:12658
flushPassiveEffects @ react-dom-client.development.js:15461
eval @ react-dom-client.development.js:15325
performWorkUntilDeadline @ scheduler.development.js:44Understand this errorAI
:3000/dashboard:1 Access to fetch at 'http://localhost:8000/connect-telegram' from origin 'http://localhost:3000' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.Understand this errorAI
G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:91

           POST http://localhost:8000/connect-telegram net::ERR_FAILED 500 (Internal Server Error) –∞ —Ü–µ —Å–µ—Ä–≤–∞–∫–∞ INFO:     127.0.0.1:51883 - "GET /chats HTTP/1.1" 500 Internal Server Error

–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: OPTIONS http://localhost:8000/send-code
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
INFO: 127.0.0.1:51916 - "OPTIONS /send-code HTTP/1.1" 200 OK
–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: POST http://localhost:8000/send-code
2025-02-28 11:58:22,650 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-02-28 11:58:22,650 INFO sqlalchemy.engine.Engine SELECT users.id, users.username, users.password_hash, users.telegram_phone
FROM users
WHERE users.username = ?
2025-02-28 11:58:22,653 INFO sqlalchemy.engine.Engine [cached since 123.5s ago] ('test123',)
2025-02-28 11:58:23,095 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
INFO: 127.0.0.1:51916 - "POST /send-code HTTP/1.1" 200 OK
–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: OPTIONS http://localhost:8000/connect-telegram
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
INFO: 127.0.0.1:51919 - "OPTIONS /connect-telegram HTTP/1.1" 200 OK
–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: POST http://localhost:8000/connect-telegram
2025-02-28 11:58:39,454 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-02-28 11:58:39,455 INFO sqlalchemy.engine.Engine SELECT users.id, users.username, users.password_hash, users.telegram_phone
FROM users
WHERE users.username = ?
2025-02-28 11:58:39,456 INFO sqlalchemy.engine.Engine [cached since 140.3s ago] ('test123',)
2025-02-28 11:58:43,403 INFO sqlalchemy.engine.Engine ROLLBACK
INFO: 127.0.0.1:51919 - "POST /connect-telegram HTTP/1.1" 500 Internal Server Error
ERROR: Exception in ASGI application

-   Exception Group Traceback (most recent call last):
    | File "C:\Python311\Lib\site-packages\starlette_utils.py", line 76, in collapse_excgroups
    | yield
    | File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 178, in **call**
    | async with anyio.create_task_group() as task_group:
    | File "C:\Python311\Lib\site-packages\anyio_backends_asyncio.py", line 767, in **aexit**
    | raise BaseExceptionGroup(
    | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
    +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    | File "C:\Python311\Lib\site-packages\uvicorn\protocols\http\h11_impl.py", line 403, in run_asgi
    | result = await app( # type: ignore[func-returns-value]
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | File "C:\Python311\Lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in **call**
    | return await self.app(scope, receive, send)
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | File "C:\Python311\Lib\site-packages\fastapi\applications.py", line 1054, in **call**
    | await super().**call**(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette\applications.py", line 112, in **call**
    | await self.middleware_stack(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette\middleware\errors.py", line 187, in **call**
    | raise exc
    | File "C:\Python311\Lib\site-packages\starlette\middleware\errors.py", line 165, in **call**
    | await self.app(scope, receive, \_send)
    | File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 177, in **call**
    | with recv_stream, send_stream, collapse_excgroups():
    | File "C:\Python311\Lib\contextlib.py", line 155, in **exit**
    | self.gen.throw(typ, value, traceback)
    | File "C:\Python311\Lib\site-packages\starlette_utils.py", line 82, in collapse_excgroups
    | raise exc
    | File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 179, in **call**
    | response = await self.dispatch_func(request, call_next)
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | File "G:\Projects\NextJS\SocialHub\server\main.py", line 92, in log_requests
    | response = await call_next(request)
    | ^^^^^^^^^^^^^^^^^^^^^^^^
    | File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    | raise app_exc
    | File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    | await self.app(scope, receive_or_disconnect, send_no_error)
    | File "C:\Python311\Lib\site-packages\starlette\middleware\cors.py", line 93, in **call**
    | await self.simple_response(scope, receive, send, request_headers=headers)
    | File "C:\Python311\Lib\site-packages\starlette\middleware\cors.py", line 144, in simple_response
    | await self.app(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in **call**
    | await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 53, in wrapped_app
    | raise exc
    | File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 42, in wrapped_app
    | await app(scope, receive, sender)
    | File "C:\Python311\Lib\site-packages\starlette\routing.py", line 715, in **call**
    | await self.middleware_stack(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette\routing.py", line 735, in app
    | await route.handle(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette\routing.py", line 288, in handle
    | await self.app(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette\routing.py", line 76, in app
    | await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    | File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 53, in wrapped_app
    | raise exc
    | File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 42, in wrapped_app
    | await app(scope, receive, sender)
    | File "C:\Python311\Lib\site-packages\starlette\routing.py", line 73, in app
    | response = await f(request)
    | ^^^^^^^^^^^^^^^^
    | File "C:\Python311\Lib\site-packages\fastapi\routing.py", line 301, in app
    | raw_response = await run_endpoint_function(
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | File "C:\Python311\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    | return await dependant.call(\*\*values)
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | File "G:\Projects\NextJS\SocialHub\server\main.py", line 195, in connect_telegram
    | except SessionPasswordNeededError:
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^
    | NameError: name 'SessionPasswordNeededError' is not defined
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
File "C:\Python311\Lib\site-packages\uvicorn\protocols\http\h11_impl.py", line 403, in run_asgi
result = await app( # type: ignore[func-returns-value]
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "C:\Python311\Lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in **call**
return await self.app(scope, receive, send)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "C:\Python311\Lib\site-packages\fastapi\applications.py", line 1054, in **call**
await super().**call**(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette\applications.py", line 112, in **call**
await self.middleware_stack(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette\middleware\errors.py", line 187, in **call**
raise exc
File "C:\Python311\Lib\site-packages\starlette\middleware\errors.py", line 165, in **call**
await self.app(scope, receive, \_send)
File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 177, in **call**
with recv_stream, send_stream, collapse_excgroups():
File "C:\Python311\Lib\contextlib.py", line 155, in **exit**
self.gen.throw(typ, value, traceback)
File "C:\Python311\Lib\site-packages\starlette_utils.py", line 82, in collapse_excgroups
raise exc
File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 179, in **call**
response = await self.dispatch_func(request, call_next)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "G:\Projects\NextJS\SocialHub\server\main.py", line 92, in log_requests
response = await call_next(request)
^^^^^^^^^^^^^^^^^^^^^^^^
File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
raise app_exc
File "C:\Python311\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
await self.app(scope, receive_or_disconnect, send_no_error)
File "C:\Python311\Lib\site-packages\starlette\middleware\cors.py", line 93, in **call**
await self.simple_response(scope, receive, send, request_headers=headers)
File "C:\Python311\Lib\site-packages\starlette\middleware\cors.py", line 144, in simple_response
await self.app(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in **call**
await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 53, in wrapped_app
raise exc
File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 42, in wrapped_app
await app(scope, receive, sender)
File "C:\Python311\Lib\site-packages\starlette\routing.py", line 715, in **call**
await self.middleware_stack(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette\routing.py", line 735, in app
await route.handle(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette\routing.py", line 288, in handle
await self.app(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette\routing.py", line 76, in app
await wrap_app_handling_exceptions(app, request)(scope, receive, send)
File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 53, in wrapped_app
raise exc
File "C:\Python311\Lib\site-packages\starlette_exception_handler.py", line 42, in wrapped_app
await app(scope, receive, sender)
File "C:\Python311\Lib\site-packages\starlette\routing.py", line 73, in app
response = await f(request)
^^^^^^^^^^^^^^^^
File "C:\Python311\Lib\site-packages\fastapi\routing.py", line 301, in app
raw_response = await run_endpoint_function(
^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "C:\Python311\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
return await dependant.call(\*\*values)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "G:\Projects\NextJS\SocialHub\server\main.py", line 195, in connect_telegram
except SessionPasswordNeededError:
^^^^^^^^^^^^^^^^^^^^^^^^^^
NameError: name 'SessionPasswordNeededError' is not defined

–Ø –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞–≤ –≤–∞—à –∫–æ–¥ —ñ –ø–æ–º–∏–ª–∫–∏. –î–∞–≤–∞–π—Ç–µ —Ä–æ–∑–±–µ—Ä–µ–º–æ –ø—Ä–æ–±–ª–µ–º–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É —ñ –∑–∞–ø—Ä–æ–ø–æ–Ω—É—î–º–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è.

1. –ü—Ä–æ–±–ª–µ–º–∞ –∑ –≤–∏—Ö–æ–¥–æ–º –∑ Telegram
   –í–∏ –∑–∞–∑–Ω–∞—á–∏–ª–∏, —â–æ –≤–∏—Ö—ñ–¥ –∑ Telegram –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É, –∞ –Ω–µ –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É. –¶–µ –ø–æ–≤‚Äô—è–∑–∞–Ω–æ –∑ –ª–æ–≥—ñ–∫–æ—é –≤ Dashboard.js, –¥–µ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ "–ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç" –≤–∏ –ø—Ä–æ—Å—Ç–æ —Å–∫–∏–¥–∞—î—Ç–µ isConnected –≤ false, –∞–ª–µ –Ω–µ —Å–∫–∏–¥–∞—î—Ç–µ isCodeSent. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É –∑–∞–º—ñ—Å—Ç—å —Ñ–æ—Ä–º–∏ –≤–≤–µ–¥–µ–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É.

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–£ —Ñ—É–Ω–∫—Ü—ñ—ó Dashboard.js –¥–æ–¥–∞–π—Ç–µ —Å–∫–∏–¥–∞–Ω–Ω—è isCodeSent —Ä–∞–∑–æ–º —ñ–∑ isConnected:

javascript
Wrap
Copy
const handleLogoutTelegram = async () => {
try {
const token = localStorage.getItem("token");
const res = await fetch("http://localhost:8000/logout-telegram", {
method: "POST",
headers: { Authorization: `Bearer ${token}` },
});
if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
setIsConnected(false);
setIsCodeSent(false); // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
setPhone(""); // –û—á–∏—â–∞—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É
setCode(""); // –û—á–∏—â–∞—î–º–æ –∫–æ–¥
} catch (err) {
setError(err.message);
}
};

// –û–Ω–æ–≤—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç":
<button
onClick={handleLogoutTelegram}
className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"

>

    –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç

</button>
–ù–∞ —Å–µ—Ä–≤–µ—Ä—ñ (/logout-telegram) –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Å–µ—Å—ñ—è Telegram –¥—ñ–π—Å–Ω–æ –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ. –ü–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∏–≥–ª—è–¥–∞—î –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∞–ª–µ –¥–æ–¥–∞–π—Ç–µ –æ—á–∏—â–µ–Ω–Ω—è —Ñ–∞–π–ª—É —Å–µ—Å—ñ—ó:

python
Wrap
Copy
@app.post("/logout-telegram")
async def logout*telegram(
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
if current_user.telegram_phone and os.path.exists(f"sessions/session*{current*user.id}"):
os.remove(f"sessions/session*{current_user.id}") # –í–∏–¥–∞–ª—è—î–º–æ —Ñ–∞–π–ª —Å–µ—Å—ñ—ó
current_user.telegram_phone = None
await db.commit()
return {"message": "Telegram disconnected"} 2. –ü–æ–º–∏–ª–∫–∞ 500 –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —á–∞—Ç—ñ–≤ (GET /chats)
–ü–æ–º–∏–ª–∫–∞ 500 Internal Server Error –≤–∏–Ω–∏–∫–∞—î —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É –≤ –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ /connect-telegram. –£ –≤–∞—à–æ–º—É –∫–æ–¥—ñ —î –ø–æ–º–∏–ª–∫–∞ –∑ —ñ–º–ø–æ—Ä—Ç–æ–º SessionPasswordNeededError. –í–∏ —ñ–º–ø–æ—Ä—Ç—É—î—Ç–µ –π–æ–≥–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á–µ—Ä–µ–∑ —â–æ –≤–∏–Ω–∏–∫–∞—î NameError.

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–£ –≤–µ—Ä—Ö–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ —Ñ–∞–π–ª—É –¥–æ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —ñ–º–ø–æ—Ä—Ç —ñ–∑ telethon.errors:

python
Wrap
Copy
from telethon.errors import SessionPasswordNeededError, FloodWaitError, SessionExpiredError
–¢–µ–ø–µ—Ä –≤–∞—à –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ —É /connect-telegram –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –û–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–¥:

python
Wrap
Copy
@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
try:
session_data = temp_sessions.get(current_user.id)
if not session_data or "client" not in session_data:
raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        await client.sign_in(phone=session_data["phone"], code=auth.code, phone_code_hash=session_data["phone_code_hash"])

        current_user.telegram_phone = session_data["phone"]
        await db.commit()
        await client.disconnect()
        del temp_sessions[current_user.id]

        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

3. –ü—Ä–æ–±–ª–µ–º–∞ –∑ CORS
   –í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø–æ–º–∏–ª–∫—É CORS: No 'Access-Control-Allow-Origin' header is present. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤‚Äô—è–∑–∞–Ω–æ –∑ —Ç–∏–º, —â–æ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ CORS –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ OPTIONS –∞–±–æ —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é.

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∞—à CORS Middleware –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –£ –≤–∞—à–æ–º—É –∫–æ–¥—ñ –≤—ñ–Ω –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫:

python
Wrap
Copy
app.add_middleware(
CORSMiddleware,
allow_origins=["http://localhost:3000"],
allow_credentials=True,
allow_methods=["*"],
allow_headers=["*"],
)
–¶–µ –≤–∏–≥–ª—è–¥–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∞–ª–µ —è–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è, —Å–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–¥–∞—Ç–∏ —è–≤–Ω—É –æ–±—Ä–æ–±–∫—É –∑–∞–ø–∏—Ç—ñ–≤ OPTIONS —É FastAPI:

python
Wrap
Copy
from fastapi.responses import Response

@app.options("/{path:path}")
async def options_handler():
return Response(status_code=200, headers={
"Access-Control-Allow-Origin": "http://localhost:3000",
"Access-Control-Allow-Methods": "GET, POST, OPTIONS",
"Access-Control-Allow-Headers": "\*",
"Access-Control-Allow-Credentials": "true"
}) 4. –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —á–∞—Ç—ñ–≤ –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
–ü—ñ—Å–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É –≤–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ –ø–æ–º–∏–ª–∫—É 500 –Ω–∞ /chats. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤‚Äô—è–∑–∞–Ω–æ –∑ —Ç–∏–º, —â–æ —Å–µ—Å—ñ—è Telegram –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ –∞–±–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ.

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–û–Ω–æ–≤—ñ—Ç—å –µ–Ω–¥–ø–æ—ñ–Ω—Ç /chats, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –∫–ª—ñ—î–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è:

python
Wrap
Copy
@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
if not current_user.telegram_phone:
raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f'sessions/session_{current_user.id}', API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

–ù–∞ –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ–π —Å—Ç–æ—Ä–æ–Ω—ñ (Dashboard.js) –¥–æ–¥–∞–π—Ç–µ –∑–∞—Ç—Ä–∏–º–∫—É –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º fetchChats, —â–æ–± –¥–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä—É —á–∞—Å –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:

javascript
Wrap
Copy
const connectTelegram = async (e) => {
e.preventDefault();
setError("");

    try {
        const token = localStorage.getItem("token");
        if (!token) return router.push("/login");

        const body = { code: code.trim() };
        if (twoFactorPassword) body.password = twoFactorPassword;

        const res = await fetch("http://localhost:8000/connect-telegram", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
        });

        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
        }

        setIsConnected(true);
        await new Promise(resolve => setTimeout(resolve, 500)); // –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É
        await fetchChats();
    } catch (err) {
        setError(err.message);
    }

};
–ó–∞–≥–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:
–õ–æ–≥—É–≤–∞–Ω–Ω—è: –î–æ–¥–∞–π—Ç–µ –±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –¥–ª—è –¥–µ–±–∞–≥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, print –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–æ—é –æ–ø–µ—Ä–∞—Ü—ñ—î—é –∑ Telegram).
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Å—ñ–π: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª–∏ —Å–µ—Å—ñ–π (sessions/session\_{user_id}) —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è —ñ –¥–æ—Å—Ç—É–ø–Ω—ñ.
–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–∂–µ–Ω –µ–Ω–¥–ø–æ—ñ–Ω—Ç –æ–∫—Ä–µ–º–æ —á–µ—Ä–µ–∑ Postman –∞–±–æ cURL, —â–æ–± —ñ–∑–æ–ª—é–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É.
–°–ø—Ä–æ–±—É–π—Ç–µ —Ü—ñ –∑–º—ñ–Ω–∏ —ñ –¥–∞–π—Ç–µ –∑–Ω–∞—Ç–∏, —è–∫—â–æ —â–æ—Å—å —â–µ –Ω–µ –ø—Ä–∞—Ü—é—î!

{"detail":"Method Not Allowed"} Access to fetch at 'http://localhost:8000/connect-telegram' from origin 'http://localhost:3000' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.Understand this errorAI
G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:91

           POST http://localhost:8000/connect-telegram net::ERR_FAILED 500 (Internal Server Error)

connectTelegram @ G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:91
processDispatchQueue @ react-dom-client.development.js:16123
eval @ react-dom-client.development.js:16726
batchedUpdates$1 @ react-dom-client.development.js:3130
dispatchEventForPluginEventSystem @ react-dom-client.development.js:16282
dispatchEvent @ react-dom-client.development.js:20354
dispatchDiscreteEvent @ react-dom-client.development.js:20322Understand this errorAI
dashboard:1 Access to fetch at 'http://localhost:8000/connect-telegram' from origin 'http://localhost:3000' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.Understand this errorAI
G:\Projects\NextJS\SocialHub\client\pages\dashboard.js:91

           POST http://localhost:8000/connect-telegram  —è–∫–æ—Å—å —Å–ø—Ä–∞—Ü—å–æ–≤—É—î —á–µ—Ä–µ–∑ —Ä–∞–∑, —ñ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —â–æ –Ω–æ–≤–∏–π –≤—Ö—ñ–¥ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–ª–µ —á–∞—Ç–∏ –Ω–µ —Ñ–µ—á–∞—Ç—å—Å—è

–í–∞—à—ñ –ø–æ–º–∏–ª–∫–∏ –≤–∫–∞–∑—É—é—Ç—å –Ω–∞ –∫—ñ–ª—å–∫–∞ –ø—Ä–æ–±–ª–µ–º: CORS, –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –µ–Ω–¥–ø–æ—ñ–Ω—Ç—É /connect-telegram, –∞ —Ç–∞–∫–æ–∂ —Ç–µ, —â–æ —á–∞—Ç–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram. –î–∞–≤–∞–π—Ç–µ —Ä–æ–∑–±–µ—Ä–µ–º–æ —ó—Ö –ø–æ —á–µ—Ä–∑—ñ —ñ –∑–Ω–∞–π–¥–µ–º–æ —Ä—ñ—à–µ–Ω–Ω—è.

1. –ü–æ–º–∏–ª–∫–∞ CORS: "No 'Access-Control-Allow-Origin' header is present"
   –¶—è –ø–æ–º–∏–ª–∫–∞ –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Access-Control-Allow-Origin, —Ö–æ—á–∞ —É –≤–∞—à–æ–º—É –∫–æ–¥—ñ FastAPI —î CORS Middleware. –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ –≤–∏–Ω–∏–∫–∞—Ç–∏ —á–µ—Ä–µ–∑ —Ç–µ, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ–º–∏–ª–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 500 Internal Server Error –∞–±–æ 405 Method Not Allowed), –∞ –≤ —Ç–∞–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö CORS-–∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–∂—É—Ç—å –Ω–µ –¥–æ–¥–∞–≤–∞—Ç–∏—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ CORS Middleware –ø—Ä–∞—Ü—é—î –¥–ª—è –≤—Å—ñ—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π, –≤–∫–ª—é—á–∞—é—á–∏ –ø–æ–º–∏–ª–∫–∏. –í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ–¥:
python
Wrap
Copy
app.add_middleware(
CORSMiddleware,
allow_origins=["http://localhost:3000"],
allow_credentials=True,
allow_methods=["*"],
allow_headers=["*"],
)
–í–∏–≥–ª—è–¥–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∞–ª–µ –¥–æ–¥–∞–π—Ç–µ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ —É FastAPI, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ CORS-–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–≤–∂–¥–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ:

python
Wrap
Copy
from fastapi import Request
from fastapi.responses import JSONResponse

@app.exception*handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
return JSONResponse(
status_code=500,
content={"detail": str(exc)},
headers={
"Access-Control-Allow-Origin": "http://localhost:3000",
"Access-Control-Allow-Credentials": "true",
"Access-Control-Allow-Methods": "GET, POST, OPTIONS",
"Access-Control-Allow-Headers": "*",
}
)
–Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è, –¥–æ–¥–∞–π—Ç–µ —è–≤–Ω—É –ø—ñ–¥—Ç—Ä–∏–º–∫—É OPTIONS –∑–∞–ø–∏—Ç—ñ–≤ (–æ—Å–∫—ñ–ª—å–∫–∏ –±—Ä–∞—É–∑–µ—Ä —Ä–æ–±–∏—Ç—å –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∑–∞–ø–∏—Ç –ø–µ—Ä–µ–¥ POST):
python
Wrap
Copy
@app.options("/{path:path}")
async def options*handler():
return Response(
status_code=200,
headers={
"Access-Control-Allow-Origin": "http://localhost:3000",
"Access-Control-Allow-Methods": "GET, POST, OPTIONS",
"Access-Control-Allow-Headers": "*",
"Access-Control-Allow-Credentials": "true",
}
) 2. –ü–æ–º–∏–ª–∫–∞ "Method Not Allowed"
–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è {"detail":"Method Not Allowed"} –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ —Å—Ç–∞—Ç—É—Å 405. –¶–µ –º–æ–∂–µ —Å—Ç–∞—Ç–∏—Å—è, —è–∫—â–æ:

–ï–Ω–¥–ø–æ—ñ–Ω—Ç /connect-telegram –Ω–µ –æ–±—Ä–æ–±–ª—è—î POST-–∑–∞–ø–∏—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ.
–Ñ –ø–æ–º–∏–ª–∫–∞ –≤ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó FastAPI.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:
–í–∞—à –µ–Ω–¥–ø–æ—ñ–Ω—Ç /connect-telegram –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ POST:

python
Wrap
Copy
@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
): # ... –ª–æ–≥—ñ–∫–∞ ...
–¶–µ –≤–∏–≥–ª—è–¥–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–æ–º–∏–ª–∫–∞ "Method Not Allowed" –º–æ–∂–µ –≤–∏–Ω–∏–∫–∞—Ç–∏ —á–µ—Ä–µ–∑:

–ü–µ—Ä–µ–∫—Ä–∏—Ç—Ç—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ —î @app.get("/connect-telegram") –¥–µ—ñ–Ω–¥–µ).
–ü—Ä–æ–±–ª–µ–º–∏ –∑ middleware –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –æ–±—Ä–æ–±–∫–æ—é –∑–∞–ø–∏—Ç—ñ–≤.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –Ω–µ–º–∞—î —ñ–Ω—à–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤ —ñ–∑ —Ç–∞–∫–∏–º –∂–µ —à–ª—è—Ö–æ–º (/connect-telegram) –¥–ª—è —ñ–Ω—à–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ (GET, PUT —Ç–æ—â–æ).
–î–æ–¥–∞–π—Ç–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ –µ–Ω–¥–ø–æ—ñ–Ω—Ç –¥–ª—è –¥–µ–±–∞–≥—É:
python
Wrap
Copy
@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
print(f"–û—Ç—Ä–∏–º–∞–Ω–æ POST-–∑–∞–ø–∏—Ç –¥–æ /connect-telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
try: # ... —ñ—Å–Ω—É—é—á–∞ –ª–æ–≥—ñ–∫–∞ ...
except Exception as e:
print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
raise 3. –ù–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ /connect-telegram ("–ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ —Ä–∞–∑")
–í–∏ –∑–∞–∑–Ω–∞—á–∏–ª–∏, —â–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –Ω–µ –∑–∞–≤–∂–¥–∏, –∞–ª–µ –≤–∏ –±–∞—á–∏—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π –≤—Ö—ñ–¥ —É Telegram. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤‚Äô—è–∑–∞–Ω–æ –∑:

–ü—Ä–æ–±–ª–µ–º–∞–º–∏ —ñ–∑ —Å–µ—Å—ñ—î—é Telegram (—Ñ–∞–π–ª —Å–µ—Å—ñ—ó –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ).
–ü–æ–º–∏–ª–∫–æ—é –≤ –ª–æ–≥—ñ—Ü—ñ temp_sessions.
–ê–Ω–∞–ª—ñ–∑:
–£ –≤–∞—à–æ–º—É –∫–æ–¥—ñ —î –¥–≤–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è TelegramClient —É /connect-telegram:

python
Wrap
Copy
client = session_data["client"]
await client.connect()
await client.sign_in(...)

client = TelegramClient(f"sessions/session\_{current_user.id}", API_ID, API_HASH)
await client.connect()
await client.sign_in(...)
–¶–µ –º–æ–∂–µ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç–∏ –¥–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤. –ö—Ä–∞—â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –æ–¥–∏–Ω –∫–ª—ñ—î–Ω—Ç —ñ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å–µ—Å—ñ—é –∫–æ—Ä–µ–∫—Ç–Ω–æ.

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–û–Ω–æ–≤—ñ—Ç—å –µ–Ω–¥–ø–æ—ñ–Ω—Ç —Ç–∞–∫, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞:

python
Wrap
Copy
@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
try:
session_data = temp_sessions.get(current_user.id)
if not session_data or "client" not in session_data:
raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é –Ω–∞ –¥–∏—Å–∫
        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await db.commit()
        del temp_sessions[current_user.id]

        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

4. –ß–∞—Ç–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
   –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–∞—Ç–∏ –Ω–µ —Ñ–µ—Ç—á–∞—Ç—å—Å—è —á–µ—Ä–µ–∑:

–ü–æ–º–∏–ª–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (500 Internal Server Error).
–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω—É –ª–æ–≥—ñ–∫—É –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ, —è–∫–∞ –Ω–µ —á–µ–∫–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
–°–µ—Ä–≤–µ—Ä:
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –µ–Ω–¥–ø–æ—ñ–Ω—Ç /chats –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ:

python
Wrap
Copy
@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
if not current_user.telegram_phone:
raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(400, "–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        dialogs = await client.get_dialogs()
        await client.disconnect()
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(500, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

–ö–ª—ñ—î–Ω—Ç:
–£ Dashboard.js –¥–æ–¥–∞–π—Ç–µ –∑–∞—Ç—Ä–∏–º–∫—É —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º fetchChats:

javascript
Wrap
Copy
const connectTelegram = async (e) => {
e.preventDefault();
setError("");

    try {
        const token = localStorage.getItem("token");
        if (!token) return router.push("/login");

        const body = { code: code.trim() };
        if (twoFactorPassword) body.password = twoFactorPassword;

        const res = await fetch("http://localhost:8000/connect-telegram", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
        });

        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
        }

        setIsConnected(true);
        await new Promise(resolve => setTimeout(resolve, 1000)); // –ó–∞—Ç—Ä–∏–º–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞
        await fetchChats();
    } catch (err) {
        setError(err.message);
    }

};

const fetchChats = async () => {
try {
const token = localStorage.getItem("token");
const res = await fetch("http://localhost:8000/chats", {
headers: { Authorization: `Bearer ${token}` },
});
if (!res.ok) {
const data = await res.json();
throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
}
const data = await res.json();
setChats(data);
} catch (err) {
setError(err.message);
}
};
–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:
–õ–æ–≥–∏: –î–æ–¥–∞–π—Ç–µ –±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ —Ç–∞ –∫–ª—ñ—î–Ω—Ç—ñ –¥–ª—è –¥–µ–±–∞–≥—É:
–ù–∞ —Å–µ—Ä–≤–µ—Ä—ñ: print –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–æ—é –æ–ø–µ—Ä–∞—Ü—ñ—î—é –∑ Telegram.
–ù–∞ –∫–ª—ñ—î–Ω—Ç—ñ: console.log —É –∫–æ–∂–Ω–æ–º—É try/catch.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ API_ID/API_HASH: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∞—à—ñ API_ID —ñ API_HASH —É .env –ø—Ä–∞–≤–∏–ª—å–Ω—ñ.
–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Postman –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ /connect-telegram —ñ /chats –æ–∫—Ä–µ–º–æ.
–°–ø—Ä–æ–±—É–π—Ç–µ —Ü—ñ –∑–º—ñ–Ω–∏ —ñ –ø–æ–≤—ñ–¥–æ–º—Ç–µ, —á–∏ –≤–∏—Ä—ñ—à–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º—É! –Ø–∫—â–æ —â–æ—Å—å –Ω–µ –ø—Ä–∞—Ü—é—î, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–æ–≤—ñ –ª–æ–≥–∏ –∞–±–æ –ø–æ–º–∏–ª–∫–∏.

–∞ –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤–Ω—ñ—á—Ç—é –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π main.py?

–û—Å—å –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ñ–∞–π–ª main.py —ñ–∑ –≤—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —É—Å—ñ—Ö –∑–∞—É–≤–∞–∂–µ–Ω—å —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å, —è–∫—ñ –º–∏ –æ–±–≥–æ–≤–æ—Ä–∏–ª–∏. –Ø –¥–æ–¥–∞–≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏, –æ–±—Ä–æ–±–∫—É CORS, —Å—Ç–∞–±—ñ–ª—å–Ω—É –ª–æ–≥—ñ–∫—É –¥–ª—è Telegram-—Å–µ—Å—ñ–π —ñ —á—ñ—Ç–∫–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É:

python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine # –ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ü—ñ –º–æ–¥—É–ª—ñ —É –≤–∞—Å —î
from models import Base, User # –ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ü—ñ –º–æ–¥—É–ª—ñ —É –≤–∞—Å —î
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è

load_dotenv()

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É

app = FastAPI()

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS

app.add_middleware(
CORSMiddleware,
allow_origins=["http://localhost:3000"],
allow_credentials=True,
allow_methods=["*"],
allow_headers=["*"],
)

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è JWT

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Telegram

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

# –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# –°—Ö–µ–º–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")

# –¢–∏–º—á–∞—Å–æ–≤–µ —Å—Ö–æ–≤–∏—â–µ –¥–ª—è —Å–µ—Å—ñ–π

temp_sessions = {}

# –ú–æ–¥–µ–ª—ñ –∑–∞–ø–∏—Ç—ñ–≤

class UserCreate(BaseModel):
username: str
password: str

class UserLogin(BaseModel):
username: str
password: str

class TelegramSendCode(BaseModel):
phone: str

class TelegramConnect(BaseModel):
code: str
password: Optional[str] = None
phone: Optional[str] = None

class TelegramSession(BaseModel):
phone: str
phone_code_hash: str
client: Optional[types.User] = None

    model_config = ConfigDict(arbitrary_types_allowed=True)

# –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

async def get_db():
async with AsyncSessionLocal() as session:
yield session

# –õ–æ–≥—É–≤–∞–Ω–Ω—è middleware

@app.middleware("http")
async def log_requests(request: Request, call_next):
print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
response = await call_next(request)
print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
return response

# –û–±—Ä–æ–±–∫–∞ –≤–∏–Ω—è—Ç–∫—ñ–≤ –¥–ª—è CORS

@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
return JSONResponse(
status_code=500,
content={"detail": str(exc)},
headers={
"Access-Control-Allow-Origin": "http://localhost:3000",
"Access-Control-Allow-Credentials": "true",
"Access-Control-Allow-Methods": "GET, POST, OPTIONS",
"Access-Control-Allow-Headers": "\*",
}
)

# –û–±—Ä–æ–±–∫–∞ OPTIONS-–∑–∞–ø–∏—Ç—ñ–≤

@app.options("/{path:path}")
async def options_handler():
return Response(
status_code=200,
headers={
"Access-Control-Allow-Origin": "http://localhost:3000",
"Access-Control-Allow-Methods": "GET, POST, OPTIONS",
"Access-Control-Allow-Headers": "\*",
"Access-Control-Allow-Credentials": "true",
}
)

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ

@app.on_event("startup")
async def startup():
async with engine.begin() as conn:
await conn.run_sync(Base.metadata.create_all)

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω–∞

def create_access_token(data: dict):
to_encode = data.copy()
expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
to_encode.update({"exp": expire})
return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

async def get_current_user(
token: str = Depends(oauth2_scheme),
db: AsyncSession = Depends(get_db)
):
try:
payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
username = payload.get("sub")
if not username:
raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        return user
    except JWTError:
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

# –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
result = await db.execute(select(User).filter(User.username == user.username))
if result.scalar():
raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await db.commit()
    return {"message": "User created successfully"}

# –õ–æ–≥—ñ–Ω

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
result = await db.execute(select(User).filter(User.username == user.username))
db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
return {"connected": bool(current_user.telegram_phone)}

# –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è Telegram

@app.post("/send-code")
async def send_code(
data: TelegramSendCode,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
try:
if current_user.id in temp_sessions:
await temp_sessions[current_user.id]["client"].disconnect()
del temp_sessions[current_user.id]

        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: {str(e)}")
        raise HTTPException(400, detail=str(e))

# –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram

@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
try:
session_data = temp_sessions.get(current_user.id)
if not session_data or "client" not in session_data:
raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é
        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
if not current_user.telegram_phone:
raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —á–∞—Ç—É

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
chat_id: int,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
if not current_user.telegram_phone:
raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

# –í–∏—Ö—ñ–¥ –∑ Telegram

@app.post("/logout-telegram")
async def logout*telegram(
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
if current_user.telegram_phone and os.path.exists(f"sessions/session*{current*user.id}"):
os.remove(f"sessions/session*{current_user.id}")
current_user.telegram_phone = None
await db.commit()
print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
return {"message": "Telegram disconnected"}

# –í–∏—Ö—ñ–¥ –∑ —Å–∏—Å—Ç–µ–º–∏

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
return {"message": "Logged out from system"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è

@app.get("/health")
async def health_check():
return {"status": "OK"}
–û—Å–Ω–æ–≤–Ω—ñ –∑–º—ñ–Ω–∏:
CORS:
–î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–Ω–∏–∫ –≤–∏–Ω—è—Ç–∫—ñ–≤ –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è CORS-–∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—è—Ö —ñ–∑ –ø–æ–º–∏–ª–∫–∞–º–∏.
–î–æ–¥–∞–Ω–æ —è–≤–Ω—É –æ–±—Ä–æ–±–∫—É OPTIONS-–∑–∞–ø–∏—Ç—ñ–≤.
Telegram-—Å–µ—Å—ñ—ó:
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–æ–≥—ñ–∫—É –≤ /connect-telegram, –ø—Ä–∏–±—Ä–∞–≤—à–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è TelegramClient.
–ü–µ—Ä–µ–∫–æ–Ω–∞–Ω–æ, —â–æ —Å–µ—Å—ñ—è –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø—ñ—Å–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó.
–õ–æ–≥—É–≤–∞–Ω–Ω—è:
–î–æ–¥–∞–Ω–æ print –¥–ª—è –¥–µ–±–∞–≥—É –≤ –∫–ª—é—á–æ–≤–∏—Ö –º—ñ—Å—Ü—è—Ö.
–û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫:
–£—Å—ñ except-–±–ª–æ–∫–∏ –¥–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º —ñ –∫–æ—Ä–µ–∫—Ç–Ω–∏–º–∏ HTTP-–≤—ñ–¥–ø–æ–≤—ñ–¥—è–º–∏.
–í–∏—Ö—ñ–¥ —ñ–∑ Telegram:
–î–æ–¥–∞–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—É —Å–µ—Å—ñ—ó –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É /logout-telegram.
–ü–µ—Ä–µ–¥—É–º–æ–≤–∏:
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å —î —Ñ–∞–π–ª–∏ database.py —ñ models.py —ñ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ AsyncSessionLocal, engine —ñ –º–æ–¥–µ–ª—ñ User.
–£ .env –º–∞—é—Ç—å –±—É—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è API_ID, API_HASH, —ñ JWT_SECRET.
–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:
–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä: uvicorn main:app --reload.
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–∂–µ–Ω –µ–Ω–¥–ø–æ—ñ–Ω—Ç —á–µ—Ä–µ–∑ Postman –∞–±–æ –∫–ª—ñ—î–Ω—Ç:
POST /register
POST /login
POST /send-code
POST /connect-telegram
GET /chats
POST /logout-telegram
–Ø–∫—â–æ —â–æ—Å—å –Ω–µ –ø—Ä–∞—Ü—é—î, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–æ–≤—ñ –ª–æ–≥–∏ –∞–±–æ –ø–æ–º–∏–ª–∫–∏, —ñ —è –¥–æ–ø–æ–º–æ–∂—É!

—á–æ–º—É –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–∞—à–±–æ—Ä–¥—É –æ—Ç—Ä–∏–º–∞–ª–∞ —Ü–µ GET http://localhost:8000/check-connection 401 (Unauthorized)

–ü–æ–º–∏–ª–∫–∞ GET http://localhost:8000/check-connection 401 (Unauthorized) –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–∞—à–±–æ—Ä–¥—É –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î —Å—Ç–∞—Ç—É—Å 401, —Ç–æ–±—Ç–æ –∑–∞–ø–∏—Ç –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π. –¶–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ç–µ, —â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –º–æ–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–æ–∫–µ–Ω JWT, —è–∫–∏–π –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫—É Authorization. –î–∞–≤–∞–π—Ç–µ —Ä–æ–∑–±–µ—Ä–µ–º–æ –ø—Ä–∏—á–∏–Ω–∏ —ñ –∑–Ω–∞–π–¥–µ–º–æ —Ä—ñ—à–µ–Ω–Ω—è.

–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:
–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è:
–£ Dashboard.js –≤–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ —Ç–æ–∫–µ–Ω —ñ–∑ localStorage —ñ –ø–µ—Ä–µ–¥–∞—î—Ç–µ –π–æ–≥–æ –≤ –∑–∞–ø–∏—Ç –¥–æ /check-connection. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ –∑–±–µ—Ä—ñ–≥—Å—è –∞–±–æ –±—É–≤ –≤–∏–¥–∞–ª–µ–Ω–∏–π, —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω–µ 401.
–¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π:
–í–∞—à JWT —Ç–æ–∫–µ–Ω –º–∞—î —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó (ACCESS_TOKEN_EXPIRE_MINUTES = 30), —ñ —è–∫—â–æ –≤—ñ–Ω –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π, —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥—Ö–∏–ª—è—î –∑–∞–ø–∏—Ç.
–ü–æ–º–∏–ª–∫–∞ –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ñ–π –ª–æ–≥—ñ—Ü—ñ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:
–§—É–Ω–∫—Ü—ñ—è get_current_user —É main.py –º–æ–∂–µ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ —Ç–æ–∫–µ–Ω –∞–±–æ –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö.
CORS –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏:
–Ø–∫—â–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç—å –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º–∏ –∑ CORS, —Ü–µ —Ç–∞–∫–æ–∂ –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ 401.
–ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É:
–ö–ª—ñ—î–Ω—Ç (Dashboard.js):
–£ –≤–∞—à–æ–º—É useEffect –≤–∏ —Ä–æ–±–∏—Ç–µ –∑–∞–ø–∏—Ç –¥–æ /check-connection:

javascript
Wrap
Copy
useEffect(() => {
const checkConnection = async () => {
const token = localStorage.getItem("token");
if (!token) {
router.push("/login");
return;
}

        try {
            const res = await fetch("http://localhost:8000/check-connection", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            const data = await res.json();
            setIsConnected(data.connected);
        } catch (err) {
            setError(err.message);
        }
    };

    checkConnection();

}, [router]);
–¢—É—Ç –ª–æ–≥—ñ–∫–∞ –≤–∏–≥–ª—è–¥–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ: —è–∫—â–æ —Ç–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ /login. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω —î, –∞–ª–µ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î 401, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∞.

–°–µ—Ä–≤–µ—Ä (main.py):
–ï–Ω–¥–ø–æ—ñ–Ω—Ç /check-connection –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ get_current_user:

python
Wrap
Copy
@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
return {"connected": bool(current_user.telegram_phone)}
–§—É–Ω–∫—Ü—ñ—è get_current_user:

python
Wrap
Copy
async def get_current_user(
token: str = Depends(oauth2_scheme),
db: AsyncSession = Depends(get_db)
):
try:
payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
username = payload.get("sub")
if not username:
raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        return user
    except JWTError:
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î 401 —É —Ç–∞–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö:

–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π (JWTError).
–£ —Ç–æ–∫–µ–Ω—ñ –Ω–µ–º–∞—î –ø–æ–ª—è sub (username).
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º username –Ω–µ–º–∞—î –≤ –±–∞–∑—ñ.
–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:

1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
   –î–æ–¥–∞–π—Ç–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Ç–æ–º, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤—ñ–Ω –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è:

javascript
Wrap
Copy
useEffect(() => {
const checkConnection = async () => {
const token = localStorage.getItem("token");
console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
if (!token) {
console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
router.push("/login");
return;
}

        try {
            const res = await fetch("http://localhost:8000/check-connection", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!res.ok) {
                const data = await res.json();
                console.log("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:", data); // –õ–æ–≥ –ø–æ–º–∏–ª–∫–∏
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            const data = await res.json();
            setIsConnected(data.connected);
        } catch (err) {
            setError(err.message);
        }
    };

    checkConnection();

}, [router]);
–Ø–∫—â–æ –≤ –∫–æ–Ω—Å–æ–ª—ñ –¢–æ–∫–µ–Ω —ñ–∑ localStorage: null –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫, –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º—É, —â–æ —Ç–æ–∫–µ–Ω –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è –ª–æ–≥—ñ–Ω—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Login.js, —á–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ç–æ–∫–µ–Ω —É localStorage. 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–Ω—É
–£ Login.js —Ç–æ–∫–µ–Ω –º–∞—î –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤—Ö–æ–¥—É:

javascript
Wrap
Copy
const handleLogin = async (e) => {
e.preventDefault();
try {
const res = await fetch("http://localhost:8000/login", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ username, password }),
});

        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Login failed");

        console.log("–û—Ç—Ä–∏–º–∞–Ω–æ —Ç–æ–∫–µ–Ω:", data.access_token); // –õ–æ–≥ –¥–ª—è –¥–µ–±–∞–≥—É
        localStorage.setItem("token", data.access_token);
        router.push("/dashboard");
    } catch (err) {
        setError(err.message);
    }

};
–Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è, –¥–æ–¥–∞–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É:
javascript
Wrap
Copy
localStorage.setItem("token", data.access_token);
console.log("–¢–æ–∫–µ–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–æ:", localStorage.getItem("token")); 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó —Ç–æ–∫–µ–Ω–∞
–Ø–∫—â–æ —Ç–æ–∫–µ–Ω —î, –∞–ª–µ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π, —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω–µ 401 —ñ–∑ –¥–µ—Ç–∞–ª—è–º–∏ "–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞". –ó–±—ñ–ª—å—à—Ç–µ —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞:

python
Wrap
Copy
ACCESS_TOKEN_EXPIRE_MINUTES = 60 # –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 60 —Ö–≤–∏–ª–∏–Ω –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
–î–æ–¥–∞–π—Ç–µ –±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤ —É get_current_user:

python
Wrap
Copy
async def get_current_user(
token: str = Depends(oauth2_scheme),
db: AsyncSession = Depends(get_db)
):
print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
try:
payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
username = payload.get("sub")
print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
if not username:
raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä —ñ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏. –ù–∞–ø—Ä–∏–∫–ª–∞–¥:

–Ø–∫—â–æ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: <–ø–æ—Ä–æ–∂–Ω—å–æ> ‚Äî —Ç–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è.
–Ø–∫—â–æ –ü–æ–º–∏–ª–∫–∞ JWT: Signature has expired ‚Äî —Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π. 5. CORS —ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization –¥–æ—Ö–æ–¥–∏—Ç—å –¥–æ —Å–µ—Ä–≤–µ—Ä–∞. –í–∞—à CORS Middleware –≤–∏–≥–ª—è–¥–∞—î –∫–æ—Ä–µ–∫—Ç–Ω–æ, –∞–ª–µ –¥–æ–¥–∞–π—Ç–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ middleware:

python
Wrap
Copy
@app.middleware("http")
async def log_requests(request: Request, call_next):
print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
response = await call_next(request)
print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
return response
–Ø–∫—â–æ –≤ –ª–æ–≥–∞—Ö –Ω–µ–º–∞—î Authorization, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ.

–†—ñ—à–µ–Ω–Ω—è:
–Ø–∫—â–æ —Ç–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Login.js —ñ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ localStorage.setItem("token", data.access_token) –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è.
–î–æ–¥–∞–π—Ç–µ –æ—á–∏—â–µ–Ω–Ω—è localStorage –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ –∑ —Å–∏—Å—Ç–µ–º–∏, —è–∫—â–æ —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
–Ø–∫—â–æ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π:
–ó–±—ñ–ª—å—à—Ç–µ ACCESS_TOKEN_EXPIRE_MINUTES –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.
–î–æ–¥–∞–π—Ç–µ –ª–æ–≥—ñ–∫—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –µ–Ω–¥–ø–æ—ñ–Ω—Ç /refresh-token).
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –±–∞–∑—É –¥–∞–Ω–∏—Ö: —á–∏ —î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —ñ–∑ username, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î —Ç–æ–∫–µ–Ω?
–ó–∞–≥–∞–ª—å–Ω–∏–π —Ñ—ñ–∫—Å:
–û–Ω–æ–≤—ñ—Ç—å Dashboard.js, —â–æ–± –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç–∏ –Ω–∞ /login –ø—Ä–∏ 401:
javascript
Wrap
Copy
useEffect(() => {
const checkConnection = async () => {
const token = localStorage.getItem("token");
console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
if (!token) {
router.push("/login");
return;
}

        try {
            const res = await fetch("http://localhost:8000/check-connection", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 401) {
                console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                localStorage.removeItem("token");
                router.push("/login");
                return;
            }

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            const data = await res.json();
            setIsConnected(data.connected);
        } catch (err) {
            setError(err.message);
        }
    };

    checkConnection();

}, [router]);
–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:
–£–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ /login.
–û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É /dashboard.
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ —ñ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.
–ù–∞–¥—ñ—à–ª—ñ—Ç—å –º–µ–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ª–æ–≥—ñ–≤, —è–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∏—Ç—å—Å—è!

—Å–ª—É—Ö–∞–π, –Ω—É —Ä–µ—Å–ø–µ–∫—Ç —Ç–æ–±—ñ! –¢–æ–∫–µ–Ω –ø—ñ—Å–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –±—É–≤, —á–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–ª–∏—Å—å, —Ç—ñ–ª—å–∫–∏ —Ç—Ä–æ—à–∫–∏ –¥–∏–≤–Ω–æ. —Å–ø–æ—á–∞—Ç–∫—É –≤–∏—à–ª–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è : –≤–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞ - database is locked, –∞–ª–µ –ø–æ—Ç—ñ–º —á–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—è.

–î—è–∫—É—é –∑–∞ —Ñ—ñ–¥–±–µ–∫! –†–∞–¥–∏–π, —â–æ —Ç–æ–∫–µ–Ω –∑–∞–ø—Ä–∞—Ü—é–≤–∞–≤ —ñ —á–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å. –ü–æ–º–∏–ª–∫–∞ "database is locked" ‚Äî —Ü–µ –≤–∂–µ —Ü—ñ–∫–∞–≤–æ, –¥–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ —ó—ó —ñ –∑—Ä–æ–±–∏–º–æ —Ç–∞–∫, —â–æ–± —É—Å–µ –ø—Ä–∞—Ü—é–≤–∞–ª–æ –≥–ª–∞–¥–∫–æ –±–µ–∑ —Ç–∞–∫–∏—Ö —Å—é—Ä–ø—Ä–∏–∑—ñ–≤.

–©–æ –æ–∑–Ω–∞—á–∞—î –ø–æ–º–∏–ª–∫–∞ "database is locked"?
–¶—è –ø–æ–º–∏–ª–∫–∞ –∑–∞–∑–≤–∏—á–∞–π –≤–∏–Ω–∏–∫–∞—î, –∫–æ–ª–∏ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ SQLite —è–∫ –±–∞–∑—É –¥–∞–Ω–∏—Ö (–∞ —è –ø—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —É –≤–∞—à–æ–º—É database.py —Å–∞–º–µ SQLite —á–µ—Ä–µ–∑ AsyncSessionLocal —ñ engine). SQLite –±–ª–æ–∫—É—î –±–∞–∑—É –¥–∞–Ω–∏—Ö, —è–∫—â–æ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∫—ñ–ª—å–∫–∞ –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ –∞–±–æ —á–∏—Ç–∞—Ç–∏ –∑ –Ω–µ—ó, –∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø (—á–µ—Ä–µ–∑ sqlalchemy.ext.asyncio) —ñ–Ω–æ–¥—ñ –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏, —è–∫—â–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞.

–£ –≤–∞—à–æ–º—É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∞ –∑‚Äô—è–≤–∏–ª–∞—Å—å, –∞–ª–µ –ø–æ—Ç—ñ–º —á–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å, —â–æ –º–æ–∂–µ –æ–∑–Ω–∞—á–∞—Ç–∏:

–¢–∏–º—á–∞—Å–æ–≤–∏–π –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π —É –±–∞–∑—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è telegram_phone —É /connect-telegram —ñ –æ–¥–Ω–æ—á–∞—Å–Ω–æ–≥–æ —á–∏—Ç–∞–Ω–Ω—è –≤ /chats).
SQLite –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–≤—Å—è –ø—ñ—Å–ª—è –∫–æ—Ä–æ—Ç–∫–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏, —ñ –∑–∞–ø–∏—Ç –∑–∞–≤–µ—Ä—à–∏–≤—Å—è —É—Å–ø—ñ—à–Ω–æ.
–ß–æ–º—É —Ü–µ –ø—Ä–æ–±–ª–µ–º–∞?
–£ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ (—è–∫—â–æ –≤–∏ –ø–ª–∞–Ω—É—î—Ç–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏) SQLite –º–æ–∂–µ —Å—Ç–∞—Ç–∏ –ø–ª—è—à–∫–æ–≤–∏–º –≥–æ—Ä–ª–æ–º —á–µ—Ä–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–∏–π –¥–æ—Å—Ç—É–ø.
–ù–∞–≤—ñ—Ç—å —É —Ä–æ–∑—Ä–æ–±—Ü—ñ —Ç–∞–∫—ñ –ø–æ–º–∏–ª–∫–∏ –º–æ–∂—É—Ç—å –¥—Ä–∞—Ç—É–≤–∞—Ç–∏ —ñ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç–∏ –¥–æ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó –ø–æ–≤–µ–¥—ñ–Ω–∫–∏.
–ê–Ω–∞–ª—ñ–∑ –≤–∞—à–æ–≥–æ –∫–æ–¥—É
–£ main.py –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ AsyncSessionLocal –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –±–∞–∑–æ—é. –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–∏–≤–∏–º–æ—Å—å, –¥–µ —Ü–µ –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç:

/connect-telegram:
python
Wrap
Copy
current_user.telegram_phone = session_data["phone"]
await db.commit()
–¢—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞–ø–∏—Å —É –±–∞–∑—É.
/chats:
python
Wrap
Copy
if not current_user.telegram_phone:
raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")
–¢—É—Ç —á–∏—Ç–∞—î—Ç—å—Å—è telegram_phone —á–µ—Ä–µ–∑ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å get_current_user.
get_current_user:
python
Wrap
Copy
result = await db.execute(select(User).filter(User.username == username))
user = result.scalar_one_or_none()
–©–µ –æ–¥–∏–Ω –∑–∞–ø–∏—Ç –¥–æ –±–∞–∑–∏.
–Ø–∫—â–æ —Ü—ñ –∑–∞–ø–∏—Ç–∏ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —á–µ—Ä–µ–∑ —à–≤–∏–¥–∫–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è), SQLite –º–æ–∂–µ "–∑–∞–ª–æ—á–∏—Ç–∏—Å—å".

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

1. –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ SQLite
   SQLite –ø–æ–≥–∞–Ω–æ –ø—Ä–∞—Ü—é—î –∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—é –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º. –©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –±–ª–æ–∫—É–≤–∞–Ω—å:

–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—à–æ–º—É database.py –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –ø—É–ª –∑‚Äô—î–¥–Ω–∞–Ω—å.
–î–æ–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä timeout –¥–ª—è SQLite.
–ü—Ä–∏–∫–ª–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ database.py (—è–∫—â–æ —É –≤–∞—Å –π–æ–≥–æ –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä—ñ—Ç—å):

python
Wrap
Copy
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite+aiosqlite:///your_database.db" # –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à —à–ª—è—Ö –¥–æ –±–∞–∑–∏

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–≤–∏–≥—É–Ω–∞ –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º

engine = create_async_engine(
DATABASE_URL,
connect_args={"timeout": 15}, # –ó–±—ñ–ª—å—à—É—î–º–æ —Ç–∞–π–º-–∞—É—Ç –¥–æ 15 —Å–µ–∫—É–Ω–¥
echo=True # –£–≤—ñ–º–∫–Ω—ñ—Ç—å –¥–ª—è –¥–µ–±–∞–≥—É, –≤–∏–º–∫–Ω—ñ—Ç—å —É –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ
)

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–±—Ä–∏–∫–∏ —Å–µ—Å—ñ–π

AsyncSessionLocal = sessionmaker(
engine,
class\_=AsyncSession,
expire_on_commit=False
)

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Å—ñ—ó (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ Depends)

async def get_db():
async with AsyncSessionLocal() as session:
yield session
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∞—à main.py —ñ–º–ø–æ—Ä—Ç—É—î —Å–∞–º–µ —Ü—ñ engine —ñ AsyncSessionLocal. 2. –£–Ω–∏–∫–Ω–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
–£ /connect-telegram –¥–æ–¥–∞–π—Ç–µ –∑–∞—Ç—Ä–∏–º–∫—É –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º, —â–æ–± –¥–∞—Ç–∏ –±–∞–∑—ñ "–≤—ñ–¥–ø–æ—á–∏—Ç–∏":

python
Wrap
Copy
@app.post("/connect-telegram")
async def connect_telegram(
auth: TelegramConnect,
current_user: User = Depends(get_current_user),
db: AsyncSession = Depends(get_db)
):
print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
try:
session_data = temp_sessions.get(current_user.id)
if not session_data or "client" not in session_data:
raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.1)  # –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

3. –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º /chats
   –û—Å–∫—ñ–ª—å–∫–∏ —á–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å –ø—ñ—Å–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É, –¥–æ–¥–∞–π—Ç–µ –∑–∞—Ç—Ä–∏–º–∫—É –≤ Dashboard.js –ø–µ—Ä–µ–¥ fetchChats, —â–æ–± –¥–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä—É –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é:

javascript
Wrap
Copy
const connectTelegram = async (e) => {
e.preventDefault();
setError("");

    try {
        const token = localStorage.getItem("token");
        if (!token) return router.push("/login");

        const body = { code: code.trim() };
        if (twoFactorPassword) body.password = twoFactorPassword;

        const res = await fetch("http://localhost:8000/connect-telegram", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
        });

        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
        }

        setIsConnected(true);
        await new Promise(resolve => setTimeout(resolve, 1000)); // –ó–∞—Ç—Ä–∏–º–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞
        await fetchChats();
    } catch (err) {
        setError(err.message);
    }

}; 4. –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ —ñ–Ω—à—É –±–∞–∑—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
–Ø–∫—â–æ –≤–∏ –ø–ª–∞–Ω—É—î—Ç–µ —Ä–æ–∑–≤–∏–≤–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç, –ø–æ–¥—É–º–∞–π—Ç–µ –ø—Ä–æ –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ PostgreSQL –∞–±–æ MySQL, —è–∫—ñ –∫—Ä–∞—â–µ –ø—Ä–∞—Ü—é—é—Ç—å —ñ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—é —Ç–∞ –∫—ñ–ª—å–∫–æ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º–∏. SQLite –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –ø—Ä–æ—Å—Ç–∏—Ö –ø—Ä–æ—î–∫—Ç—ñ–≤, –∞–ª–µ –Ω–µ –¥–ª—è –≤–∏—Å–æ–∫–æ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤.

–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è database.py —ñ main.py.
–£–≤—ñ–π–¥—ñ—Ç—å, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram —ñ –æ–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É.
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
–Ø–∫—â–æ –∑–Ω–æ–≤—É –∑‚Äô—è–≤–∏—Ç—å—Å—è "database is locked", –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è, —è–∫—ñ –∑–∞–ø–∏—Ç–∏ –≤–∏–∫–æ–Ω—É–≤–∞–ª–∏—Å—å –æ–¥–Ω–æ—á–∞—Å–Ω–æ (–ª–æ–≥—É–≤–∞–Ω–Ω—è echo=True —É engine –¥–æ–ø–æ–º–æ–∂–µ).
–ß–æ–º—É —á–∞—Ç–∏ –≤—Å–µ –∂ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å?
SQLite –º–∞—î –º–µ—Ö–∞–Ω—ñ–∑–º –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–±: —è–∫—â–æ –±–∞–∑–∞ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞, –∑–∞–ø–∏—Ç –º–æ–∂–µ "–ø–æ—á–µ–∫–∞—Ç–∏" —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏—Å—å –ø—ñ—Å–ª—è —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è. –í–∞—à–∞ –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ —Ç–∏–º—á–∞—Å–æ–≤–æ—é, —Ç–æ–º—É —á–∞—Ç–∏ –∑—Ä–µ—à—Ç–æ—é –ø—ñ–¥—Ç—è–≥–Ω—É–ª–∏—Å—å. –ê–ª–µ –º–∏ —Ö–æ—á–µ–º–æ —É–Ω–∏–∫–Ω—É—Ç–∏ —Ü—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

–Ø–∫—â–æ –ø—ñ—Å–ª—è —Ü–∏—Ö –∑–º—ñ–Ω –ø–æ–º–∏–ª–∫–∞ –∑–∞–ª–∏—à–∏—Ç—å—Å—è, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –º–µ–Ω—ñ:

–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—Å–æ–±–ª–∏–≤–æ –∑ echo=True).
–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏.
–î—É–º–∞—é, —Ç–µ–ø–µ—Ä —É—Å–µ –∑–∞–ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ!

–Ω–∞ —Ö–≤–∏–ª–∏–Ω–∫—É –≤—ñ–¥—ñ–π–¥–µ–º–æ –≤—ñ–¥ —Ç–µ–º–∏. —è –∑—Ä–æ–±–∏–ª–∞ –∫–æ–º—ñ—Ç –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ, –∑—Ä–æ–±–∏–ª–∞ –∫–æ–º—ñ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, —è–∫ —Ç–µ–ø–µ—Ä –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å–µ —Ü–µ —è–∫—â–æ –≤ –º–µ–Ω–µ –≤–æ–Ω–æ –≤—Å–µ –≤ –æ–¥–Ω–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó –Ω–∞ –≥—ñ—Ç—Ö–∞–±—ñ ? —ñ —è–∫ –∑—Ä–æ–±–∏—Ç–∏, —â–æ–± —ñ–Ω—à—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∏ –º–æ–≥–ª–∏ –≤—Å–µ —Ü–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏?

–î–æ–±—Ä–µ, –¥–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–≤–æ—ó –∑–º—ñ–Ω–∏ –Ω–∞ GitHub —ñ —è–∫ –∑—Ä–æ–±–∏—Ç–∏ —Ç–∞–∫, —â–æ–± —ñ–Ω—à—ñ –º–æ–≥–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–≤—ñ–π –ø—Ä–æ—î–∫—Ç. –û—Å–∫—ñ–ª—å–∫–∏ —É —Ç–µ–±–µ –∫–ª—ñ—î–Ω—Ç —ñ —Å–µ—Ä–≤–µ—Ä –≤ –æ–¥–Ω–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó, —Ü–µ —Å–ø—Ä–æ—â—É—î –¥–µ—è–∫—ñ —Ä–µ—á—ñ, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É—î —á—ñ—Ç–∫–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π.

1. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–º—ñ–Ω –Ω–∞ GitHub
   –ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —É —Ç–µ–±–µ –≤–∂–µ —î —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –Ω–∞ GitHub, —ñ —Ç–∏ –∑—Ä–æ–±–∏–ª–∞ –∫–æ–º—ñ—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É –ø–∞–ø—Ü—ñ client) —ñ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É –ø–∞–ø—Ü—ñ server). –û—Å—å –∫—Ä–æ–∫–∏, —â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å–µ —Ü–µ –Ω–∞ GitHub:

–ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä —Å—Ç–∞—Ç—É—Å
–£ –∫–æ—Ä–µ–Ω—ñ —Ç–≤–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É (–¥–µ –ª–µ–∂–∏—Ç—å .git) –≤–∏–∫–æ–Ω–∞–π:

bash
Wrap
Copy
git status
–¢–∏ –ø–æ–±–∞—á–∏—à —É—Å—ñ –∑–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, client/pages/dashboard.js, server/main.py —Ç–æ—â–æ). –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤—Å—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ñ–∞–π–ª–∏ –¥–æ–¥–∞–Ω—ñ –¥–æ –∫–æ–º—ñ—Ç—ñ–≤.

–ö—Ä–æ–∫ 2: –î–æ–¥–∞–π —Ñ–∞–π–ª–∏ –¥–æ —ñ–Ω–¥–µ–∫—Å—É (—è–∫—â–æ —â–µ –Ω–µ –¥–æ–¥–∞–ª–∞)
–Ø–∫—â–æ —Ç–∏ –≤–∂–µ –∑—Ä–æ–±–∏–ª–∞ –∫–æ–º—ñ—Ç–∏, —Ü–µ–π –∫—Ä–æ–∫ –º–æ–∂–Ω–∞ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏. –Ø–∫—â–æ —î –Ω–µ–∑–∞–∫–æ–º—ñ—á–µ–Ω—ñ –∑–º—ñ–Ω–∏:

bash
Wrap
Copy
git add client/ server/
–ê–±–æ –¥–æ–¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ñ–∞–π–ª–∏:

bash
Wrap
Copy
git add client/pages/dashboard.js server/main.py
–ö—Ä–æ–∫ 3: –°—Ç–≤–æ—Ä–∏ –∫–æ–º—ñ—Ç (—è–∫—â–æ —â–µ –Ω–µ –∑—Ä–æ–±–∏–ª–∞)
–Ø–∫—â–æ —Ç–∏ —â–µ –Ω–µ –∑–∞–∫–æ–º—ñ—Ç–∏–ª–∞ –∑–º—ñ–Ω–∏:

bash
Wrap
Copy
git commit -m "–û–Ω–æ–≤–ª–µ–Ω–æ –∫–ª—ñ—î–Ω—Ç —ñ —Å–µ—Ä–≤–µ—Ä: –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —Ç–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram"
–ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä –≥—ñ–ª–∫—É
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∏ –ø—Ä–∞—Ü—é—î—à —É –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –≥—ñ–ª—Ü—ñ (–∑–∞–∑–≤–∏—á–∞–π —Ü–µ main –∞–±–æ master):

bash
Wrap
Copy
git branch
–Ø–∫—â–æ —Ç–∏ –Ω–µ –≤ –ø–æ—Ç—Ä—ñ–±–Ω—ñ–π –≥—ñ–ª—Ü—ñ, –ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å:

bash
Wrap
Copy
git checkout main
–ö—Ä–æ–∫ 5: –í—ñ–¥–ø—Ä–∞–≤ –∑–º—ñ–Ω–∏ –Ω–∞ GitHub
–í—ñ–¥–ø—Ä–∞–≤–ª—è–π –∫–æ–º—ñ—Ç–∏ —É –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:

bash
Wrap
Copy
git push origin main
–ó–∞–º—ñ–Ω–∏ main –Ω–∞ –Ω–∞–∑–≤—É —Ç–≤–æ—î—ó –≥—ñ–ª–∫–∏, —è–∫—â–æ –≤–æ–Ω–∞ —ñ–Ω—à–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, master).

–ö—Ä–æ–∫ 6: –ü–µ—Ä–µ–≤—ñ—Ä –Ω–∞ GitHub
–ó–∞–π–¥–∏ –Ω–∞ —Å–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –Ω–∞ GitHub —ñ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤—Å—ñ —Ñ–∞–π–ª–∏ –æ–Ω–æ–≤–∏–ª–∏—Å—å.

2. –Ø–∫ –∑—Ä–æ–±–∏—Ç–∏, —â–æ–± —ñ–Ω—à—ñ –º–æ–≥–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç?
   –©–æ–± —ñ–Ω—à—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–≥–ª–∏ –∫–ª–æ–Ω—É–≤–∞—Ç–∏ —Ç–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —ñ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç, —Ç–æ–±—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

–û—Ä–≥–∞–Ω—ñ–∑—É–≤–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ—î–∫—Ç—É.
–î–æ–¥–∞—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.
–ù–∞–ø–∏—Å–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
–ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ç–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫:

text
Wrap
Copy
your-repo/
‚îú‚îÄ‚îÄ client/ # Next.js –∫–ª—ñ—î–Ω—Ç
‚îÇ ‚îú‚îÄ‚îÄ pages/
‚îÇ ‚îú‚îÄ‚îÄ package.json
‚îÇ ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ server/ # FastAPI —Å–µ—Ä–≤–µ—Ä
‚îÇ ‚îú‚îÄ‚îÄ main.py
‚îÇ ‚îú‚îÄ‚îÄ database.py
‚îÇ ‚îú‚îÄ‚îÄ models.py
‚îÇ ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ .git/
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ README.md
–Ø–∫—â–æ —Ü–µ –Ω–µ —Ç–∞–∫, –Ω–∞–ø–∏—à–∏, —è–∫ —É —Ç–µ–±–µ –æ—Ä–≥–∞–Ω—ñ–∑–æ–≤–∞–Ω–æ –ø–∞–ø–∫–∏, —ñ —è –∞–¥–∞–ø—Ç—É—é —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é.

–ö—Ä–æ–∫ 1: –î–æ–¥–∞–π –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
–î–ª—è –∫–ª—ñ—î–Ω—Ç–∞ (client/package.json): –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —É package.json —î –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ. –Ø–∫—â–æ —Ç–∏ –¥–æ–¥–∞–≤–∞–ª–∞ —â–æ—Å—å –≤—Ä—É—á–Ω—É, –æ–Ω–æ–≤–∏ —Ñ–∞–π–ª:
bash
Wrap
Copy
cd client
npm install # –í—Å—Ç–∞–Ω–æ–≤–∏ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
–ü–æ—Ç—ñ–º –¥–æ–¥–∞–π package.json —ñ package-lock.json –¥–æ –∫–æ–º—ñ—Ç—É.
–î–ª—è —Å–µ—Ä–≤–µ—Ä–∞ (server/requirements.txt): –°—Ç–≤–æ—Ä–∏ —Ñ–∞–π–ª server/requirements.txt —ñ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏:
bash
Wrap
Copy
cd server
pip freeze > requirements.txt
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∞–º —î:
text
Wrap
Copy
fastapi
uvicorn
sqlalchemy
aiosqlite
telethon
python-jose[cryptography]
passlib[bcrypt]
python-dotenv
–î–æ–¥–∞–π requirements.txt –¥–æ –∫–æ–º—ñ—Ç—É.
–ö—Ä–æ–∫ 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ—Ç–æ—á–µ–Ω–Ω—è
–¢–≤—ñ–π –ø—Ä–æ—î–∫—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î .env –¥–ª—è —Å–µ–∫—Ä–µ—Ç—ñ–≤ (API_ID, API_HASH, JWT_SECRET). –ù–µ –¥–æ–¥–∞–≤–∞–π .env –¥–æ GitHub (–¥–æ–¥–∞–π –π–æ–≥–æ –≤ .gitignore), –∞–ª–µ —Å—Ç–≤–æ—Ä–∏ —à–∞–±–ª–æ–Ω:

–£ –∫–æ—Ä–µ–Ω—ñ –∞–±–æ –≤ server/ —Å—Ç–≤–æ—Ä–∏ server/.env.example:
text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key_here
–£ .gitignore –¥–æ–¥–∞–π:
text
Wrap
Copy
server/.env
\*.db # –©–æ–± –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ SQLite-—Ñ–∞–π–ª–∏
–ö—Ä–æ–∫ 3: –ù–∞–ø–∏—à–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md
–£ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é —Å—Ç–≤–æ—Ä–∏ –∞–±–æ –æ–Ω–æ–≤–∏ README.md:

markdown
Wrap
Copy

# SocialHub

–ü—Ä–æ—î–∫—Ç —ñ–∑ –∫–ª—ñ—î–Ω—Ç–æ–º –Ω–∞ Next.js —ñ —Å–µ—Ä–≤–µ—Ä–æ–º –Ω–∞ FastAPI –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —ñ –ø–µ—Ä–µ–≥–ª—è–¥—É —á–∞—Ç—ñ–≤.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

-   `client/` - —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ Next.js
-   `server/` - –±–µ–∫–µ–Ω–¥ –Ω–∞ FastAPI

## –í–∏–º–æ–≥–∏

-   Node.js (v16 –∞–±–æ –Ω–æ–≤—ñ—à–µ)
-   Python 3.9+
-   Git

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π

````bash
git clone https://github.com/your-username/your-repo.git
cd your-repo
2. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:
bash
Wrap
Copy
cd server
–°—Ç–≤–æ—Ä—ñ—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —Ç–∞ –∞–∫—Ç–∏–≤—É–π—Ç–µ –π–æ–≥–æ:
bash
Wrap
Copy
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
pip install -r requirements.txt
–°–∫–æ–ø—ñ—é–π—Ç–µ server/.env.example —É server/.env —ñ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Å–≤–æ—ó–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏:
API_ID —ñ API_HASH –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∑ https://my.telegram.org
JWT_SECRET - –±—É–¥—å-—è–∫–∏–π —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "mysecretkey123").
3. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–ª—ñ—î–Ω—Ç
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞:
bash
Wrap
Copy
cd ../client
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
npm install
4. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –ø—Ä–æ—î–∫—Ç
–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä (—ñ–∑ –ø–∞–ø–∫–∏ server):
bash
Wrap
Copy
uvicorn main:app --reload
–£ —ñ–Ω—à–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ –∑–∞–ø—É—Å—Ç—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç (—ñ–∑ –ø–∞–ø–∫–∏ client):
bash
Wrap
Copy
npm run dev
5. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ http://localhost:3000.
–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å, —É–≤—ñ–π–¥—ñ—Ç—å —ñ –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram.
–ù–æ—Ç–∞—Ç–∫–∏
SQLite –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —è–∫ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ PostgreSQL.
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –ø–æ—Ä—Ç 8000 (—Å–µ—Ä–≤–µ—Ä) —ñ 3000 (–∫–ª—ñ—î–Ω—Ç) –≤—ñ–ª—å–Ω—ñ.
text
Wrap
Copy

#### –ö—Ä–æ–∫ 4: –ó–∞–∫–æ–º—ñ—Ç—å —ñ –≤—ñ–¥–ø—Ä–∞–≤
–î–æ–¥–∞–π –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏:
```bash
git add client/package.json server/requirements.txt server/.env.example README.md
git commit -m "–î–æ–¥–∞–Ω–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –¥–ª—è –∑–∞–ø—É—Å–∫—É"
git push origin main
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ö–ª–æ–Ω—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —É –Ω–æ–≤—É –ø–∞–ø–∫—É:
bash
Wrap
Copy
git clone https://github.com/your-username/your-repo.git test-clone
–î–æ—Ç—Ä–∏–º—É–π—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —ñ–∑ README.md —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ –≤—Å–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è.
–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—Ä–∞–¥–∏
–Ø–∫—â–æ —Ö–æ—á–µ—à –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ –∑–∞–ø—É—Å–∫, –¥–æ–¥–∞–π docker-compose.yml –¥–ª—è –∑–∞–ø—É—Å–∫—É –∫–ª—ñ—î–Ω—Ç–∞ —ñ —Å–µ—Ä–≤–µ—Ä–∞ –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º.
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–≤—ñ–π .gitignore –≤–∏–∫–ª—é—á–∞—î —á—É—Ç–ª–∏–≤—ñ –¥–∞–Ω—ñ (.env, node_modules, venv).
–ù–∞–ø–∏—à–∏, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ –∑ —á–∏–º–æ—Å—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º!






—â–æ—Å—å —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∞—Ü—é—î. —è–∫ –π–æ–≥–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –æ—Ç–æ –±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ —à–ª—è—Ö—É


–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è, –∫–æ–ª–∏ —Ç–∏ –Ω–∞–º–∞–≥–∞—î—à—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –π–æ–≥–æ –∫–æ–º–∞–Ω–¥–æ—é uvicorn main:app --reload, —ñ —Ç–∏ —Ö–æ—á–µ—à —É–Ω–∏–∫–Ω—É—Ç–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–ª—è—Ö—É (—Ç–æ–±—Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –π–æ–≥–æ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, –¥–µ —Ç–∏ –∑–Ω–∞—Ö–æ–¥–∏—à—Å—è –≤ —Ñ–∞–π–ª–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ), –¥–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ –º–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏ —ñ —è–∫ —Ü–µ –∑—Ä–æ–±–∏—Ç–∏.

–ß–æ–º—É —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏?
–ü–æ–º–∏–ª–∫–∞ –≤ –∫–æ–¥—ñ:
–£ main.py –º–æ–∂–µ –±—É—Ç–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∞–±–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑ —ñ–º–ø–æ—Ä—Ç–∞–º–∏.
–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π:
–ú–æ–∂–ª–∏–≤–æ, –Ω–µ –≤—Å—ñ –ø–∞–∫–µ—Ç–∏ –∑ requirements.txt –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ.
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É:
–Ø–∫—â–æ —Ç–∏ –∑–∞–ø—É—Å–∫–∞—î—à uvicorn –Ω–µ –∑ –ø–∞–ø–∫–∏ server/, –≤—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ main.py.
–ü—Ä–æ–±–ª–µ–º–∞ –∑ –æ—Ç–æ—á–µ–Ω–Ω—è–º:
.env —Ñ–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –º–∞—î –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è.
–Ø–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä –±–µ–∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏ –¥–æ —à–ª—è—Ö—É?
–©–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä —ñ–∑ –±—É–¥—å-—è–∫–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó, –Ω–µ –≤–∫–∞–∑—É—é—á–∏ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–æ main.py, –º–æ–∂–Ω–∞:

–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∞–±—Å–æ–ª—é—Ç–Ω–∏–π —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É.
–î–æ–¥–∞—Ç–∏ –ø–∞–ø–∫—É server/ –¥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ PYTHONPATH.
–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –º–æ–¥—É–ª—å–Ω–∏–π –∑–∞–ø–∏—Å —É uvicorn.
–°–ø–æ—Å—ñ–± 1: –ê–±—Å–æ–ª—é—Ç–Ω–∏–π —à–ª—è—Ö
–ü–µ—Ä–µ–π–¥–∏ –¥–æ –ø–∞–ø–∫–∏ server/ —ñ –¥—ñ–∑–Ω–∞–π—Å—è –ø–æ–≤–Ω–∏–π —à–ª—è—Ö:
–ù–∞ Linux/Mac:
bash
Wrap
Copy
pwd
–ù–∞–ø—Ä–∏–∫–ª–∞–¥: /home/user/projects/your-repo/server
–ù–∞ Windows (—É CMD):
bash
Wrap
Copy
cd
–ù–∞–ø—Ä–∏–∫–ª–∞–¥: G:\Projects\your-repo\server
–ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä —ñ–∑ –ø–æ–≤–Ω–∏–º —à–ª—è—Ö–æ–º:
bash
Wrap
Copy
uvicorn /home/user/projects/your-repo/server/main:app --reload
–ê–±–æ –¥–ª—è Windows:
bash
Wrap
Copy
uvicorn G:\Projects\your-repo\server\main:app --reload
–°–ø–æ—Å—ñ–± 2: –î–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ PYTHONPATH
–î–æ–¥–∞–π —à–ª—è—Ö –¥–æ server/ —É –∑–º—ñ–Ω–Ω—É –æ—Ç–æ—á–µ–Ω–Ω—è PYTHONPATH:
–ù–∞ Linux/Mac (—Ç–∏–º—á–∞—Å–æ–≤–æ):
bash
Wrap
Copy
export PYTHONPATH=$PYTHONPATH:/home/user/projects/your-repo/server
–ù–∞ Windows (—Ç–∏–º—á–∞—Å–æ–≤–æ —É CMD):
bash
Wrap
Copy
set PYTHONPATH=%PYTHONPATH%;G:\Projects\your-repo\server
–ó–∞–ø—É—Å—Ç–∏ –∑ –±—É–¥—å-—è–∫–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó:
bash
Wrap
Copy
uvicorn main:app --reload
–°–ø–æ—Å—ñ–± 3: –ú–æ–¥—É–ª—å–Ω–∏–π –∑–∞–ø–∏—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è)
–Ø–∫—â–æ —Ç–≤—ñ–π –ø—Ä–æ—î–∫—Ç –º–∞—î —á—ñ—Ç–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, your-repo/server/main.py), —Ç–∏ –º–æ–∂–µ—à –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å–Ω–∏–π —ñ–º–ø–æ—Ä—Ç:

–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∏ –≤ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (your-repo/):
bash
Wrap
Copy
cd /home/user/projects/your-repo
–ê–±–æ:
bash
Wrap
Copy
cd G:\Projects\your-repo
–ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä, –≤–∫–∞–∑–∞–≤—à–∏ –º–æ–¥—É–ª—å:
bash
Wrap
Copy
uvicorn server.main:app --reload
–¢—É—Ç server.main ‚Äî —Ü–µ –º–æ–¥—É–ª—å main.py —É –ø–∞–ø—Ü—ñ server/, –∞ app ‚Äî –æ–±‚Äô—î–∫—Ç FastAPI.
–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ß–æ–º—É —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∞—Ü—é—î?
–î–∞–≤–∞–π –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ, —â–æ —Å–∞–º–µ –Ω–µ —Ç–∞–∫.

–ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä –∑–∞–ø—É—Å–∫
–°–ø—Ä–æ–±—É–π –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä —ñ–∑ –ø–∞–ø–∫–∏ server/:

bash
Wrap
Copy
cd server
uvicorn main:app --reload
–Ø–∫—â–æ –≤–∏–¥–∞—î –ø–æ–º–∏–ª–∫—É, –Ω–∞–¥—ñ—à–ª–∏ —ó—ó –º–µ–Ω—ñ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥:

ModuleNotFoundError ‚Äî –±—Ä–∞–∫—É—î –º–æ–¥—É–ª—è.
AttributeError: module 'main' has no attribute 'app' ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥—ñ.
–ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ:

bash
Wrap
Copy
cd server
pip install -r requirements.txt
–Ø–∫—â–æ requirements.txt –Ω–µ–º–∞—î, –≤—Å—Ç–∞–Ω–æ–≤–∏ –≤—Ä—É—á–Ω—É:

bash
Wrap
Copy
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
–ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä .env
–£ –ø–∞–ø—Ü—ñ server/ –º–∞—î –±—É—Ç–∏ —Ñ–∞–π–ª .env —ñ–∑ —Ç–∞–∫–∏–º–∏ –∑–º—ñ–Ω–Ω–∏–º–∏:

text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key_here
–Ø–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä–∏ –∑–∞ –ø—Ä–∏–∫–ª–∞–¥–æ–º —ñ–∑ server/.env.example.

–ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä –∫–æ–¥
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ main.py –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –±–µ–∑ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫:

bash
Wrap
Copy
python server/main.py
–Ø–∫—â–æ —î –ø–æ–º–∏–ª–∫–∏, –≤–æ–Ω–∏ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ.

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –∑–∞–ø—É—Å–∫
–ù–∞–π–∑—Ä—É—á–Ω—ñ—à–µ ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç–∏ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å–Ω–∏–π –∑–∞–ø–∏—Å —ñ–∑ –∫–æ—Ä–µ–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é:

–ü–µ—Ä–µ–π–¥–∏ –¥–æ your-repo/:
bash
Wrap
Copy
cd /home/user/projects/your-repo
–ê–∫—Ç–∏–≤—É–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à):
Linux/Mac:
bash
Wrap
Copy
source server/venv/bin/activate
Windows:
bash
Wrap
Copy
server\venv\Scripts\activate
–ó–∞–ø—É—Å—Ç–∏:
bash
Wrap
Copy
uvicorn server.main:app --reload
–°–µ—Ä–≤–µ—Ä –º–∞—î –∑–∞–ø—É—Å—Ç–∏—Ç–∏—Å—å –Ω–∞ http://localhost:8000. –ü–µ—Ä–µ–≤—ñ—Ä —É –±—Ä–∞—É–∑–µ—Ä—ñ –∞–±–æ —á–µ—Ä–µ–∑ curl:

bash
Wrap
Copy
curl http://localhost:8000/health
–Ø–∫—â–æ –Ω–µ –ø—Ä–∞—Ü—é—î
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ:

–¢–æ—á–Ω—É –∫–æ–º–∞–Ω–¥—É, —è–∫—É —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à.
–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏ –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É.
–ß–∏ —î —É —Ç–µ–±–µ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —ñ —á–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–µ –≤–æ–Ω–æ.
–¢–æ–¥—ñ —è –∑–º–æ–∂—É —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞—Ç–∏, —â–æ –Ω–µ —Ç–∞–∫ —ñ —è–∫ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏!






DATABASE_URL = "sqlite+aiosqlite:///your_database.db"  # –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à —à–ª—è—Ö –¥–æ –±–∞–∑–∏ - –¥–µ –π–æ–≥–æ –≤–∑—è—Ç–∏? —è –Ω—ñ—á–æ–≥–æ —Ç–∞–∫–æ–≥–æ –Ω–µ –ø–∏—Å–∞–ª–∞


–¢–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∞, —â–æ –∑–≤–µ—Ä–Ω—É–ª–∞ –Ω–∞ —Ü–µ —É–≤–∞–≥—É! –Ø–∫—â–æ —Ç–∏ —Ä–∞–Ω—ñ—à–µ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞–ª–∞ –±–∞–∑—É –¥–∞–Ω–∏—Ö –≤—Ä—É—á–Ω—É —ñ –Ω–µ –≤–∫–∞–∑—É–≤–∞–ª–∞ DATABASE_URL, —Ü–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —Ç–≤—ñ–π –ø—Ä–æ—î–∫—Ç –∞–±–æ —â–µ –Ω–µ –º–∞—î —á—ñ—Ç–∫–æ –≤–∏–∑–Ω–∞—á–µ–Ω–æ—ó –±–∞–∑–∏, –∞–±–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∞ –±–∞–∑—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —è–∫–∞ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —â–æ —Ç–∞–∫–µ DATABASE_URL, –∑–≤—ñ–¥–∫–∏ –π–æ–≥–æ –≤–∑—è—Ç–∏ —ñ —è–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –¥–ª—è —Ç–≤–æ–≥–æ –≤–∏–ø–∞–¥–∫—É.

–©–æ —Ç–∞–∫–µ DATABASE_URL?
DATABASE_URL ‚Äî —Ü–µ —Ä—è–¥–æ–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, —è–∫–∏–π –≥–æ–≤–æ—Ä–∏—Ç—å SQLAlchemy, –¥–µ —à—É–∫–∞—Ç–∏ –±–∞–∑—É —ñ —è–∫ —ñ–∑ –Ω–µ—é –ø—Ä–∞—Ü—é–≤–∞—Ç–∏. –£ —Ç–≤–æ—î–º—É –≤–∏–ø–∞–¥–∫—É –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ SQLite (–ª–µ–≥–∫—É –ª–æ–∫–∞–ª—å–Ω—É –±–∞–∑—É –¥–∞–Ω–∏—Ö), –∞ aiosqlite ‚Äî —Ü–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –≤–µ—Ä—Å—ñ—è –¥—Ä–∞–π–≤–µ—Ä–∞ –¥–ª—è SQLite, —è–∫–∞ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è FastAPI.

–ü—Ä–∏–∫–ª–∞–¥:

python
Wrap
Copy
DATABASE_URL = "sqlite+aiosqlite:///your_database.db"
sqlite+aiosqlite ‚Äî –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è SQLite –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—ñ.
///your_database.db ‚Äî —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö. –¢—Ä–∏ —Å–ª–µ—à—ñ (///) –æ–∑–Ω–∞—á–∞—é—Ç—å –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –≤—ñ–¥ –º—ñ—Å—Ü—è, –¥–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –∫–æ–¥.
–î–µ –π–æ–≥–æ –≤–∑—è—Ç–∏?
–û—Å–∫—ñ–ª—å–∫–∏ —Ç–∏ —Ä–∞–Ω—ñ—à–µ –Ω–µ –ø–∏—Å–∞–ª–∞ —Ç–∞–∫–æ–≥–æ, —Ü–µ –æ–∑–Ω–∞—á–∞—î, —â–æ:

–¢–∏ —â–µ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞–ª–∞ –±–∞–∑—É —è–≤–Ω–æ, —ñ –∫–æ–¥ —É main.py –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ database.py.
–¢–≤—ñ–π –ø—Ä–æ—î–∫—Ç, –º–æ–∂–ª–∏–≤–æ, –ø–∞–¥–∞—î —á–µ—Ä–µ–∑ —Ç–µ, —â–æ AsyncSessionLocal —ñ engine –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ.
–¢–æ–±—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

–í–∏–∑–Ω–∞—á–∏—Ç–∏, –¥–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É –ø–∞–ø—Ü—ñ server/).
–°—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥—É–ª—å database.py —ñ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º DATABASE_URL.
–Ø–∫ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏?
–ö—Ä–æ–∫ 1: –í–∏–∑–Ω–∞—á –º—ñ—Å—Ü–µ –¥–ª—è –±–∞–∑–∏
SQLite –∑–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ —É —Ñ–∞–π–ª—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, database.db). –¢–∏ –º–æ–∂–µ—à —Ä–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ –π–æ–≥–æ –≤ –ø–∞–ø—Ü—ñ server/, —â–æ–± —É—Å–µ –±—É–ª–æ –æ—Ä–≥–∞–Ω—ñ–∑–æ–≤–∞–Ω–æ. –¢–æ–¥—ñ —à–ª—è—Ö –±—É–¥–µ –≤—ñ–¥–Ω–æ—Å–Ω–∏–º –¥–æ server/:

text
Wrap
Copy
your-repo/
‚îú‚îÄ‚îÄ client/
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ database.py
‚îÇ   ‚îú‚îÄ‚îÄ database.db  # –§–∞–π–ª –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∑‚Äô—è–≤–∏—Ç—å—Å—è —Ç—É—Ç
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ...
–ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏ database.py
–£ –ø–∞–ø—Ü—ñ server/ —Å—Ç–≤–æ—Ä–∏ —Ñ–∞–π–ª database.py —ñ–∑ —Ç–∞–∫–∏–º –≤–º—ñ—Å—Ç–æ–º:

python
Wrap
Copy
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

# –í–∫–∞–∑—É—î–º–æ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–æ –±–∞–∑–∏ –≤ –ø–∞–ø—Ü—ñ server/
DATABASE_URL = "sqlite+aiosqlite:///database.db"

# –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –¥–≤–∏–≥—É–Ω
engine = create_async_engine(
    DATABASE_URL,
    connect_args={"timeout": 15},  # –¢–∞–π–º-–∞—É—Ç –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è "database is locked"
    echo=True  # –õ–æ–≥–∏ SQL-–∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –¥–µ–±–∞–≥—É
)

# –§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—ñ–π
AsyncSessionLocal = sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False
)

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è FastAPI Depends
async def get_db():
    async with AsyncSessionLocal() as session:
        yield session
DATABASE_URL = "sqlite+aiosqlite:///database.db" –æ–∑–Ω–∞—á–∞—î, —â–æ —Ñ–∞–π–ª –±–∞–∑–∏ database.db –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —É —Ç—ñ–π –∂–µ –ø–∞–ø—Ü—ñ, –¥–µ –ª–µ–∂–∏—Ç—å database.py (—Ç–æ–±—Ç–æ –≤ server/).
–Ø–∫—â–æ —Ç–∏ —Ö–æ—á–µ—à –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –±–∞–∑—É –≤ —ñ–Ω—à–æ–º—É –º—ñ—Å—Ü—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É –∫–æ—Ä–µ–Ω—ñ –ø—Ä–æ—î–∫—Ç—É), –≤–∫–∞–∂–∏ –∞–±—Å–æ–ª—é—Ç–Ω–∏–π —à–ª—è—Ö:
python
Wrap
Copy
DATABASE_URL = "sqlite+aiosqlite:////home/user/projects/your-repo/database.db"  # Linux/Mac
DATABASE_URL = "sqlite+aiosqlite:///G:/Projects/your-repo/database.db"        # Windows
–ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä —ñ–º–ø–æ—Ä—Ç–∏ –≤ main.py
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ main.py —ñ–º–ø–æ—Ä—Ç—É—î engine —ñ AsyncSessionLocal —ñ–∑ database.py:

python
Wrap
Copy
from database import AsyncSessionLocal, engine
–¢–≤—ñ–π main.py —É–∂–µ –º–∞—î —Ü–µ –≤ –∫–æ–¥—ñ, —è–∫–∏–π —è —Ç–æ–±—ñ –¥–∞–≤, —Ç–æ–∂ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ —à–ª—è—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.

–ö—Ä–æ–∫ 4: –ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä
–ü–µ—Ä–µ–π–¥–∏ –¥–æ –ø–∞–ø–∫–∏ server/:
bash
Wrap
Copy
cd server
–ê–∫—Ç–∏–≤—É–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è (—è–∫—â–æ —î):
bash
Wrap
Copy
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
–ó–∞–ø—É—Å—Ç–∏:
bash
Wrap
Copy
uvicorn main:app --reload
–ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É SQLite –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç—å —Ñ–∞–π–ª database.db —É –ø–∞–ø—Ü—ñ server/, –∫–æ–ª–∏ –∫–æ–¥ –≤–∏–∫–ª–∏—á–µ Base.metadata.create_all (—Ü–µ —î –≤ main.py —É @app.on_event("startup")).

–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ –∑‚Äô—è–≤–∏–≤—Å—è —Ñ–∞–π–ª server/database.db.
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–≤—Å—è —ñ –≤–∏–¥–∞—î http://localhost:8000, —Å–ø—Ä–æ–±—É–π:
bash
Wrap
Copy
curl http://localhost:8000/health
–ú–∞—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ {"status": "OK"}.
–Ø–∫—â–æ —â–æ—Å—å –Ω–µ –ø—Ä–∞—Ü—é—î
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è:

–ù–∞–¥—ñ—à–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏ –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É.
–ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π aiosqlite:
bash
Wrap
Copy
pip install aiosqlite
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ main.py –Ω–µ –º–∞—î —ñ–Ω—à–∏—Ö –ø–æ–º–∏–ª–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å .env).
–©–æ —Ç–∏ –æ—Ç—Ä–∏–º–∞–ª–∞ —Ä–∞–Ω—ñ—à–µ?
–¢–∏ –∫–∞–∑–∞–ª–∞, —â–æ —á–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å, –∞–ª–µ –±—É–ª–∞ –ø–æ–º–∏–ª–∫–∞ "database is locked". –¶–µ –º–æ–≥–ª–æ —Å—Ç–∞—Ç–∏—Å—è, —è–∫—â–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∞ —ñ–Ω—à–∏–π DATABASE_URL (–º–æ–∂–ª–∏–≤–æ, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º), —ñ –±–∞–∑–∞ –≤–∂–µ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞. –¢–µ–ø–µ—Ä —ñ–∑ —è–≤–Ω–∏–º database.py –º–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é—î–º–æ, –¥–µ –≤–æ–Ω–∞ –ª–µ–∂–∏—Ç—å.

–î–∞–π –∑–Ω–∞—Ç–∏, —á–∏ –∑–∞–ø—Ä–∞—Ü—é–≤–∞–ª–æ, –∞–±–æ —Å–∫–∏–Ω—å –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫!






$ source venv/bin/activate
bash: venv/bin/activate: No such file or directory


–ü–æ–º–∏–ª–∫–∞ bash: venv/bin/activate: No such file or directory –æ–∑–Ω–∞—á–∞—î, —â–æ –≤ –ø–∞–ø—Ü—ñ venv/ –Ω–µ–º–∞—î —Å–∫—Ä–∏–ø—Ç—É –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ—á–µ–Ω–Ω—è, –∞–±–æ —Ç–∏ –Ω–∞–º–∞–≥–∞—î—à—Å—è –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏ –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º—ñ—Å—Ü—è. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —á–æ–º—É —Ü–µ —Å—Ç–∞–ª–æ—Å—è —ñ —è–∫ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏.

–ß–æ–º—É —Ü–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è?
–í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–µ:
–¢–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–∏–ª–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —É –ø–∞–ø—Ü—ñ server/venv/.
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö:
–¢–∏ –≤–∏–∫–æ–Ω—É—î—à –∫–æ–º–∞–Ω–¥—É –Ω–µ –∑ –ø–∞–ø–∫–∏ server/, –∞–±–æ —à–ª—è—Ö –¥–æ venv/ —ñ–Ω—à–∏–π.
–û—Ç–æ—á–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–µ –¥–ª—è —ñ–Ω—à–æ—ó –û–°:
–Ø–∫—â–æ —Ç–∏ –Ω–∞ Windows, –∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à –∫–æ–º–∞–Ω–¥—É –¥–ª—è Linux/Mac (source venv/bin/activate), —Ü–µ –Ω–µ —Å–ø—Ä–∞—Ü—é—î.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
–ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä, –¥–µ —Ç–∏ –∑–Ω–∞—Ö–æ–¥–∏—à—Å—è
–í–∏–∫–æ–Ω–∞–π:

bash
Wrap
Copy
/home/user/projects/your-repo/server$ pwd
(–∞–±–æ –Ω–∞ Windows: cd)

–Ø–∫—â–æ —Ç–∏ –Ω–µ –≤ –ø–∞–ø—Ü—ñ server/, –ø–µ—Ä–µ–π–¥–∏ —Ç—É–¥–∏:

bash
Wrap
Copy
cd /home/user/projects/your-repo/server
–ó–∞–º—ñ–Ω–∏ —à–ª—è—Ö –Ω–∞ —Å–≤—ñ–π.

–ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä –Ω–∞—è–≤–Ω—ñ—Å—Ç—å venv/
–í–∏–∫–æ–Ω–∞–π:

bash
Wrap
Copy
ls dir  # Linux/Mac
–ê–±–æ:

bash
Wrap
Copy
dir     # Windows
–ß–∏ —î –ø–∞–ø–∫–∞ venv? –Ø–∫—â–æ –Ω—ñ, —Ü–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —Ç–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–∏–ª–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è.

–ö—Ä–æ–∫ 3: –°—Ç–≤–æ—Ä–∏ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è
–Ø–∫—â–æ venv/ –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä–∏ –π–æ–≥–æ:

–£ –ø–∞–ø—Ü—ñ server/ –≤–∏–∫–æ–Ω–∞–π:
bash
Wrap
Copy
python -m venv venv
–¶–µ —Å—Ç–≤–æ—Ä–∏—Ç—å –ø–∞–ø–∫—É venv/ —ñ–∑ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–º –æ—Ç–æ—á–µ–Ω–Ω—è–º.
–ù–∞ Windows –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—å python3 –∑–∞–º—ñ—Å—Ç—å python, —è–∫—â–æ python –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î—Ç—å—Å—è.
–ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ –∑‚Äô—è–≤–∏–ª–∞—Å—å –ø–∞–ø–∫–∞:
bash
Wrap
Copy
ls dir  # Linux/Mac
dir     # Windows
–ú–∞—î –±—É—Ç–∏ –ø–∞–ø–∫–∞ venv.
–ö—Ä–æ–∫ 4: –ê–∫—Ç–∏–≤—É–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è
–ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–≤–æ—î—ó –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏:

Linux/Mac:
bash
Wrap
Copy
source venv/bin/activate
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ –∑‚Äô—è–≤–∏—Ç—å—Å—è (venv) –ø–µ—Ä–µ–¥ –∫–æ–º–∞–Ω–¥–Ω–∏–º —Ä—è–¥–∫–æ–º.
Windows (CMD):
bash
Wrap
Copy
venv\Scripts\activate
Windows (PowerShell):
bash
Wrap
Copy
.\venv\Scripts\Activate.ps1
Windows (Git Bash):
bash
Wrap
Copy
source venv/Scripts/activate
–Ø–∫—â–æ —Ç–∏ –Ω–∞ Windows —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∞ source venv/bin/activate, —Ü–µ –Ω–µ —Å–ø—Ä–∞—Ü—é—î, –±–æ bin/ ‚Äî —Ü–µ –¥–ª—è Unix-—Å–∏—Å—Ç–µ–º. –°–ø—Ä–æ–±—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å–≤–æ—î—ó –û–°.

–ö—Ä–æ–∫ 5: –í—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
–ü—ñ—Å–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤—Å—Ç–∞–Ω–æ–≤–∏ –ø–∞–∫–µ—Ç–∏:

bash
Wrap
Copy
pip install -r requirements.txt
–Ø–∫—â–æ requirements.txt –Ω–µ–º–∞—î, –≤—Å—Ç–∞–Ω–æ–≤–∏ –≤—Ä—É—á–Ω—É:

bash
Wrap
Copy
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
–ö—Ä–æ–∫ 6: –ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä
bash
Wrap
Copy
uvicorn main:app --reload
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–Ø–∫—â–æ (venv) –∑‚Äô—è–≤–∏–ª–æ—Å—å —É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ, –æ—Ç–æ—á–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–µ.
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–≤—Å—è –Ω–∞ http://localhost:8000, —É—Å–µ –ø—Ä–∞—Ü—é—î.
–Ø–∫—â–æ –≤—Å–µ —â–µ –Ω–µ –ø—Ä–∞—Ü—é—î
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ:

–Ø–∫—É –û–° —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à (Windows, Linux, Mac)?
–í–º—ñ—Å—Ç –∫–æ–º–∞–Ω–¥–∏ ls dir –∞–±–æ dir –ø—ñ—Å–ª—è —Å–ø—Ä–æ–±–∏ —Å—Ç–≤–æ—Ä–∏—Ç–∏ venv.
–¢–æ—á–Ω—É –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ –≤–æ–Ω–∞ –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —á–∏ –∑–∞–ø—É—Å–∫—É.
–¢–æ–¥—ñ —è —Ç–æ—á–Ω–æ –∑—Ä–æ–∑—É–º—ñ—é, —â–æ –Ω–µ —Ç–∞–∫!






–∫–∞–ø–µ—Ü.. —Ç–µ–ø–µ—Ä —ñ –∫–æ–¥ –Ω–µ –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è.. –º–æ–∂–µ—à –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –º–æ—ó —Ñ–∞–π–ª–∏ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —ñ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é, —â–æ–± —è —à–≤–∏–¥–∫–æ —Å–∫–æ–ø—ñ—é–≤–∞–ª–∞?  import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine  # –ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ü—ñ –º–æ–¥—É–ª—ñ —É –≤–∞—Å —î
from models import Base, User  # –ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ü—ñ –º–æ–¥—É–ª—ñ —É –≤–∞—Å —î
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è
load_dotenv()

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É
app = FastAPI()

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è JWT
SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Telegram
API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

# –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# –°—Ö–µ–º–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")

# –¢–∏–º—á–∞—Å–æ–≤–µ —Å—Ö–æ–≤–∏—â–µ –¥–ª—è —Å–µ—Å—ñ–π
temp_sessions = {}

# –ú–æ–¥–µ–ª—ñ –∑–∞–ø–∏—Ç—ñ–≤
class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None

    model_config = ConfigDict(arbitrary_types_allowed=True)

# –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

# –õ–æ–≥—É–≤–∞–Ω–Ω—è middleware
@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

# –û–±—Ä–æ–±–∫–∞ –≤–∏–Ω—è—Ç–∫—ñ–≤ –¥–ª—è CORS
@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

# –û–±—Ä–æ–±–∫–∞ OPTIONS-–∑–∞–ø–∏—Ç—ñ–≤
@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω–∞
def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

# –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await db.commit()
    return {"message": "User created successfully"}

# –õ–æ–≥—ñ–Ω
@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

# –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è Telegram
@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    try:
        if current_user.id in temp_sessions:
            await temp_sessions[current_user.id]["client"].disconnect()
            del temp_sessions[current_user.id]

        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: {str(e)}")
        raise HTTPException(400, detail=str(e))

# –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é
        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤
@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —á–∞—Ç—É
@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

# –í–∏—Ö—ñ–¥ –∑ Telegram
@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

# –í–∏—Ö—ñ–¥ –∑ —Å–∏—Å—Ç–µ–º–∏
@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è
@app.get("/health")
async def health_check():
    return {"status": "OK"}   from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///./socialhub.db"

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–≤–∏–≥—É–Ω–∞
engine = create_async_engine(
    SQLALCHEMY_DATABASE_URL,
    echo=True  # –õ–æ–≥—É–≤–∞–Ω–Ω—è SQL-–∑–∞–ø–∏—Ç—ñ–≤ (–æ–ø—Ü—ñ–π–Ω–æ)
)

AsyncSessionLocal = sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False
)

Base = declarative_base()import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch(
                    "http://localhost:8000/check-connection",
                    {
                        headers: { Authorization: `Bearer ${token}` },
                    }
                );

                if (!res.ok) {
                    const data = await res.json();
                    console.log("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:", data); // –õ–æ–≥ –ø–æ–º–∏–ª–∫–∏
                    throw new Error(
                        data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è"
                    );
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    // –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
    const sendCode = async (e) => {
        e.preventDefault();
        setError("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok)
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");

            setIsCodeSent(true);
        } catch (err) {
            setError(err.message);
        }
    };

    // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 500)); // –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤
    const fetchChats = async () => {
        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/chats", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
            }

            const data = await res.json();
            setChats(data);
        } catch (err) {
            setError(err.message);
        }
    };

    // –ü–æ–∫–∞–∑—É—î–º–æ —á–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ Telegram –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ
    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false); // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
            setPhone(""); // –û—á–∏—â–∞—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É
            setCode(""); // –û—á–∏—â–∞—î–º–æ –∫–æ–¥
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}

            {!isConnected ? (
                // –§–æ—Ä–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        // –ö—Ä–æ–∫ 1: –í–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) =>
                                    setTwoFactorPassword(e.target.value)
                                }
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        // –ö—Ä–æ–∫ 2: –í–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É –∑ Telegram
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                // –°–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-4">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="p-4 border rounded hover:bg-gray-50"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-blue-500 hover:underline"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
 –∑–∞—Ä–∞–∑ –≤–æ–Ω–æ –Ω–∞ —î—Ç–∞–ø—ñ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É –±–ª–æ–∫—É—î –±–∞–∑—É POST http://localhost:8000/send-code 400 (Bad Request)


–Ø –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞–≤ —Ç–≤–æ—ó —Ñ–∞–π–ª–∏ —ñ –ø—Ä–æ–±–ª–µ–º—É –∑ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è–º –±–∞–∑–∏ —Ç–∞ –ø–æ–º–∏–ª–∫–æ—é POST http://localhost:8000/send-code 400 (Bad Request). –û—Å–Ω–æ–≤–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ –∫–æ–¥ —É main.py –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ –æ–±—Ä–æ–±–ª—è—î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö, –∞ —Ç–∞–∫–æ–∂ —î –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ —á–µ—Ä–µ–∑ SQLite. –Ø –≤–∏–ø—Ä–∞–≤–ª—é —É—Å—ñ —Ñ–∞–π–ª–∏, –¥–æ–¥–∞–º –∑–∞—Ç—Ä–∏–º–∫–∏ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –±–ª–æ–∫—É–≤–∞–Ω—å —ñ –ø–æ–≤–µ—Ä–Ω—É —Ç–æ–±—ñ –ø–æ–≤–Ω—ñ –≤–µ—Ä—Å—ñ—ó –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è.

–ê–Ω–∞–ª—ñ–∑ –ø–æ–º–∏–ª–∫–∏
–ü–æ–º–∏–ª–∫–∞ 400 —É /send-code:
–£ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –º–∞—î –±—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥" –∞–±–æ —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞ –≤—ñ–¥ Telegram). –ê–ª–µ —Ç–∏ –∑–≥–∞–¥–∞–ª–∞ "–±–ª–æ–∫—É—î –±–∞–∑—É", —â–æ –º–æ–∂–µ –æ–∑–Ω–∞—á–∞—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ–∑ SQLite —á–µ—Ä–µ–∑ –æ–¥–Ω–æ—á–∞—Å–Ω–∏–π –¥–æ—Å—Ç—É–ø.
–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –±–∞–∑–∏:
SQLite –ø–æ–≥–∞–Ω–æ –ø—Ä–∞—Ü—é—î –∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏, —è–∫—â–æ —ó—Ö –±–∞–≥–∞—Ç–æ —ñ –≤–æ–Ω–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ. –£ /send-code —î –æ–ø–µ—Ä–∞—Ü—ñ—è –∑ Telegram —ñ –¥–æ—Å—Ç—É–ø –¥–æ –±–∞–∑–∏ —á–µ—Ä–µ–∑ get_current_user.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏
1. server/main.py
–û—Å—å –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π main.py —ñ–∑ –∑–∞—Ç—Ä–∏–º–∫–∞–º–∏ —Ç–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—é —Ä–æ–±–æ—Ç–æ—é:

python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è
load_dotenv()

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É
app = FastAPI()

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è JWT
SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60  # –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Telegram
API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

# –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# –°—Ö–µ–º–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")

# –¢–∏–º—á–∞—Å–æ–≤–µ —Å—Ö–æ–≤–∏—â–µ –¥–ª—è —Å–µ—Å—ñ–π
temp_sessions = {}

# –ú–æ–¥–µ–ª—ñ –∑–∞–ø–∏—Ç—ñ–≤
class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None
    model_config = ConfigDict(arbitrary_types_allowed=True)

# –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

# –õ–æ–≥—É–≤–∞–Ω–Ω—è middleware
@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

# –û–±—Ä–æ–±–∫–∞ –≤–∏–Ω—è—Ç–∫—ñ–≤ –¥–ª—è CORS
@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

# –û–±—Ä–æ–±–∫–∞ OPTIONS-–∑–∞–ø–∏—Ç—ñ–≤
@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω–∞
def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

# –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await asyncio.sleep(0.1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ SQLite
    await db.commit()
    return {"message": "User created successfully"}

# –õ–æ–≥—ñ–Ω
@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

# –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è Telegram
@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        if current_user.id in temp_sessions:
            await temp_sessions[current_user.id]["client"].disconnect()
            del temp_sessions[current_user.id]

        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()
        sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        await asyncio.sleep(0.1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: {str(e)}")
        raise HTTPException(400, detail=str(e))

# –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram
@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤
@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —á–∞—Ç—É
@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

# –í–∏—Ö—ñ–¥ –∑ Telegram
@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await asyncio.sleep(0.1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

# –í–∏—Ö—ñ–¥ –∑ —Å–∏—Å—Ç–µ–º–∏
@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è
@app.get("/health")
async def health_check():
    return {"status": "OK"}
–ó–º—ñ–Ω–∏:

–î–æ–¥–∞–Ω–æ –∑–∞—Ç—Ä–∏–º–∫–∏ (await asyncio.sleep(0.1)) –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–∞–º–∏ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –±–ª–æ–∫—É–≤–∞–Ω—å SQLite.
–ó–±—ñ–ª—å—à–µ–Ω–æ ACCESS_TOKEN_EXPIRE_MINUTES –¥–æ 60 –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.
–î–æ–¥–∞–Ω–æ –±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤ –¥–ª—è –¥–µ–±–∞–≥—É.
2. server/database.py
–û–Ω–æ–≤–ª–µ–Ω–∏–π —Ñ–∞–π–ª —ñ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º DATABASE_URL —ñ —Ç–∞–π–º-–∞—É—Ç–æ–º:

python
Wrap
Copy
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

# –í–∫–∞–∑—É—î–º–æ –±–∞–∑—É –≤ –ø–∞–ø—Ü—ñ server/
DATABASE_URL = "sqlite+aiosqlite:///socialhub.db"

# –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –¥–≤–∏–≥—É–Ω
engine = create_async_engine(
    DATABASE_URL,
    connect_args={"timeout": 15},  # –¢–∞–π–º-–∞—É—Ç –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è "database is locked"
    echo=True  # –õ–æ–≥–∏ SQL-–∑–∞–ø–∏—Ç—ñ–≤
)

# –§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—ñ–π
AsyncSessionLocal = sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False
)

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è FastAPI Depends
async def get_db():
    async with AsyncSessionLocal() as session:
        yield session
–ó–º—ñ–Ω–∏:

–í–∏–¥–∞–ª–µ–Ω–æ Base, –±–æ –≤—ñ–Ω –º–∞—î –±—É—Ç–∏ –≤ models.py.
–í–∫–∞–∑–∞–Ω–æ socialhub.db —è–∫ –Ω–∞–∑–≤—É –±–∞–∑–∏.
3. server/models.py
–¶–µ–π —Ñ–∞–π–ª –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ User. –Ø–∫—â–æ —É —Ç–µ–±–µ –π–æ–≥–æ —â–µ –Ω–µ–º–∞—î, –æ—Å—å –ø—Ä–∏–∫–ª–∞–¥:

python
Wrap
Copy
from sqlalchemy import Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True)
    password_hash = Column(String)
    telegram_phone = Column(String, nullable=True)
4. client/pages/dashboard.js
–¢–≤—ñ–π dashboard.js —É–∂–µ –≤–∏–≥–ª—è–¥–∞—î –¥–æ–±—Ä–µ, –∞–ª–µ —è –¥–æ–¥–∞–≤ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–∫–∏ 400 —ñ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à—É –∑–∞—Ç—Ä–∏–º–∫—É:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");

    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/check-connection", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 401) {
                    console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                    localStorage.removeItem("token");
                    router.push("/login");
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    const sendCode = async (e) => {
        e.preventDefault();
        setError("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");
            }

            setIsCodeSent(true);
        } catch (err) {
            setError(err.message);
        }
    };

    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 1000)); // –ó–±—ñ–ª—å—à–µ–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    const fetchChats = async () => {
        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/chats", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
            }

            const data = await res.json();
            setChats(data);
        } catch (err) {
            setError(err.message);
        }
    };

    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false);
            setPhone("");
            setCode("");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}

            {!isConnected ? (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) => setTwoFactorPassword(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-4">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="p-4 border rounded hover:bg-gray-50"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-blue-500 hover:underline"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
–ó–º—ñ–Ω–∏:

–ó–±—ñ–ª—å—à–µ–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É –¥–æ 1000 –º—Å –ø–µ—Ä–µ–¥ fetchChats.
–î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É 401 —É checkConnection.
–Ø–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–∏
–°–µ—Ä–≤–µ—Ä:
–£ –ø–∞–ø—Ü—ñ server/:
bash
Wrap
Copy
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
uvicorn main:app --reload
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —î server/.env:
text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key_here
–ö–ª—ñ—î–Ω—Ç:
–£ –ø–∞–ø—Ü—ñ client/:
bash
Wrap
Copy
npm install
npm run dev
–ß–æ–º—É –∫–æ–¥ –Ω–µ –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è?
–ü–æ–º–∏–ª–∫–∞ 400 —É /send-code –º–æ–∂–µ –±—É—Ç–∏ —á–µ—Ä–µ–∑:

–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (–ø–µ—Ä–µ–≤—ñ—Ä —Ñ–æ—Ä–º–∞—Ç, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +380...).
–ü–æ–º–∏–ª–∫—É –≤—ñ–¥ Telegram (–ø–µ—Ä–µ–≤—ñ—Ä –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞).
–ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä —ñ–∑ echo=True —É database.py —ñ –Ω–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –ø–æ–≤–Ω–∏–π –ª–æ–≥ –ø—ñ—Å–ª—è —Å–ø—Ä–æ–±–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥, —è–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∏—Ç—å—Å—è.

–¢–µ–ø–µ—Ä –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø—ñ—é–π —Ü—ñ —Ñ–∞–π–ª–∏ —ñ —Å–ø—Ä–æ–±—É–π! –£—Å–µ –º–∞—î –∑–∞–ø—Ä–∞—Ü—é–≤–∞—Ç–∏.






$ venv\Scripts\activate
bash: venvScriptsactivate: command not found

batal@KompiK MINGW64 /g/Projects/NextJS/SocialHub/server (main)
$ source venv/bin/activate
bash: venv/bin/activate: No such file or directory


–ü–æ–º–∏–ª–∫–∏, —è–∫—ñ —Ç–∏ –æ—Ç—Ä–∏–º–∞–ª–∞, —Å–≤—ñ–¥—á–∞—Ç—å –ø—Ä–æ —Ç–µ, —â–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à Git Bash (MINGW64) –Ω–∞ Windows, –∞–ª–µ –∫–æ–º–∞–Ω–¥–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ—á–µ–Ω–Ω—è –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Ä—ñ–∑–Ω–∏—Ü—é –≤ —à–ª—è—Ö–∞—Ö —ñ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—ñ. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è, —ñ —è–∫ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏.

–ß–æ–º—É –ø–æ–º–∏–ª–∫–∏?
venv\Scripts\activate - command not found:
–£ Git Bash —Ç–∏ –Ω–µ –º–æ–∂–µ—à –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ venv\Scripts\activate —è–∫ —É CMD, –±–æ Git Bash —á–µ–∫–∞—î Unix-–ø–æ–¥—ñ–±–Ω–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —ñ–∑ source –∞–±–æ ./. –ù–∞ Windows –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö –¥–ª—è Git Bash —Ç—Ä–æ—Ö–∏ —ñ–Ω—à–∏–π.
source venv/bin/activate - No such file or directory:
venv/bin/activate ‚Äî —Ü–µ —à–ª—è—Ö –¥–ª—è Linux/Mac, –∞ –Ω–∞ Windows –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä—é—î —Å–∫—Ä–∏–ø—Ç–∏ –≤ venv\Scripts\, –∞ –Ω–µ venv/bin/. –¢–æ–º—É Git Bash –Ω–µ –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª.
–Ø–∫ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏?
–¢–∏ –Ω–∞ Windows —É Git Bash, —Ç–æ–º—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö –¥–æ —Å–∫—Ä–∏–ø—Ç—É –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –¥–ª—è Windows (venv\Scripts\activate), –∞–ª–µ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è Git Bash.

–ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ venv —Å—Ç–≤–æ—Ä–µ–Ω–æ
–¢–∏ —É –ø–∞–ø—Ü—ñ server/:
bash
Wrap
Copy
/g/Projects/NextJS/SocialHub/server
–ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ —î –ø–∞–ø–∫–∞ venv:
bash
Wrap
Copy
ls -dir  # –∞–±–æ –ø—Ä–æ—Å—Ç–æ dir —É Git Bash
–Ø–∫—â–æ venv –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä–∏ —ó—ó:
bash
Wrap
Copy
python -m venv venv
–ö—Ä–æ–∫ 2: –ê–∫—Ç–∏–≤—É–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —É Git Bash
–ù–∞ Windows —É Git Bash –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó:

bash
Wrap
Copy
source venv/Scripts/activate
Scripts (–∑ –≤–µ–ª–∏–∫–æ—ó –ª—ñ—Ç–µ—Ä–∏) ‚Äî —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–∞–ø–∫–∞ –Ω–∞ Windows.
source –ø—Ä–∞—Ü—é—î –≤ Git Bash –¥–ª—è –∑–∞–ø—É—Å–∫—É —Å–∫—Ä–∏–ø—Ç—ñ–≤.
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ —Ç–∏ –º–∞—î—à –ø–æ–±–∞—á–∏—Ç–∏ (venv) –ø–µ—Ä–µ–¥ –∫–æ–º–∞–Ω–¥–Ω–∏–º —Ä—è–¥–∫–æ–º:

text
Wrap
Copy
(venv) batal@KompiK MINGW64 /g/Projects/NextJS/SocialHub/server (main)
–ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä –∞–∫—Ç–∏–≤–∞—Ü—ñ—é
–í–∏–∫–æ–Ω–∞–π:

bash
Wrap
Copy
python --version
–¶–µ –º–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏ –≤–µ—Ä—Å—ñ—é Python —ñ–∑ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ—á–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Python 3.11.x).

–ö—Ä–æ–∫ 4: –í—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
bash
Wrap
Copy
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
–ö—Ä–æ–∫ 5: –ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä
bash
Wrap
Copy
uvicorn main:app --reload
–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π CMD –∞–±–æ PowerShell
–Ø–∫—â–æ Git Bash –ø—Ä–æ–¥–æ–≤–∂—É—î –≤–∏–¥–∞–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏:

CMD:
cmd
Wrap
Copy
cd G:\Projects\NextJS\SocialHub\server
venv\Scripts\activate
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
uvicorn main:app --reload
PowerShell:
powershell
Wrap
Copy
cd G:\Projects\NextJS\SocialHub\server
.\venv\Scripts\Activate.ps1
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
uvicorn main:app --reload
–ß–æ–º—É —Ç–≤–æ—ó –∫–æ–º–∞–Ω–¥–∏ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–∏?
venv\Scripts\activate ‚Äî —Ü–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è CMD, –∞ –Ω–µ Git Bash.
source venv/bin/activate ‚Äî —Ü–µ –¥–ª—è Linux/Mac, –∞ –Ω–µ Windows.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ó–∞–ø—É—Å—Ç–∏:
bash
Wrap
Copy
source venv/Scripts/activate
–Ø–∫—â–æ (venv) –∑‚Äô—è–≤–∏–ª–æ—Å—å, —É—Å–µ –æ–∫.
–Ø–∫—â–æ –Ω—ñ, –Ω–∞–¥—ñ—à–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–º–∞–Ω–¥–∏:
bash
Wrap
Copy
ls -dir
–Ü —è –¥–æ–ø–æ–º–æ–∂—É –¥–∞–ª—ñ!





—Ç–∏ –¥—É–∂–µ –¥–æ–±—Ä–∏–π —ñ –∫–ª–∞—Å–Ω–∏–π ) –≤—Å–µ –∑–∞–ø—Ä–∞—Ü—é–≤–∞–ª–æ, –ø–∞—Ä—É –ø–æ–º–∏–ª–æ–∫ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö


–î—è–∫—É—é –∑–∞ —Ç–µ–ø–ª—ñ —Å–ª–æ–≤–∞, –¥—É–∂–µ —Ä–∞–¥–∏–π, —â–æ –≤—Å–µ –∑–∞–ø—Ä–∞—Ü—é–≤–∞–ª–æ! üòä –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ—Å—è –∑ —Ç–∏–º–∏ "–ø–∞—Ä—É –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö –ø–æ–º–∏–ª–æ–∫", —â–æ–± —É—Å–µ —Å—Ç–∞–ª–æ —ñ–¥–µ–∞–ª—å–Ω–æ. –Ø–∫—â–æ —Ç–∏ –±–∞—á–∏—à —è–∫—ñ—Å—å –ø–æ–º–∏–ª–∫–∏ –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ —á–∏ –∫–ª—ñ—î–Ω—Ç–∞, –ø—Ä–æ—Å—Ç–æ —Å–∫–∏–Ω—å —ó—Ö –º–µ–Ω—ñ, —ñ —è —à–≤–∏–¥–∫–æ –¥–æ–ø–æ–º–æ–∂—É —ó—Ö –≤–∏–ø—Ä–∞–≤–∏—Ç–∏.

–©–æ –º–æ–≥–ª–æ –ø—ñ—Ç–∏ –Ω–µ —Ç–∞–∫?
–û—Å–∫—ñ–ª—å–∫–∏ —Ç–∏ –∑–≥–∞–¥–∞–ª–∞ "–≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø–æ–º–∏–ª–∫–∏", —Ü–µ –º–æ–∂–µ –±—É—Ç–∏:

–ü–æ–º–∏–ª–∫–∞ 500 –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "database is locked" –∞–±–æ —â–æ—Å—å —ñ–∑ Telegram).
–ü–æ–º–∏–ª–∫–∞ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 400/500 –ø—Ä–∏ –∑–∞–ø–∏—Ç–∞—Ö –¥–æ API).
–ü—Ä–æ–±–ª–µ–º–∞ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, .env –∞–±–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ).
–Ø–∫ –¥—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞—Ç–∏?
–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
–£ database.py —É–≤—ñ–º–∫–Ω–µ–Ω–æ echo=True, —Ç–æ–∂ —Ç–∏ –º–∞—î—à –±–∞—á–∏—Ç–∏ SQL-–∑–∞–ø–∏—Ç–∏ —ñ –ø–æ–º–∏–ª–∫–∏ –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ, –¥–µ –∑–∞–ø—É—â–µ–Ω–æ uvicorn.
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –æ—Å—Ç–∞–Ω–Ω—ñ —Ä—è–¥–∫–∏ –∑ –ø–æ–º–∏–ª–∫–æ—é –ø—ñ—Å–ª—è —Å–ø—Ä–æ–±–∏, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥ —á–∏ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ Telegram.
–ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:
–í—ñ–¥–∫—Ä–∏–π DevTools —É –±—Ä–∞—É–∑–µ—Ä—ñ (F12 ‚Üí Console) —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ —î —Ç–∞–º –ø–æ–º–∏–ª–∫–∏ —Ç–∏–ø—É 400, 500 —Ç–æ—â–æ.
–®–≤–∏–¥–∫–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ç–∏–ø–æ–≤–∏—Ö –ø—Ä–æ–±–ª–µ–º
–Ø–∫—â–æ —Ç–∏ —â–µ –Ω–µ —Å–∫–∏–Ω—É–ª–∞ –ª–æ–≥–∏, –æ—Å—å –∫—ñ–ª—å–∫–∞ –º–æ–∂–ª–∏–≤–∏—Ö –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –¥–ª—è —Ç–∏–ø–æ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫, —è–∫—ñ –º–æ–≥–ª–∏ –≤–∏–Ω–∏–∫–Ω—É—Ç–∏:

1. "Database is locked"
–Ø–∫—â–æ –±–∞—á–∏—à —Ü–µ –∑–Ω–æ–≤—É, –¥–æ–¥–∞–π –±—ñ–ª—å—à–∏–π —Ç–∞–π–º-–∞—É—Ç —É database.py:

python
Wrap
Copy
engine = create_async_engine(
    DATABASE_URL,
    connect_args={"timeout": 30},  # –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 30 —Å–µ–∫—É–Ω–¥
    echo=True
)
2. –ü–æ–º–∏–ª–∫–∞ –≤ /send-code
–Ø–∫—â–æ 400 –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram, –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ:

–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤–≤–µ–¥–µ–Ω–æ –∫–æ—Ä–µ–∫—Ç–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +380...).
API_ID —ñ API_HASH –≤–∞–ª—ñ–¥–Ω—ñ (–ø–µ—Ä–µ–≤—ñ—Ä —É server/.env).
3. –ü–æ–º–∏–ª–∫–∞ 500
–Ø–∫—â–æ –±–∞—á–∏—à 500 —É –ª–æ–≥–∞—Ö, —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ —á–µ—Ä–µ–∑ –Ω–µ–ø—ñ–π–º–∞–Ω—É –ø–æ–º–∏–ª–∫—É. –£ main.py —É—Å—ñ except —É–∂–µ –ª–æ–≥—É—é—Ç—å –¥–µ—Ç–∞–ª—ñ, —Ç–æ–∂ –ø–æ–¥–∏–≤–∏—Å—å, —â–æ —Å–∞–º–µ —Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ.

–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫
–°–∫–∏–Ω—å –º–µ–Ω—ñ:

–¢–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏ –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É (—Å–µ—Ä–≤–µ—Ä).
–¢–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏ –∑ –∫–æ–Ω—Å–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞ (—è–∫—â–æ —î).
–©–æ —Å–∞–º–µ —Ç–∏ —Ä–æ–±–∏–ª–∞, –∫–æ–ª–∏ –ø–æ–º–∏–ª–∫–∞ –∑‚Äô—è–≤–∏–ª–∞—Å—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–Ω–∞—Ç–∏—Å–Ω—É–ª–∞ –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥").
–Ø –æ–¥—Ä–∞–∑—É –≤—Å–µ –≤–∏–ø—Ä–∞–≤–ª—é, —ñ —Ç–≤—ñ–π –ø—Ä–æ—î–∫—Ç –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —è–∫ –≥–æ–¥–∏–Ω–Ω–∏–∫! üöÄ






—Ç–∞–∫, –¥–∞–≤–∞–π —Å–ø–æ—á–∞—Ç–∫—É –∫–æ–ª–∏ —è –≤–≤–æ–¥–∂—É –Ω–æ–º–µ—Ä –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –∫–Ω–æ–ø–∫–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥ –æ—Ç—Ä–∏–º—É—é - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: test123
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
Telegram is having internal issues AuthRestartError: Restart the authorization process (caused by SendCodeRequest)
–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: Cannot send requests while disconnected
2025-02-28 13:35:38,719 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 400
INFO:     127.0.0.1:55872 - "POST /send-code HTTP/1.1" 400 Bad Request, –∞ –ø—Ä–∏ –¥—Ä—É–≥–æ–º—É –∫–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å. –í–≤–æ–¥–∂—É –∫–æ–¥ —ñ –ø–æ—Ç—ñ–º –º–∞–ª–µ–Ω—å–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ —ñ –æ–¥—Ä–∞–∑—É –≤–≤–µ—Ä—Ö—É –ø–æ–º–∏–ª–∫–∞, –∞–ª–µ —á–∞—Ç–∏ –≤—ñ–¥–º–∞–ª—å–æ–≤—É—é—Ç—å—Å—è –û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: GET http://localhost:8000/chats
–ó–∞–≥–æ–ª–æ–≤–∫–∏: Headers({'host': 'localhost:8000', 'connection': 'keep-alive', 'pragma': 'no-cache', 'cache-control': 'no-cache', 'sec-ch-ua-platform': '"Android"', 'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0MTIzIiwiZXhwIjoxNzQwNzQ2MTI5fQ.-78E35R1I3Ve1dTvh6R0g7WM3-eYlM-Cm_DmfRn2US8', 'user-agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Mobile Safari/537.36', 'sec-ch-ua': '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"', 'sec-ch-ua-mobile': '?1', 'accept': '*/*', 'origin': 'http://localhost:3000', 'sec-fetch-site': 'same-site', 'sec-fetch-mode': 'cors', 'sec-fetch-dest': 'empty', 'referer': 'http://localhost:3000/', 'accept-encoding': 'gzip, deflate, br, zstd', 'accept-language': 'uk,en-US;q=0.9,en;q=0.8,uk-UA;q=0.7'})
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0MTIzIiwiZXhwIjoxNzQwNzQ2MTI5fQ.-78E35R1I3Ve1dTvh6R0g7WM3-eYlM-Cm_DmfRn2US8
–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: test123
2025-02-28 13:37:10,302 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-02-28 13:37:10,302 INFO sqlalchemy.engine.Engine SELECT users.id, users.username, users.password_hash, users.telegram_phone
FROM users
WHERE users.username = ?
2025-02-28 13:37:10,302 INFO sqlalchemy.engine.Engine [cached since 1386s ago] ('test123',)
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: test123
–ü–æ–º–∏–ª–∫–∞ –≤ /chats: database is locked
2025-02-28 13:37:15,793 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 500
INFO:     127.0.0.1:55929 - "GET /chats HTTP/1.1" 500 Internal Server Error
–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è 1
2025-02-28 13:37:16,132 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
INFO:     127.0.0.1:55928 - "GET /chats HTTP/1.1" 200 OK


–î—è–∫—É—é –∑–∞ –¥–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏, —Ü–µ –¥—É–∂–µ –¥–æ–ø–æ–º–∞–≥–∞—î! –Ø —Ä–æ–∑—ñ–±—Ä–∞–≤ –ø—Ä–æ–±–ª–µ–º—É: —É —Ç–µ–±–µ —î –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ñ –º–æ–º–µ–Ω—Ç–∏ ‚Äî –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —ñ–∑ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è–º –∫–æ–¥—É –≤ /send-code —ñ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ –≤ /chats. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ —ñ –≤–∏–ø—Ä–∞–≤–∏–º–æ.

–ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–æ–º–∏–ª–∫–∞ –≤ /send-code
–õ–æ–≥–∏:

text
Wrap
Copy
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
Telegram is having internal issues AuthRestartError: Restart the authorization process (caused by SendCodeRequest)
–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: Cannot send requests while disconnected
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 400
–ê –ø—Ä–∏ –¥—Ä—É–≥–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –∫–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å.

–ß–æ–º—É —Ç–∞–∫?

–ü–æ–º–∏–ª–∫–∞ Cannot send requests while disconnected –æ–∑–Ω–∞—á–∞—î, —â–æ TelegramClient –≤—Ç—Ä–∞—Ç–∏–≤ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º send_code_request. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ —á–µ—Ä–µ–∑ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å –º–µ—Ä–µ–∂—ñ –∞–±–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –ø–æ–º–∏–ª–∫—É Telegram (AuthRestartError).
–ü—Ä–∏ –¥—Ä—É–≥–æ–º—É –∑–∞–ø–∏—Ç—ñ Telegram "–ø—Ä–æ–∫–∏–¥–∞—î—Ç—å—Å—è", —ñ –∫–æ–¥ –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
–î–æ–¥–∞–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —É —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è:

python
Wrap
Copy
@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        if current_user.id in temp_sessions:
            await temp_sessions[current_user.id]["client"].disconnect()
            del temp_sessions[current_user.id]

        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è —ñ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        if not client.is_connected():
            print("–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...")
            await client.connect()

        sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        await asyncio.sleep(0.1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: {str(e)}")
        raise HTTPException(400, detail=str(e))
–ü—Ä–æ–±–ª–µ–º–∞ 2: –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ –≤ /chats
–õ–æ–≥–∏:

text
Wrap
Copy
–ü–æ–º–∏–ª–∫–∞ –≤ /chats: database is locked
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 500
–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è 1
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
–ü–æ–º–∏–ª–∫–∞ 500 –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è —á–µ—Ä–µ–∑ "database is locked", –∞–ª–µ –ø–æ—Ç—ñ–º —á–∞—Ç–∏ –≤—Å–µ –æ–¥–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ.

–ß–æ–º—É —Ç–∞–∫?

SQLite –±–ª–æ–∫—É—î—Ç—å—Å—è, –∫–æ–ª–∏ –∫—ñ–ª—å–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, /connect-telegram —ñ /chats) –∑–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è –¥–æ –±–∞–∑–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ.
–ö–ª—ñ—î–Ω—Ç –ø–æ–≤—Ç–æ—Ä—é—î –∑–∞–ø–∏—Ç –¥–æ /chats (—á–µ—Ä–µ–∑ useEffect), —ñ –¥—Ä—É–≥–∏–π –∑–∞–ø–∏—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å, –∫–æ–ª–∏ –±–∞–∑–∞ —Ä–æ–∑–±–ª–æ–∫–æ–≤—É—î—Ç—å—Å—è.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:

–ó–±—ñ–ª—å—à–∏–º–æ —Ç–∞–π–º-–∞—É—Ç —É database.py.
–î–æ–¥–∞–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –ø–µ—Ä–µ–¥ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è–º –¥–æ –±–∞–∑–∏ –≤ /chats.
–û–Ω–æ–≤–ª–µ–Ω–∏–π server/database.py
python
Wrap
Copy
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite+aiosqlite:///socialhub.db"

engine = create_async_engine(
    DATABASE_URL,
    connect_args={"timeout": 30},  # –ó–±—ñ–ª—å—à–µ–Ω–æ —Ç–∞–π–º-–∞—É—Ç
    echo=True
)

AsyncSessionLocal = sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False
)

async def get_db():
    async with AsyncSessionLocal() as session:
        yield session
–û–Ω–æ–≤–ª–µ–Ω–∏–π server/main.py
–û—Å—å –ø–æ–≤–Ω–∏–π –∫–æ–¥ —ñ–∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º–∏:

python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

load_dotenv()

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")
temp_sessions = {}

class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None
    model_config = ConfigDict(arbitrary_types_allowed=True)

async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await asyncio.sleep(0.1)
    await db.commit()
    return {"message": "User created successfully"}

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        if current_user.id in temp_sessions:
            await temp_sessions[current_user.id]["client"].disconnect()
            del temp_sessions[current_user.id]

        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not client.is_connected():
            print("–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...")
            await client.connect()

        sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        await asyncio.sleep(0.1)
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: {str(e)}")
        raise HTTPException(400, detail=str(e))

@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.1)
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        await asyncio.sleep(0.2)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è–º –¥–æ –±–∞–∑–∏
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await asyncio.sleep(0.1)
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

@app.get("/health")
async def health_check():
    return {"status": "OK"}
–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?
/send-code:
–ü–µ—Ä–µ–≤—ñ—Ä—è—î –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è —ñ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è, —è–∫—â–æ –≤–æ–Ω–æ –≤—Ç—Ä–∞—á–µ–Ω–æ.
–ú–∞—î –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É Cannot send requests while disconnected.
/chats:
–î–æ–¥–∞–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É 0.2 —Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–¥ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è–º –¥–æ –±–∞–∑–∏, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –∑ /connect-telegram.
–ó–±—ñ–ª—å—à–µ–Ω–∏–π —Ç–∞–π–º-–∞—É—Ç —É database.py –¥–æ 30 —Å–µ–∫—É–Ω–¥.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–°–∫–æ–ø—ñ—é–π —Ü—ñ —Ñ–∞–π–ª–∏ –≤ server/.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
bash
Wrap
Copy
source venv/Scripts/activate
uvicorn main:app --reload
–°–ø—Ä–æ–±—É–π –∑–Ω–æ–≤—É –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥ —ñ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ Telegram.
–Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∏ –∑–∞–ª–∏—à–∞—Ç—å—Å—è
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –Ω–æ–≤—ñ –ª–æ–≥–∏ –ø—ñ—Å–ª—è —Ç–µ—Å—Ç—É, —ñ —è —à–≤–∏–¥–∫–æ –≤—Å–µ –¥–æ–ø—Ä–∞—Ü—é—é. –ê–ª–µ —Ü—ñ –∑–º—ñ–Ω–∏ –º–∞—é—Ç—å —É—Å—É–Ω—É—Ç–∏ —ñ 400, —ñ "database is locked". –£—Å–µ –º–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø–ª–∞–≤–Ω–æ!






–Ω–∞–∂–∞–ª—å —á–æ–º—É—Å—å –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: test123
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
Telegram is having internal issues AuthRestartError: Restart the authorization process (caused by SendCodeRequest)
–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: Cannot send requests while disconnected
2025-02-28 13:43:06,282 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 400
INFO:     127.0.0.1:56132 - "POST /send-code HTTP/1.1" 400 Bad Request


–î—è–∫—É—é –∑–∞ –ª–æ–≥! –ü–æ–º–∏–ª–∫–∞ Cannot send requests while disconnected —ñ AuthRestartError –≤—Å–µ —â–µ –∑‚Äô—è–≤–ª—è—é—Ç—å—Å—è, –Ω–∞–≤—ñ—Ç—å —ñ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–∏–º –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –ø—Ä–æ–±–ª–µ–º–∞ –≥–ª–∏–±—à–∞, –Ω—ñ–∂ –ø—Ä–æ—Å—Ç–æ –≤—Ç—Ä–∞—Ç–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è ‚Äî Telegram –≤–∏–¥–∞—î –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –ø–æ–º–∏–ª–∫—É, —è–∫–∞ –ø–µ—Ä–µ—Ä–∏–≤–∞—î –ø—Ä–æ—Ü–µ—Å. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ—Å—è —ñ –≤–∏–ø—Ä–∞–≤–∏–º–æ —Ü–µ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

–ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–±–ª–µ–º–∏
–õ–æ–≥–∏:

text
Wrap
Copy
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
Telegram is having internal issues AuthRestartError: Restart the authorization process (caused by SendCodeRequest)
–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: Cannot send requests while disconnected
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 400
AuthRestartError ‚Äî —Ü–µ –≤–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞ Telegram, —è–∫–∞ –æ–∑–Ω–∞—á–∞—î, —â–æ –ø—Ä–æ—Ü–µ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏. –í–æ–Ω–∞ –≤–∏–Ω–∏–∫–∞—î –∑ —ó—Ö–Ω—å–æ–≥–æ –±–æ–∫—É —ñ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤‚Äô—è–∑–∞–Ω–∞ –∑ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—é —Å–µ—Ä–≤–µ—Ä–∞ Telegram –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Å—Ç–∞–Ω–æ–º —Å–µ—Å—ñ—ó.
Cannot send requests while disconnected ‚Äî —Ü–µ –≤—Ç–æ—Ä–∏–Ω–Ω–∞ –ø–æ–º–∏–ª–∫–∞, —è–∫–∞ –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è, –±–æ –∫–ª—ñ—î–Ω—Ç –≤—Ç—Ä–∞—á–∞—î –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –ø—ñ—Å–ª—è –Ω–µ–≤–¥–∞–ª–æ–≥–æ –∑–∞–ø–∏—Ç—É.
–ß–æ–º—É —Ç–∞–∫ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è?

–ú–æ–∂–ª–∏–≤–æ, —Å–µ—Å—ñ—è Telegram (—Ñ–∞–π–ª sessions/session_{user_id}) –ø–æ—à–∫–æ–¥–∂–µ–Ω–∞ –∞–±–æ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞.
Telegram –º–æ–∂–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç —á–µ—Ä–µ–∑ —Ç–∞–π–º-–∞—É—Ç –∞–±–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏, –∞–ª–µ –¥–æ–∑–≤–æ–ª—è—î –π–æ–≥–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ñ–π —Å–ø—Ä–æ–±—ñ (—Ç–∏ –ø–∏—Å–∞–ª–∞, —â–æ –∫–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —ñ–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∑—É).
–ù–∞—à –∫–æ–¥ –Ω–µ –æ–±—Ä–æ–±–ª—è—î AuthRestartError —è–≤–Ω–æ —ñ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
1. –û–±—Ä–æ–±–∫–∞ AuthRestartError —ñ –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç
–î–æ–¥–∞–º–æ –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –≤ /send-code, —è–∫—â–æ –≤–∏–Ω–∏–∫–∞—î AuthRestartError. –¢–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏–º–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤.

–û–Ω–æ–≤–ª–µ–Ω–∏–π server/main.py
–û—Å—å –ø–æ–≤–Ω–∏–π –∫–æ–¥ —ñ–∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º–∏:

python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError, AuthRestartError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

load_dotenv()

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")
temp_sessions = {}

class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None
    model_config = ConfigDict(arbitrary_types_allowed=True)

async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await asyncio.sleep(0.1)
    await db.commit()
    return {"message": "User created successfully"}

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_path = f"sessions/session_{current_user.id}"
        # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é, —è–∫—â–æ –≤–æ–Ω–∞ —î
        if os.path.exists(session_path):
            os.remove(session_path)
            print(f"–í–∏–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é: {session_path}")

        if current_user.id in temp_sessions:
            await temp_sessions[current_user.id]["client"].disconnect()
            del temp_sessions[current_user.id]

        client = TelegramClient(session_path, API_ID, API_HASH)
        await client.connect()

        try:
            sent_code = await client.send_code_request(data.phone)
        except AuthRestartError:
            print("AuthRestartError: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...")
            await client.disconnect()
            await asyncio.sleep(1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—é —Å–ø—Ä–æ–±–æ—é
            await client.connect()
            sent_code = await client.send_code_request(data.phone)

        temp_sessions[current_user.id] = {
            "phone": data.phone,
            "phone_code_hash": sent_code.phone_code_hash,
            "client": client
        }
        await asyncio.sleep(0.1)
        return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
    except FloodWaitError as e:
        raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code: {str(e)}")
        raise HTTPException(400, detail=str(e))

@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.1)
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        await asyncio.sleep(0.2)
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await asyncio.sleep(0.1)
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

@app.get("/health")
async def health_check():
    return {"status": "OK"}
–ó–º—ñ–Ω–∏
–Ü–º–ø–æ—Ä—Ç AuthRestartError:
–î–æ–¥–∞–Ω–æ from telethon.errors import ... AuthRestartError.
–û–±—Ä–æ–±–∫–∞ –≤ /send-code:
–í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–æ—ó (os.remove(session_path)).
–Ø–∫—â–æ –≤–∏–Ω–∏–∫–∞—î AuthRestartError, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∫–ª—ñ—î–Ω—Ç —ñ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Ç.
–ó–∞—Ç—Ä–∏–º–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—é —Å–ø—Ä–æ–±–æ—é –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.
–Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏
–°–∫–æ–ø—ñ—é–π —Ü–µ–π –∫–æ–¥ —É server/main.py.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
bash
Wrap
Copy
source venv/Scripts/activate
uvicorn main:app --reload
–°–ø—Ä–æ–±—É–π –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥ —ñ–∑ –ø–µ—Ä—à–æ–≥–æ —Ä–∞–∑—É.
–ß–æ–º—É —Ü–µ –º–∞—î —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏?
–í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ—ó —Å–µ—Å—ñ—ó —É—Å—É–≤–∞—î –º–æ–∂–ª–∏–≤—ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏.
–û–±—Ä–æ–±–∫–∞ AuthRestartError –∑–º—É—à—É—î –∫–æ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é, –∑–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ —â–æ–± –ø–∞–¥–∞—Ç–∏ –∑ –ø–æ–º–∏–ª–∫–æ—é.
–Ø–∫—â–æ –∫–æ–¥ —É—Å–µ —â–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —ñ–∑ –ø–µ—Ä—à–æ–≥–æ —Ä–∞–∑—É, –Ω–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –Ω–æ–≤—ñ –ª–æ–≥–∏ ‚Äî –º–æ–∂–ª–∏–≤–æ, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ Telegram (—Ç–æ–¥—ñ –¥–æ–¥–∞–º–æ –±—ñ–ª—å—à–µ –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–±). –ê–ª–µ —Ü–µ –≤–∂–µ –º–∞—î –±—É—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–µ!






–ø–æ–º–∏–ª–∫–∞ –ø—Ä–æ–ø–∞–ª–∞, –∞–ª–µ –∫–æ–¥ –Ω–µ –ø—Ä–∏–π—à–æ–≤ )))


–î–æ–±—Ä–µ, —â–æ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–æ–ø–∞–ª–∞ ‚Äî —Ü–µ –≤–∂–µ –ø—Ä–æ–≥—Ä–µ—Å! –ê–ª–µ —è–∫—â–æ –∫–æ–¥ –Ω–µ –ø—Ä–∏–π—à–æ–≤, –∑–Ω–∞—á–∏—Ç—å —î —â–µ –Ω—é–∞–Ω—Å, —è–∫–∏–π –º–∏ –Ω–µ –≤—Ä–∞—Ö—É–≤–∞–ª–∏. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —á–æ–º—É —Ç–∞–∫ —Å—Ç–∞–ª–æ—Å—è, —ñ –∑—Ä–æ–±–∏–º–æ —Ç–∞–∫, —â–æ–± –∫–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏–≤ —ñ–∑ –ø–µ—Ä—à–æ–≥–æ —Ä–∞–∑—É.

–ê–Ω–∞–ª—ñ–∑ —Å–∏—Ç—É–∞—Ü—ñ—ó
–ü–æ–º–∏–ª–∫–∏ AuthRestartError —ñ Cannot send requests while disconnected –±—ñ–ª—å—à–µ –Ω–µ–º–∞—î, —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–∞—à –∫–æ–¥ —Ç–µ–ø–µ—Ä –∫–æ—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–æ–±–ª—è—î —Ü—ñ –≤–∏–Ω—è—Ç–∫–∏.
–ê–ª–µ –∫–æ–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å, —ñ –≤ –ª–æ–≥–∞—Ö (—è –ø—Ä–∏–ø—É—Å–∫–∞—é, —Ç–∏ —ó—Ö –ø–µ—Ä–µ–≤—ñ—Ä–∏–ª–∞) –Ω–µ–º–∞—î —è–≤–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ —á–µ—Ä–µ–∑:
–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ Telegram: –°–µ—Ä–≤–µ—Ä Telegram –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—î –∫–æ–¥ (–º–æ–∂–ª–∏–≤–æ, —á–µ—Ä–µ–∑ –∑–∞—Ç—Ä–∏–º–∫–∏ –∞–±–æ –æ–±–º–µ–∂–µ–Ω–Ω—è).
–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É: –§–æ—Ä–º–∞—Ç –Ω–µ–≤—ñ—Ä–Ω–∏–π, –∞–±–æ Telegram –π–æ–≥–æ –≤—ñ–¥—Ö–∏–ª—è—î.
–°–µ—Å—ñ—è –≤—Å–µ —â–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—î: –•–æ—á–∞ –º–∏ –≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é, —â–æ—Å—å –º–æ–∂–µ –∑–∞–ª–∏—à–∞—Ç–∏—Å—è –≤ –ø–∞–º‚Äô—è—Ç—ñ.
–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞—Ç—Ä–∏–º–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É: Telegram –º–æ–∂–µ –ø–æ—Ç—Ä–µ–±—É–≤–∞—Ç–∏ —á–∞—Å—É –¥–ª—è –æ–±—Ä–æ–±–∫–∏.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
–î–∞–≤–∞–π:

–î–æ–¥–∞–º–æ –±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤, —â–æ–± —Ç–æ—á–Ω–æ –∑–Ω–∞—Ç–∏, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è.
–ó–±—ñ–ª—å—à–∏–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –ø—ñ—Å–ª—è send_code_request.
–î–æ–¥–∞–º–æ –ø–æ–≤—Ç–æ—Ä–Ω—É —Å–ø—Ä–æ–±—É, —è–∫—â–æ –∫–æ–¥ –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –æ–¥—Ä–∞–∑—É.
–û—Å—å –æ–Ω–æ–≤–ª–µ–Ω–∏–π main.py —ñ–∑ —Ü–∏–º–∏ –∑–º—ñ–Ω–∞–º–∏:

python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError, AuthRestartError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

load_dotenv()

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")
temp_sessions = {}

class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None
    model_config = ConfigDict(arbitrary_types_allowed=True)

async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await asyncio.sleep(0.1)
    await db.commit()
    return {"message": "User created successfully"}

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    print(f"–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–º–µ—Ä: {data.phone}")
    session_path = f"sessions/session_{current_user.id}"

    retries = 2  # –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–±
    for attempt in range(retries):
        try:
            if os.path.exists(session_path):
                os.remove(session_path)
                print(f"–í–∏–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é: {session_path}")

            if current_user.id in temp_sessions:
                await temp_sessions[current_user.id]["client"].disconnect()
                del temp_sessions[current_user.id]

            client = TelegramClient(session_path, API_ID, API_HASH)
            await client.connect()

            sent_code = await client.send_code_request(data.phone)
            print(f"–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è {data.phone}, phone_code_hash: {sent_code.phone_code_hash}")

            temp_sessions[current_user.id] = {
                "phone": data.phone,
                "phone_code_hash": sent_code.phone_code_hash,
                "client": client
            }
            await asyncio.sleep(1)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ Telegram
            return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"}
        except AuthRestartError:
            print(f"AuthRestartError –Ω–∞ —Å–ø—Ä–æ–±—ñ {attempt + 1}, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...")
            await client.disconnect()
            await asyncio.sleep(2)  # –ó–±—ñ–ª—å—à–µ–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—é —Å–ø—Ä–æ–±–æ—é
        except FloodWaitError as e:
            raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
        except Exception as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code –Ω–∞ —Å–ø—Ä–æ–±—ñ {attempt + 1}: {str(e)}")
            if attempt == retries - 1:
                raise HTTPException(400, detail=str(e))
            await client.disconnect()
            await asyncio.sleep(2)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é

@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.1)
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        await asyncio.sleep(0.2)
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await asyncio.sleep(0.1)
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

@app.get("/health")
async def health_check():
    return {"status": "OK"}
–ó–º—ñ–Ω–∏ –≤ /send-code
–õ–æ–≥–∏:
–î–æ–¥–∞–Ω–æ print —ñ–∑ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É —ñ phone_code_hash –¥–ª—è –¥–µ–±–∞–≥—É.
–ü–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏:
–ö–æ–¥ —Ä–æ–±–∏—Ç—å –¥–æ 2 —Å–ø—Ä–æ–± —ñ–∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é 2 —Å–µ–∫—É–Ω–¥–∏ –º—ñ–∂ –Ω–∏–º–∏.
–Ø–∫—â–æ AuthRestartError –∞–±–æ —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞, —Å–µ—Å—ñ—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è.
–ó–∞—Ç—Ä–∏–º–∫–∞:
–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ send_code_request –¥–æ–¥–∞–Ω–æ 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–°–∫–æ–ø—ñ—é–π —Ü–µ–π –∫–æ–¥ —É server/main.py.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
bash
Wrap
Copy
source venv/Scripts/activate
uvicorn main:app --reload
–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ —É —Ñ–æ—Ä–º–∞—Ç—ñ +380...) —ñ –Ω–∞—Ç–∏—Å–Ω–∏ "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥".
–ü–µ—Ä–µ–≤—ñ—Ä –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ —ñ —á–∏ –ø—Ä–∏–π—à–æ–≤ –∫–æ–¥ —É Telegram.
–©–æ –º–∞—î —Å—Ç–∞—Ç–∏—Å—è?
–¢–∏ –ø–æ–±–∞—á–∏—à —É –ª–æ–≥–∞—Ö:
text
Wrap
Copy
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–º–µ—Ä: +380...
–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è +380..., phone_code_hash: ...
–ö–æ–¥ –º–∞—î –ø—Ä–∏–π—Ç–∏ –≤ Telegram —ñ–∑ –ø–µ—Ä—à–æ–≥–æ —Ä–∞–∑—É.
–Ø–∫—â–æ –∫–æ–¥ —É—Å–µ —â–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –ø–æ–≤–Ω—ñ –ª–æ–≥–∏ –ø—ñ—Å–ª—è —Å–ø—Ä–æ–±–∏.
–ü–µ—Ä–µ–≤—ñ—Ä:
–ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä (–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ + —ñ –∫–æ–¥ –∫—Ä–∞—ó–Ω–∏)?
–ß–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ API_ID —ñ API_HASH —É server/.env? (–û—Ç—Ä–∏–º–∞–π —ó—Ö —ñ–∑ https://my.telegram.org).
–°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è —Ç–µ—Å—Ç—É.
–¶–µ–π –∫–æ–¥ –º–∞—î –≤–∏—Ä—ñ—à–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É, –∞–ª–µ —è–∫—â–æ —â–æ—Å—å –Ω–µ —Ç–∞–∫, —è –¥–æ–¥–∞–º —â–µ –±—ñ–ª—å—à–µ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ! üòä






–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: test123
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–º–µ—Ä: +380963048847
–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è +380963048847, phone_code_hash: a210a608c417d2ed1e
2025-02-28 13:48:58,393 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
INFO:     127.0.0.1:56357 - "POST /send-code HTTP/1.1" 200 OK - –∞–ª–µ –∫–æ–¥—É –Ω–µ–º–∞—î ((


–î–æ–±—Ä–µ, –±–∞—á—É, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î 200 —ñ –≤–≤–∞–∂–∞—î, —â–æ –∫–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ (–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è +380963048847, phone_code_hash: a210a608c417d2ed1e), –∞–ª–µ —Ç–∏ –π–æ–≥–æ –Ω–µ –æ—Ç—Ä–∏–º–∞–ª–∞ –≤ Telegram. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —á–æ–º—É —Ç–∞–∫, —ñ –≤–∏–ø—Ä–∞–≤–∏–º–æ.

–ê–Ω–∞–ª—ñ–∑
–õ–æ–≥–∏:

text
Wrap
Copy
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: test123
–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ 1
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–º–µ—Ä: +380963048847
–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è +380963048847, phone_code_hash: a210a608c417d2ed1e
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
–ó–∞–ø–∏—Ç –¥–æ Telegram —á–µ—Ä–µ–∑ send_code_request –ø—Ä–æ–π—à–æ–≤ —É—Å–ø—ñ—à–Ω–æ (–Ω–µ–º–∞—î –≤–∏–Ω—è—Ç–∫—ñ–≤).
Telegram –ø–æ–≤–µ—Ä–Ω—É–≤ phone_code_hash, —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–µ—Ä–≤–µ—Ä Telegram –ø—Ä–∏–π–Ω—è–≤ –∑–∞–ø–∏—Ç.
–ê–ª–µ –∫–æ–¥ –Ω–µ –ø—Ä–∏–π—à–æ–≤ —É Telegram.
–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:

Telegram –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—î –∫–æ–¥:
–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π –∞–±–æ –æ–±–º–µ–∂–µ–Ω–∏–π Telegram (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —á–µ—Ä–µ–∑ —á–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∏).
–ö–æ–¥ –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º, –∞ –¥–∑–≤—ñ–Ω–∫–æ–º (Telegram —ñ–Ω–æ–¥—ñ —Ç–∞–∫ —Ä–æ–±–∏—Ç—å).
–ü–æ–º–∏–ª–∫–∞ –≤ –Ω–æ–º–µ—Ä—ñ:
–•–æ—á–∞ —Ñ–æ—Ä–º–∞—Ç +380963048847 –≤–∏–≥–ª—è–¥–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º, –º–æ–∂–ª–∏–≤–æ, —Ü–µ –Ω–µ —Ç–æ–π –Ω–æ–º–µ—Ä, —è–∫–∏–π –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∏–π –¥–æ —Ç–≤–æ–≥–æ Telegram.
–°—Ç–∞—Ä–∞ —Å–µ—Å—ñ—è –≤–ø–ª–∏–≤–∞—î:
–•–æ—á–∞ –º–∏ –≤–∏–¥–∞–ª—è—î–º–æ —Ñ–∞–π–ª —Å–µ—Å—ñ—ó, Telegram –º–æ–∂–µ "–ø–∞–º‚Äô—è—Ç–∞—Ç–∏" –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏ —ñ –≤—ñ–¥–∫–ª–∞–¥–∞—Ç–∏ –∫–æ–¥.
–ó–∞—Ç—Ä–∏–º–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:
–Ü–Ω–æ–¥—ñ –∫–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —ñ–∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é (–¥–æ 1-2 —Ö–≤–∏–ª–∏–Ω).
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
1. –ü–µ—Ä–µ–≤—ñ—Ä –¥–æ—Å—Ç–∞–≤–∫—É –∫–æ–¥—É
–ß–∏ –ø—Ä–∏–π—à–æ–≤ –∫–æ–¥ –¥–∑–≤—ñ–Ω–∫–æ–º? Telegram —ñ–Ω–æ–¥—ñ –¥–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ –Ω–æ–º–µ—Ä —ñ –¥–∏–∫—Ç—É—î –∫–æ–¥ –≥–æ–ª–æ—Å–æ–º –∑–∞–º—ñ—Å—Ç—å SMS. –ü–µ—Ä–µ–≤—ñ—Ä –¥–∑–≤—ñ–Ω–∫–∏ –Ω–∞ +380963048847 –ø—Ä–æ—Ç—è–≥–æ–º 1-2 —Ö–≤–∏–ª–∏–Ω –ø—ñ—Å–ª—è –∑–∞–ø–∏—Ç—É.
–ß–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –Ω–æ–º–µ—Ä —É Telegram? –í—ñ–¥–∫—Ä–∏–π Telegram –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ —á–∏ –∫–æ–º–ø‚Äô—é—Ç–µ—Ä—ñ, –∑–∞–π–¥–∏ –≤ Settings ‚Üí Your Phone Number —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ –∑–±—ñ–≥–∞—î—Ç—å—Å—è –≤—ñ–Ω —ñ–∑ +380963048847.
2. –û–Ω–æ–≤–ª–µ–Ω–∏–π main.py —ñ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ—é —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—é
–î–æ–¥–∞–º–æ –±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤ —ñ –¥–∞–º–æ Telegram –±—ñ–ª—å—à–µ —á–∞—Å—É –Ω–∞ –æ–±—Ä–æ–±–∫—É:

python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError, AuthRestartError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

load_dotenv()

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")
temp_sessions = {}

class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None
    model_config = ConfigDict(arbitrary_types_allowed=True)

async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await asyncio.sleep(0.1)
    await db.commit()
    return {"message": "User created successfully"}

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    print(f"–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–º–µ—Ä: {data.phone}")
    session_path = f"sessions/session_{current_user.id}"

    retries = 2
    for attempt in range(retries):
        try:
            if os.path.exists(session_path):
                os.remove(session_path)
                print(f"–í–∏–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é: {session_path}")

            if current_user.id in temp_sessions:
                await temp_sessions[current_user.id]["client"].disconnect()
                del temp_sessions[current_user.id]

            client = TelegramClient(session_path, API_ID, API_HASH)
            await client.connect()
            print(f"–ö–ª—ñ—î–Ω—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Telegram, —Å–ø—Ä–æ–±–∞ {attempt + 1}")

            sent_code = await client.send_code_request(data.phone)
            print(f"–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è {data.phone}, phone_code_hash: {sent_code.phone_code_hash}")

            temp_sessions[current_user.id] = {
                "phone": data.phone,
                "phone_code_hash": sent_code.phone_code_hash,
                "client": client
            }
            await asyncio.sleep(2)  # –ó–±—ñ–ª—å—à–µ–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è Telegram
            return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫)"}
        except AuthRestartError:
            print(f"AuthRestartError –Ω–∞ —Å–ø—Ä–æ–±—ñ {attempt + 1}, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...")
            await client.disconnect()
            await asyncio.sleep(2)
        except FloodWaitError as e:
            raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
        except Exception as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code –Ω–∞ —Å–ø—Ä–æ–±—ñ {attempt + 1}: {str(e)}")
            if attempt == retries - 1:
                raise HTTPException(400, detail=f"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥: {str(e)}")
            await client.disconnect()
            await asyncio.sleep(2)

@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.1)
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        await asyncio.sleep(0.2)
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await asyncio.sleep(0.1)
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

@app.get("/health")
async def health_check():
    return {"status": "OK"}
–ó–º—ñ–Ω–∏
–õ–æ–≥–∏:
–î–æ–¥–∞–Ω–æ –ö–ª—ñ—î–Ω—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Telegram –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è.
–ó–∞—Ç—Ä–∏–º–∫–∞:
–ó–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 2 —Å–µ–∫—É–Ω–¥ –ø—ñ—Å–ª—è send_code_request.
–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
–û–Ω–æ–≤–ª–µ–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¥–æ "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫)", —â–æ–± –Ω–∞–≥–∞–¥–∞—Ç–∏ –ø—Ä–æ –º–æ–∂–ª–∏–≤–∏–π –¥–∑–≤—ñ–Ω–æ–∫.
–©–æ —Ä–æ–±–∏—Ç–∏ –¥–∞–ª—ñ?
–°–∫–æ–ø—ñ—é–π —Ü–µ–π –∫–æ–¥ —É server/main.py.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
bash
Wrap
Copy
source venv/Scripts/activate
uvicorn main:app --reload
–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä +380963048847 —ñ –Ω–∞—Ç–∏—Å–Ω–∏ "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥".
–ü–µ—Ä–µ–≤—ñ—Ä:
–ß–µ–∫–∞–π 1-2 —Ö–≤–∏–ª–∏–Ω–∏ –Ω–∞ SMS —É Telegram.
–ü–µ—Ä–µ–≤—ñ—Ä –≤—Ö—ñ–¥–Ω—ñ –¥–∑–≤—ñ–Ω–∫–∏ –Ω–∞ —Ü–µ–π –Ω–æ–º–µ—Ä (Telegram –º–æ–∂–µ –ø–æ–¥–∑–≤–æ–Ω–∏—Ç–∏).
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –Ω–æ–≤—ñ –ª–æ–≥–∏, —è–∫—â–æ –∫–æ–¥ –Ω–µ –ø—Ä–∏–π—à–æ–≤.
–î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥—ñ—ó
–ü–µ—Ä–µ–≤—ñ—Ä API –∫–ª—é—á—ñ: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ API_ID —ñ API_HASH —É server/.env –∞–∫—Ç—É–∞–ª—å–Ω—ñ (–æ—Ç—Ä–∏–º–∞–π –Ω–æ–≤—ñ –∑ https://my.telegram.org, —è–∫—â–æ —î —Å—É–º–Ω—ñ–≤–∏).
–°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä: –í–≤–µ–¥–∏ —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å–≤—ñ–π –æ—Å–æ–±–∏—Å—Ç–∏–π), —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –Ω–æ–º–µ—Ä—ñ.
–ö–æ–¥ –º–∞—î –ø—Ä–∏–π—Ç–∏, –∞–ª–µ —è–∫—â–æ –Ω—ñ ‚Äî —Ü–µ –≤–∂–µ —Ç–æ—á–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ Telegram –∞–±–æ –Ω–æ–º–µ—Ä–∞. –î–∞–π –∑–Ω–∞—Ç–∏, —â–æ –≤–∏–π—à–ª–æ!






—Ç–∞–∫..—ñ —Å–ø—Ä–∞–≤–¥—ñ –ø—Ä–∏–π—à–æ–≤ –∫–æ–¥ —Ç—ñ–ª—å–∫–∏ –¥–µ—Å—å —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É.. —á–∏ –º–æ–∂–Ω–∞ —Ç–∞–º –¥–µ—Å—å –Ω–∏–∂—á–µ –ø—Ä–æ —Ü–µ –Ω–∞–ø–∏—Å–∞—Ç–∏? —â–æ —á–µ–∫–∞–π—Ç–µ 1-2 —Ö–≤? –ø–æ—Ç—ñ–º –ø—Ä–∏ –≤—ñ–¥–º–∞–ª—å–æ–≤—Ü—ñ —á–∞—Ç—ñ–≤ –∑–Ω–æ–≤ –∑'—è–≤–∏–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ , –∞–ª–µ —Å–∞–º—ñ —á–∞—Ç–∏ –≤—ñ–¥–º–∞–ª—å–æ–≤–∞–ª–∏—Å—å INFO:     127.0.0.1:56520 - "OPTIONS /chats HTTP/1.1" 200 OK
–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: GET http://localhost:8000/chats
–ó–∞–≥–æ–ª–æ–≤–∫–∏: Headers({'host': 'localhost:8000', 'connection': 'keep-alive', 'pragma': 'no-cache', 'cache-control': 'no-cache', 'sec-ch-ua-platform': '"Android"', 'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0MTIzIiwiZXhwIjoxNzQwNzQ3MTM4fQ.8jK3T_-tsh8n8HHqZkpzlZZnmIktC5K8J15lvpUAbqM', 'user-agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Mobile Safari/537.36', 'sec-ch-ua': '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"', 'sec-ch-ua-mobile': '?1', 'accept': '*/*', 'origin': 'http://localhost:3000', 'sec-fetch-site': 'same-site', 'sec-fetch-mode': 'cors', 'sec-fetch-dest': 'empty', 'referer': 'http://localhost:3000/', 'accept-encoding': 'gzip, deflate, br, zstd', 'accept-language': 'uk,en-US;q=0.9,en;q=0.8,uk-UA;q=0.7'})
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0MTIzIiwiZXhwIjoxNzQwNzQ3MTM4fQ.8jK3T_-tsh8n8HHqZkpzlZZnmIktC5K8J15lvpUAbqM
–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: test123
2025-02-28 13:53:33,524 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-02-28 13:53:33,525 INFO sqlalchemy.engine.Engine SELECT users.id, users.username, users.password_hash, users.telegram_phone
FROM users
WHERE users.username = ?
2025-02-28 13:53:33,525 INFO sqlalchemy.engine.Engine [cached since 111.6s ago] ('test123',)
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: test123
–ü–æ–º–∏–ª–∫–∞ –≤ /chats: database is locked
2025-02-28 13:53:39,353 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 500
INFO:     127.0.0.1:56520 - "GET /chats HTTP/1.1" 500 Internal Server Error
Task was destroyed but it is pending!
task: <Task pending name='Task-92' coro=<Connection._send_loop() running at G:\Projects\NextJS\SocialHub\server\venv\Lib\site-packages\telethon\network\connection\connection.py:322> wait_for=<Future pending cb=[Task.task_wakeup()]>>
Task was destroyed but it is pending!
task: <Task pending name='Task-93' coro=<Connection._recv_loop() running at G:\Projects\NextJS\SocialHub\server\venv\Lib\site-packages\telethon\network\connection\connection.py:341> wait_for=<Future pending cb=[Task.task_wakeup()]>>
Task was destroyed but it is pending!
task: <Task pending name='Task-94' coro=<MTProtoSender._send_loop() running at G:\Projects\NextJS\SocialHub\server\venv\Lib\site-packages\telethon\network\mtprotosender.py:464> wait_for=<Future pending cb=[Task.task_wakeup()]>>
Task was destroyed but it is pending!
task: <Task pending name='Task-95' coro=<MTProtoSender._recv_loop() running at G:\Projects\NextJS\SocialHub\server\venv\Lib\site-packages\telethon\network\mtprotosender.py:507> wait_for=<Future pending cb=[Task.task_wakeup()]>>
Exception ignored in: <coroutine object Connection._recv_loop at 0x000001C4775C66B0>
Traceback (most recent call last):
  File "G:\Projects\NextJS\SocialHub\server\venv\Lib\site-packages\telethon\_updates\entitycache.py", line 27, in get
    return Entity(ty, id, hash)
           ^^^^^^^^^^^^^^^^^^^^
RuntimeError: coroutine ignored GeneratorExit
–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è 1
2025-02-28 13:53:39,793 INFO sqlalchemy.engine.Engine ROLLBACK
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
INFO:     127.0.0.1:56519 - "GET /chats HTTP/1.1" 200 OK


–ß—É–¥–æ–≤–æ, —â–æ –∫–æ–¥ –Ω–∞—Ä–µ—à—Ç—ñ –ø—Ä–∏–π—à–æ–≤, —Ö–æ—á —ñ –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é! –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ –æ–±–∏–¥–≤—ñ —Ç–≤–æ—ó –ø—Ä–æ—Å—å–±–∏: –¥–æ–¥–∞–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞—Ç—Ä–∏–º–∫—É –∫–æ–¥—É —ñ –≤–∏–ø—Ä–∞–≤–∏–º–æ –ø—Ä–æ–±–ª–µ–º—É –∑ "database is locked" –ø—Ä–∏ –≤—ñ–¥–º–∞–ª—å–æ–≤—Ü—ñ —á–∞—Ç—ñ–≤.

–ü—Ä–æ–±–ª–µ–º–∞ 1: –ó–∞—Ç—Ä–∏–º–∫–∞ –∫–æ–¥—É
–õ–æ–≥–∏:

text
Wrap
Copy
–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è +380963048847, phone_code_hash: a210a608c417d2ed1e
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
–ö–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ 1-2 —Ö–≤–∏–ª–∏–Ω–∏, —â–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è Telegram, —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π –∞–±–æ –Ω–æ–º–µ—Ä –Ω–µ–¥–∞–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è. –î–æ–¥–∞–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–≤, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞—á–µ–∫–∞—Ç–∏.

–ü—Ä–æ–±–ª–µ–º–∞ 2: "Database is locked" —É /chats
–õ–æ–≥–∏:

text
Wrap
Copy
–ü–æ–º–∏–ª–∫–∞ –≤ /chats: database is locked
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 500
–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è 1
–í—ñ–¥–ø–æ–≤—ñ–¥—å: 200
–ë–∞–∑–∞ –±–ª–æ–∫—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –æ–¥–Ω–æ—á–∞—Å–Ω–∏–π –¥–æ—Å—Ç—É–ø —ñ–∑ /connect-telegram (–∫–æ–º—ñ—Ç telegram_phone) —ñ /chats (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ telegram_phone).
–ö–ª—ñ—î–Ω—Ç –ø–æ–≤—Ç–æ—Ä—é—î –∑–∞–ø–∏—Ç –¥–æ /chats —á–µ—Ä–µ–∑ useEffect, —ñ –¥—Ä—É–≥–∏–π –∑–∞–ø–∏—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —É—Å–ø—ñ—à–Ω–æ.
–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ Task was destroyed but it is pending! –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ –∑ telethon, –∫–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–¥–∞—á.
–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:

–ó–±—ñ–ª—å—à–∏–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –ø–µ—Ä–µ–¥ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è–º –¥–æ –±–∞–∑–∏ –≤ /chats.
–î–æ–¥–∞–º–æ –∫–æ—Ä–µ–∫—Ç–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è —Å–µ—Å—ñ—ó Telegram.
–û–Ω–æ–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏
1. server/main.py
python
Wrap
Copy
import os
from datetime import datetime, timedelta
from typing import Optional
from fastapi import Body, Depends, FastAPI, HTTPException, status, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer
from fastapi.responses import JSONResponse, Response
from jose import JWTError, jwt
from passlib.context import CryptContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from telethon import TelegramClient
from telethon.errors import FloodWaitError, SessionPasswordNeededError, SessionExpiredError, AuthRestartError
from pydantic import BaseModel
from database import AsyncSessionLocal, engine
from models import Base, User
from dotenv import load_dotenv
from pydantic import ConfigDict
from telethon import types
import asyncio

load_dotenv()

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60

API_ID = os.getenv("API_ID")
API_HASH = os.getenv("API_HASH")

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")
temp_sessions = {}

class UserCreate(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class TelegramSendCode(BaseModel):
    phone: str

class TelegramConnect(BaseModel):
    code: str
    password: Optional[str] = None
    phone: Optional[str] = None

class TelegramSession(BaseModel):
    phone: str
    phone_code_hash: str
    client: Optional[types.User] = None
    model_config = ConfigDict(arbitrary_types_allowed=True)

async def get_db():
    async with AsyncSessionLocal() as session:
        yield session

@app.middleware("http")
async def log_requests(request: Request, call_next):
    print(f"–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {request.method} {request.url}")
    print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {request.headers}")
    response = await call_next(request)
    print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.status_code}")
    return response

@app.exception_handler(Exception)
async def custom_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=500,
        content={"detail": str(exc)},
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Credentials": "true",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
        }
    )

@app.options("/{path:path}")
async def options_handler():
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "http://localhost:3000",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Credentials": "true",
        }
    )

@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: {token}")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        print(f"–î–µ–∫–æ–¥–æ–≤–∞–Ω–æ username: {username}")
        if not username:
            raise HTTPException(status_code=401, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω")

        result = await db.execute(select(User).filter(User.username == username))
        user = result.scalar_one_or_none()
        if not user:
            print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {username} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ")
            raise HTTPException(status_code=401, detail="–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

        print(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–Ω–∞–π–¥–µ–Ω–∏–π: {user.username}")
        return user
    except JWTError as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ JWT: {str(e)}")
        raise HTTPException(status_code=401, detail="–ü–æ–º–∏–ª–∫–∞ —Ç–æ–∫–µ–Ω–∞")

@app.post("/register", status_code=201)
async def register(user: UserCreate, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    if result.scalar():
        raise HTTPException(status_code=400, detail="Username already exists")

    hashed_password = pwd_context.hash(user.password)
    new_user = User(username=user.username, password_hash=hashed_password)
    db.add(new_user)
    await asyncio.sleep(0.1)
    await db.commit()
    return {"message": "User created successfully"}

@app.post("/login")
async def login(user: UserLogin, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(User).filter(User.username == user.username))
    db_user = result.scalar()

    if not db_user or not pwd_context.verify(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    token = create_access_token({"sub": db_user.username})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/check-connection")
async def check_connection(current_user: User = Depends(get_current_user)):
    print(f"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è: {current_user.username}")
    return {"connected": bool(current_user.telegram_phone)}

@app.post("/send-code")
async def send_code(
    data: TelegramSendCode,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    print(f"–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–º–µ—Ä: {data.phone}")
    session_path = f"sessions/session_{current_user.id}"

    retries = 2
    for attempt in range(retries):
        try:
            if os.path.exists(session_path):
                os.remove(session_path)
                print(f"–í–∏–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—É —Å–µ—Å—ñ—é: {session_path}")

            if current_user.id in temp_sessions:
                await temp_sessions[current_user.id]["client"].disconnect()
                del temp_sessions[current_user.id]

            client = TelegramClient(session_path, API_ID, API_HASH)
            await client.connect()
            print(f"–ö–ª—ñ—î–Ω—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Telegram, —Å–ø—Ä–æ–±–∞ {attempt + 1}")

            sent_code = await client.send_code_request(data.phone)
            print(f"–ö–æ–¥ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è {data.phone}, phone_code_hash: {sent_code.phone_code_hash}")

            temp_sessions[current_user.id] = {
                "phone": data.phone,
                "phone_code_hash": sent_code.phone_code_hash,
                "client": client
            }
            await asyncio.sleep(2)
            return {"detail": "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫) –ø—Ä–æ—Ç—è–≥–æ–º 1-2 —Ö–≤–∏–ª–∏–Ω"}
        except AuthRestartError:
            print(f"AuthRestartError –Ω–∞ —Å–ø—Ä–æ–±—ñ {attempt + 1}, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...")
            await client.disconnect()
            await asyncio.sleep(2)
        except FloodWaitError as e:
            raise HTTPException(429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
        except Exception as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /send-code –Ω–∞ —Å–ø—Ä–æ–±—ñ {attempt + 1}: {str(e)}")
            if attempt == retries - 1:
                raise HTTPException(400, detail=f"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥: {str(e)}")
            await client.disconnect()
            await asyncio.sleep(2)

@app.post("/connect-telegram")
async def connect_telegram(
    auth: TelegramConnect,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    print(f"–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {current_user.id}")
    try:
        session_data = temp_sessions.get(current_user.id)
        if not session_data or "client" not in session_data:
            raise HTTPException(400, "–°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥")

        client = session_data["client"]
        await client.connect()

        try:
            await client.sign_in(
                phone=session_data["phone"],
                code=auth.code,
                phone_code_hash=session_data["phone_code_hash"]
            )
        except SessionPasswordNeededError:
            if not auth.password:
                raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
            await client.sign_in(password=auth.password)

        await client.disconnect()
        current_user.telegram_phone = session_data["phone"]
        await asyncio.sleep(0.5)  # –ó–±—ñ–ª—å—à–µ–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º
        await db.commit()
        del temp_sessions[current_user.id]

        print(f"Telegram —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
        return {"status": "Connected"}
    except SessionPasswordNeededError:
        raise HTTPException(400, "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–æ–ª—å 2FA")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /connect-telegram: {str(e)}")
        raise HTTPException(400, f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats")
async def get_chats(current_user: User = Depends(get_current_user)):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        await asyncio.sleep(1)  # –ó–±—ñ–ª—å—à–µ–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –∑ /connect-telegram
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram")

        dialogs = await client.get_dialogs()
        await client.disconnect()

        print(f"–ß–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è {current_user.id}")
        return [{"id": d.id, "name": d.name} for d in dialogs]
    except FloodWaitError as e:
        raise HTTPException(status_code=429, detail=f"–ó–∞—á–µ–∫–∞–π—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥")
    except SessionExpiredError:
        raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è, –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞: {str(e)}")

@app.get("/chats/{chat_id}/messages")
async def get_chat_messages(
    chat_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if not current_user.telegram_phone:
        raise HTTPException(status_code=400, detail="Telegram –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")

    try:
        client = TelegramClient(f"sessions/session_{current_user.id}", API_ID, API_HASH)
        await client.connect()

        if not await client.is_user_authorized():
            await client.disconnect()
            raise HTTPException(status_code=400, detail="–°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")

        messages = await client.get_messages(chat_id, limit=20)
        await client.disconnect()

        return [{"id": m.id, "text": m.text, "date": m.date.isoformat()} for m in messages]
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ /chats/{chat_id}/messages: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/logout-telegram")
async def logout_telegram(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    if current_user.telegram_phone and os.path.exists(f"sessions/session_{current_user.id}"):
        os.remove(f"sessions/session_{current_user.id}")
    current_user.telegram_phone = None
    await asyncio.sleep(0.1)
    await db.commit()
    print(f"Telegram –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è {current_user.id}")
    return {"message": "Telegram disconnected"}

@app.post("/logout")
async def logout_system(current_user: User = Depends(get_current_user)):
    return {"message": "Logged out from system"}

@app.get("/health")
async def health_check():
    return {"status": "OK"}
–ó–º—ñ–Ω–∏:

–£ /send-code –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫) –ø—Ä–æ—Ç—è–≥–æ–º 1-2 —Ö–≤–∏–ª–∏–Ω".
–£ /connect-telegram –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ db.commit() –∑–±—ñ–ª—å—à–µ–Ω–∞ –¥–æ 0.5 —Å–µ–∫—É–Ω–¥.
–£ /chats –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è–º –¥–æ –±–∞–∑–∏ –∑–±—ñ–ª—å—à–µ–Ω–∞ –¥–æ 1 —Å–µ–∫—É–Ω–¥–∏.
2. client/pages/dashboard.js
–î–æ–¥–∞–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞—Ç—Ä–∏–º–∫—É –∫–æ–¥—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const [message, setMessage] = useState(""); // –î–æ–¥–∞–Ω–æ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");

    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/check-connection", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 401) {
                    console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                    localStorage.removeItem("token");
                    router.push("/login");
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    const sendCode = async (e) => {
        e.preventDefault();
        setError("");
        setMessage(""); // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");
            }

            setIsCodeSent(true);
            setMessage(data.detail); // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
        } catch (err) {
            setError(err.message);
        }
    };

    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 1000));
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    const fetchChats = async () => {
        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/chats", {
                headers: { Authorization: `Bearer ${token}` },
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
            }

            const data = await res.json();
            setChats(data);
        } catch (err) {
            setError(err.message);
        }
    };

    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false);
            setPhone("");
            setCode("");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}
            {message && <p className="text-green-500 mb-4">{message}</p>} {/* –î–æ–¥–∞–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */}

            {!isConnected ? (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) => setTwoFactorPassword(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-4">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="p-4 border rounded hover:bg-gray-50"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-blue-500 hover:underline"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
–ó–º—ñ–Ω–∏:

–î–æ–¥–∞–Ω–æ —Å—Ç–∞–Ω message —ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –π–æ–≥–æ –≤ –∑–µ–ª–µ–Ω–æ–º—É –∫–æ–ª—å–æ—Ä—ñ –ø—ñ—Å–ª—è sendCode.
–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?
–ó–∞—Ç—Ä–∏–º–∫–∞ –∫–æ–¥—É:
–ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥" —Ç–∏ –ø–æ–±–∞—á–∏—à –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: "–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫) –ø—Ä–æ—Ç—è–≥–æ–º 1-2 —Ö–≤–∏–ª–∏–Ω".
–¶–µ –ø–æ–ø–µ—Ä–µ–¥–∏—Ç—å, —â–æ –∫–æ–¥ –º–æ–∂–µ –ø—Ä–∏–π—Ç–∏ –Ω–µ –æ–¥—Ä–∞–∑—É.
"Database is locked":
–ó–±—ñ–ª—å—à–µ–Ω—ñ –∑–∞—Ç—Ä–∏–º–∫–∏ –≤ /connect-telegram (0.5 —Å) —ñ /chats (1 —Å) –º–∞—é—Ç—å —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ —ñ–∑ –±–∞–∑–æ—é SQLite.
–Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –≤—Å–µ —â–µ –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è, —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ —á–µ—Ä–µ–∑ —á–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∏ –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–°–∫–æ–ø—ñ—é–π –æ–Ω–æ–≤–ª–µ–Ω—ñ main.py —ñ dashboard.js.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
bash
Wrap
Copy
source venv/Scripts/activate
uvicorn main:app --reload
–ó–∞–ø—É—Å—Ç–∏ –∫–ª—ñ—î–Ω—Ç:
bash
Wrap
Copy
cd client
npm run dev
–°–ø—Ä–æ–±—É–π –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥ —ñ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ Telegram.
–Ø–∫—â–æ "database is locked" –∑–∞–ª–∏—à–∏—Ç—å—Å—è
–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –Ω–æ–≤—ñ –ª–æ–≥–∏.
–ú–æ–∂–µ–º–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ PostgreSQL –∑–∞–º—ñ—Å—Ç—å SQLite, —è–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∑–Ω–∏–∫–Ω–µ (SQLite –ø–æ–≥–∞–Ω–æ –ø—Ä–∞—Ü—é—î –∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º–∏ –æ–ø–µ—Ä–∞—Ü—ñ—è–º–∏ –ø—Ä–∏ –≤–∏—Å–æ–∫—ñ–π —á–∞—Å—Ç–æ—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤).
–°–ø–æ–¥—ñ–≤–∞—é—Å—è, —Ç–µ–ø–µ—Ä —É—Å–µ –±—É–¥–µ –≥–ª–∞–¥–∫–æ! –î–∞–π –∑–Ω–∞—Ç–∏, —è–∫ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ.






Database is locked –≤—Å–µ –æ–¥–Ω–æ –∑'—è–≤–ª—è—î—Ç—å—Å—è.. –∞ –º–æ–∂–Ω–∞ —â–æ–± –≤–æ–Ω–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç—ñ –Ω–µ –≤—ñ–¥–º–∞–ª—å–æ–≤—É–≤–∞–ª–∞—Å—å?) –±–æ –º–µ–Ω—ñ –Ω–µ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –Ω–∞ —ñ–Ω—à—É –±–∞–∑—É –¥–∞–Ω–∏—Ö


–î–æ–±—Ä–µ, —è–∫—â–æ "database is locked" –≤—Å–µ —â–µ –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è, –∞–ª–µ —á–∞—Ç–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–º–∞–ª—å–æ–≤—É—é—Ç—å—Å—è –ø—ñ—Å–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É, –º–∏ –º–æ–∂–µ–º–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ü—é –ø–æ–º–∏–ª–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —ó—ó –Ω–µ –±–∞—á–∏–≤. –û—Å–∫—ñ–ª—å–∫–∏ —Ç–∏ –Ω–µ –º–æ–∂–µ—à –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —ñ–Ω—à—É –±–∞–∑—É –¥–∞–Ω–∏—Ö, –º–∏ –∑–∞–ª–∏—à–∏–º–æ SQLite —ñ –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–æ–±–∏–º–æ –ø–æ–º–∏–ª–∫—É 500 —Ç–∞–∫, —â–æ–± —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —ó—ó —ñ–≥–Ω–æ—Ä—É–≤–∞–≤ —ñ —á–µ–∫–∞–≤ —É—Å–ø—ñ—à–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –î–∞–≤–∞–π –∑—Ä–æ–±–∏–º–æ —Ü–µ!

–ü–ª–∞–Ω
–°–µ—Ä–≤–µ—Ä: –ó–∞–ª–∏—à–∏–º–æ —è–∫ —î, –±–æ –≤—ñ–Ω —É–∂–µ —Ä–æ–±–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏ —á–µ—Ä–µ–∑ –∫–ª—ñ—î–Ω—Ç.
–§—Ä–æ–Ω—Ç–µ–Ω–¥: –û–Ω–æ–≤–∏–º–æ dashboard.js, —â–æ–±:
–Ü–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É 500 —ñ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç –¥–æ /chats –¥–æ —É—Å–ø—ñ—Ö—É.
–ù–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —è–∫—â–æ –≤–æ–Ω–∞ –ø–æ–≤‚Äô—è–∑–∞–Ω–∞ –∑ "database is locked".
–û–Ω–æ–≤–ª–µ–Ω–∏–π client/pages/dashboard.js
–û—Å—å –ø–æ–≤–Ω–∏–π –∫–æ–¥ —ñ–∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º–∏:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const [message, setMessage] = useState("");
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");

    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/check-connection", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 401) {
                    console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                    localStorage.removeItem("token");
                    router.push("/login");
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    const sendCode = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");
            }

            setIsCodeSent(true);
            setMessage(data.detail);
        } catch (err) {
            setError(err.message);
        }
    };

    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 1000));
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    const fetchChats = async (retries = 3) => {
        const token = localStorage.getItem("token");
        if (!token) {
            router.push("/login");
            return;
        }

        for (let attempt = 0; attempt < retries; attempt++) {
            try {
                const res = await fetch("http://localhost:8000/chats", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 500) {
                    console.log(`–°–ø—Ä–æ–±–∞ ${attempt + 1}: –ü–æ–º–∏–ª–∫–∞ 500, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...`);
                    if (attempt < retries - 1) {
                        await new Promise((resolve) => setTimeout(resolve, 1000));
                        continue; // –ü–æ–≤—Ç–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Ç, —è–∫—â–æ –Ω–µ –æ—Å—Ç–∞–Ω–Ω—è —Å–ø—Ä–æ–±–∞
                    }
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
                }

                const data = await res.json();
                setChats(data);
                break; // –£—Å–ø—ñ—Ö, –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ü–∏–∫–ª—É
            } catch (err) {
                if (attempt === retries - 1) {
                    setError(err.message); // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –≤—Å—ñ—Ö —Å–ø—Ä–æ–±
                }
            }
        }
    };

    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false);
            setPhone("");
            setCode("");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}
            {message && <p className="text-green-500 mb-4">{message}</p>}

            {!isConnected ? (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) => setTwoFactorPassword(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-4">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="p-4 border rounded hover:bg-gray-50"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-blue-500 hover:underline"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
–ó–º—ñ–Ω–∏
–§—É–Ω–∫—Ü—ñ—è fetchChats:
–î–æ–¥–∞–Ω–æ —Ü–∏–∫–ª —ñ–∑ 3 —Å–ø—Ä–æ–±–∞–º–∏ –¥–ª—è –∑–∞–ø–∏—Ç—É –¥–æ /chats.
–Ø–∫—â–æ –æ—Ç—Ä–∏–º—É—î–º–æ 500 (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "database is locked"), —á–µ–∫–∞—î–º–æ 1 —Å–µ–∫—É–Ω–¥—É —ñ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Ç.
–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è (setError) —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –≤—Å—ñ—Ö –Ω–µ–≤–¥–∞–ª–∏—Ö —Å–ø—Ä–æ–±.
–õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ –ø–æ–∫–∞–∑—É—é—Ç—å —Å–ø—Ä–æ–±–∏, –∞–ª–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ü—å–æ–≥–æ –Ω–µ –±–∞—á–∏—Ç—å.
–õ–æ–≥—ñ–∫–∞:
–ü–æ–º–∏–ª–∫–∞ 500 –±—ñ–ª—å—à–µ –Ω–µ –∑‚Äô—è–≤–ª—è—Ç–∏–º–µ—Ç—å—Å—è –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ, —è–∫—â–æ —á–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É.
–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?
–ü—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram (setIsConnected(true)), fetchChats –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ useEffect.
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î 500 —á–µ—Ä–µ–∑ "database is locked", –∫–ª—ñ—î–Ω—Ç —Ç–∏—Ö–æ —á–µ–∫–∞—î —ñ –ø–æ–≤—Ç–æ—Ä—é—î –∑–∞–ø–∏—Ç.
–ü–æ–º–∏–ª–∫–∞ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, –¥–æ–∫–∏ –≤—Å—ñ 3 —Å–ø—Ä–æ–±–∏ –Ω–µ –ø—Ä–æ–≤–∞–ª—è—Ç—å—Å—è (—á–æ–≥–æ –Ω–µ –º–∞—î —Å—Ç–∞—Ç–∏—Å—è, –±–æ –¥—Ä—É–≥–∏–π –∑–∞–ø–∏—Ç –∑–∞–∑–≤–∏—á–∞–π —É—Å–ø—ñ—à–Ω–∏–π).
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–°–∫–æ–ø—ñ—é–π —Ü–µ–π –∫–æ–¥ —É client/pages/dashboard.js.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∫–ª—ñ—î–Ω—Ç:
bash
Wrap
Copy
cd client
npm run dev
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ:
bash
Wrap
Copy
cd server
source venv/Scripts/activate
uvicorn main:app --reload
–ü—ñ–¥–∫–ª—é—á–∏ Telegram —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏:
–ö–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —ñ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º –ø—Ä–æ 1-2 —Ö–≤–∏–ª–∏–Ω–∏.
–ß–∞—Ç–∏ –≤—ñ–¥–º–∞–ª—å–æ–≤—É—é—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–∫–∏ "database is locked" –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.
–†–µ–∑—É–ª—å—Ç–∞—Ç
–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞—Ç—Ä–∏–º–∫—É –∫–æ–¥—É –±—É–¥–µ –≤–∏–¥–Ω–æ.
–ü–æ–º–∏–ª–∫–∞ "database is locked" –∑–∞–ª–∏—à–∏—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞, –∞–ª–µ –Ω–µ –∑‚Äô—è–≤–∏—Ç—å—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ, –∞ —á–∞—Ç–∏ –≤—Å–µ –æ–¥–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è.
–î–∞–π –∑–Ω–∞—Ç–∏, —á–∏ –≤—Å–µ –æ–∫, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —â–µ –ø—Ä–∞–≤–∫–∏!






–¢–∞–∫, –≤—Å–µ –¥–æ–±—Ä–µ) —á–∏ –º–æ–∂–µ—à —Ç–∏ —Ç—Ä–æ—à–∫–∏ —Å—Ç–∏–ª–∏–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç–∫–∏ —á–∞—Ç—ñ–≤ —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤ —á–∞—Ç–∞—Ö? –ø—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω


–ß—É–¥–æ–≤–æ, —â–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î! –î–∞–≤–∞–π –¥–æ–¥–∞–º–æ —Ç—Ä–æ—Ö–∏ —Å—Ç–∏–ª—ñ–≤ –¥–æ –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤ —É dashboard.js —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É chats.js, —â–æ–± –≤–æ–Ω–∏ –≥–∞—Ä–º–æ–Ω—ñ—é–≤–∞–ª–∏ —ñ–∑ –∑–∞–≥–∞–ª—å–Ω–∏–º –¥–∏–∑–∞–π–Ω–æ–º (—è –ø—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ç–≤—ñ–π –¥–∏–∑–∞–π–Ω ‚Äî —Ü–µ —á–∏—Å—Ç–∏–π, —Å—É—á–∞—Å–Ω–∏–π —Å—Ç–∏–ª—å —ñ–∑ –±—ñ–ª–∏–º —Ñ–æ–Ω–æ–º, –∑–µ–ª–µ–Ω–∏–º–∏ –∞–∫—Ü–µ–Ω—Ç–∞–º–∏ —Ç–∞ —Å—ñ—Ä–∏–º–∏ –º–µ–∂–∞–º–∏, —Å—É–¥—è—á–∏ –ø–æ —Ñ–æ—Ä–º–∞—Ö). –Ø –∑—Ä–æ–±–ª—é —ó—Ö —É —Ç–∞–∫–æ–º—É –∂ –¥—É—Å—ñ.

–û–Ω–æ–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏
1. client/pages/dashboard.js (–ö–∞—Ä—Ç–∫–∏ —á–∞—Ç—ñ–≤)
–û–Ω–æ–≤–∏–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const [message, setMessage] = useState("");
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");

    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/check-connection", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 401) {
                    console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                    localStorage.removeItem("token");
                    router.push("/login");
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    const sendCode = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");
            }

            setIsCodeSent(true);
            setMessage(data.detail);
        } catch (err) {
            setError(err.message);
        }
    };

    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 1000));
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    const fetchChats = async (retries = 3) => {
        const token = localStorage.getItem("token");
        if (!token) {
            router.push("/login");
            return;
        }

        for (let attempt = 0; attempt < retries; attempt++) {
            try {
                const res = await fetch("http://localhost:8000/chats", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 500) {
                    console.log(`–°–ø—Ä–æ–±–∞ ${attempt + 1}: –ü–æ–º–∏–ª–∫–∞ 500, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...`);
                    if (attempt < retries - 1) {
                        await new Promise((resolve) => setTimeout(resolve, 1000));
                        continue;
                    }
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
                }

                const data = await res.json();
                setChats(data);
                break;
            } catch (err) {
                if (attempt === retries - 1) {
                    setError(err.message);
                }
            }
        }
    };

    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false);
            setPhone("");
            setCode("");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6 text-gray-800">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}
            {message && <p className="text-green-500 mb-4">{message}</p>}

            {!isConnected ? (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4 text-gray-700">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) => setTwoFactorPassword(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl text-gray-700">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-4">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-green-600 hover:text-green-700 font-medium transition-colors"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
–°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤:

bg-white p-4 rounded-lg shadow-md: –ë—ñ–ª–∏–π —Ñ–æ–Ω, –≤—ñ–¥—Å—Ç—É–ø–∏, –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏, –ª–µ–≥–∫–∞ —Ç—ñ–Ω—å.
hover:shadow-lg transition-shadow: –¢—ñ–Ω—å –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ.
border border-gray-200: –¢–æ–Ω–∫–∞ —Å—ñ—Ä–∞ –º–µ–∂–∞.
text-green-600 hover:text-green-700 font-medium: –ó–µ–ª–µ–Ω–∏–π –∫–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É, —Ç–µ–º–Ω—ñ—à–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ, —Å–µ—Ä–µ–¥–Ω—è –∂–∏—Ä–Ω—ñ—Å—Ç—å.
2. client/pages/chats.js (–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç–∞—Ö)
–û–Ω–æ–≤–∏–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";

export default function Chats() {
    const [chats, setChats] = useState([]);
    const [error, setError] = useState("");
    const router = useRouter();

    useEffect(() => {
        const fetchChats = async () => {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/chats", {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
                const data = await res.json();
                setChats(data);
            } catch (err) {
                setError(err.message);
            }
        };
        fetchChats();
    }, [router]);

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6 text-gray-800">–í–∞—à—ñ —á–∞—Ç–∏</h1>
            {error && <p className="text-red-500 mb-4">{error}</p>}
            <div className="space-y-4">
                {chats.map((chat) => (
                    <div
                        key={chat.id}
                        className="bg-white p-4 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow"
                    >
                        <p className="text-gray-700 font-medium">{chat.name}</p>
                    </div>
                ))}
            </div>
        </div>
    );
}
–°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤ —É chats.js:

–¢–∞–∫—ñ –∂, —è–∫ —É dashboard.js, –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ:
bg-white p-4 rounded-lg shadow-md border border-gray-200: –ë—ñ–ª–∏–π —Ñ–æ–Ω, –≤—ñ–¥—Å—Ç—É–ø–∏, —Ç—ñ–Ω—å, –º–µ–∂–∞.
hover:shadow-lg transition-shadow: –¢—ñ–Ω—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ.
text-gray-700 font-medium: –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π —Ç–µ–∫—Å—Ç, —Å–µ—Ä–µ–¥–Ω—è –∂–∏—Ä–Ω—ñ—Å—Ç—å.
–Ø–∫ —Ü–µ –≤–∏–≥–ª—è–¥–∞—î?
–ö–∞—Ä—Ç–∫–∏ —á–∞—Ç—ñ–≤: –ë—ñ–ª—ñ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∏ –∑ –ª–µ–≥–∫–æ—é —Ç—ñ–Ω–Ω—é, —Å—ñ—Ä–æ—é –º–µ–∂–µ—é, —è–∫—ñ —Å—Ç–∞—é—Ç—å –±—ñ–ª—å—à –≤–∏—Ä–∞–∑–Ω–∏–º–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ. –ù–∞–∑–≤–∏ —á–∞—Ç—ñ–≤ ‚Äî –∑–µ–ª–µ–Ω—ñ (—É dashboard.js) –∞–±–æ —Ç–µ–º–Ω–æ-—Å—ñ—Ä—ñ (—É chats.js).
–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω: –ß–∏—Å—Ç–∏–π, —Å—É—á–∞—Å–Ω–∏–π, —ñ–∑ –∑–µ–ª–µ–Ω–∏–º–∏ –∞–∫—Ü–µ–Ω—Ç–∞–º–∏ (–∫–Ω–æ–ø–∫–∏, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—Ö), —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ç–≤–æ—ó–π —Ñ–æ—Ä–º—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–°–∫–æ–ø—ñ—é–π –æ–Ω–æ–≤–ª–µ–Ω—ñ dashboard.js —ñ chats.js —É client/pages/.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∫–ª—ñ—î–Ω—Ç:
bash
Wrap
Copy
cd client
npm run dev
–ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ –∫–∞—Ä—Ç–∫–∏ —á–∞—Ç—ñ–≤ –≤–∏–≥–ª—è–¥–∞—é—Ç—å —Å—Ç–∏–ª—å–Ω–æ —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –¥–∏–∑–∞–π–Ω—É.
–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–º—ñ–Ω–∏
–Ø–∫—â–æ —Ö–æ—á–µ—à —ñ–Ω—à—ñ –∫–æ–ª—å–æ—Ä–∏ —á–∏ —Å—Ç–∏–ª—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±—ñ–ª—å—à–µ –∑–µ–ª–µ–Ω–æ–≥–æ, —ñ–Ω—à–∏–π —à—Ä–∏—Ñ—Ç), —Å–∫–∞–∂–∏ ‚Äî —è —à–≤–∏–¥–∫–æ –ø—ñ–¥–ª–∞—à—Ç—É—é! üòä –í—Å–µ –º–∞—î –≤–∏–≥–ª—è–¥–∞—Ç–∏ –≥–∞—Ä–º–æ–Ω—ñ–π–Ω–æ.






–û–Ω–æ–≤–∏–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å - —â–æ—Å—å –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–∏–ª–æ—Å—è.. –∫–ª–∞—Å—Å–Ω–æ –±—É–ª–æ –± —è–∫–æ—Å—å –≤ —Å—Ç–∏–ª—ñ –º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º—É.. —ñ —â–µ –º–æ–∂–Ω–∞ –±—É–ª–æ –± —â–æ–± –∫–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—à –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–ª–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ —á–∞—Ç—ñ–≤


–¢–∏ –ø—Ä–∞–≤–∞, —è –ø–æ–º–∏–ª–∏–≤—Å—è ‚Äî —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫–æ–¥—ñ —è –æ–Ω–æ–≤–∏–≤ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤ —É chats.js, –∞ –Ω–µ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, –±–æ —É —Ç–≤–æ—î–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ chats.js –ø–æ–∫–∞–∑—É–≤–∞–≤ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤, –∞ –Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –î–∞–≤–∞–π –≤–∏–ø—Ä–∞–≤–∏–º–æ —Ü–µ: –¥–æ–¥–∞–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, chats/[chat_id].js) —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º —Å—Ç–∏–ª–µ–º —ñ –∫–Ω–æ–ø–∫–æ—é "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —á–∞—Ç—ñ–≤". –¢–∞–∫–æ–∂ –æ–Ω–æ–≤–∏–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤ —É dashboard.js —ñ chats.js, —â–æ–± –≤–æ–Ω–∏ –±—É–ª–∏ –≤ —Å—Ç–∏–ª—ñ –º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º—É.

–û–Ω–æ–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏
1. client/pages/dashboard.js (–ö–∞—Ä—Ç–∫–∏ —á–∞—Ç—ñ–≤)
–û–Ω–æ–≤–∏–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è –º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º—É:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const [message, setMessage] = useState("");
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");

    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/check-connection", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 401) {
                    console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                    localStorage.removeItem("token");
                    router.push("/login");
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    const sendCode = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");
            }

            setIsCodeSent(true);
            setMessage(data.detail);
        } catch (err) {
            setError(err.message);
        }
    };

    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 1000));
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    const fetchChats = async (retries = 3) => {
        const token = localStorage.getItem("token");
        if (!token) {
            router.push("/login");
            return;
        }

        for (let attempt = 0; attempt < retries; attempt++) {
            try {
                const res = await fetch("http://localhost:8000/chats", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 500) {
                    console.log(`–°–ø—Ä–æ–±–∞ ${attempt + 1}: –ü–æ–º–∏–ª–∫–∞ 500, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...`);
                    if (attempt < retries - 1) {
                        await new Promise((resolve) => setTimeout(resolve, 1000));
                        continue;
                    }
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
                }

                const data = await res.json();
                setChats(data);
                break;
            } catch (err) {
                if (attempt === retries - 1) {
                    setError(err.message);
                }
            }
        }
    };

    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false);
            setPhone("");
            setCode("");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6 text-gray-800">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}
            {message && <p className="text-green-500 mb-4">{message}</p>}

            {!isConnected ? (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4 text-gray-700">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) => setTwoFactorPassword(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors"
                            >
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl text-gray-700">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-3">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="bg-white p-3 rounded-md border-b border-gray-200 hover:bg-gray-50 transition-colors"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-gray-800 hover:text-green-600 font-medium transition-colors"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
–°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ —á–∞—Ç—ñ–≤ (–º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º):

bg-white p-3 rounded-md border-b border-gray-200: –ë—ñ–ª–∏–π —Ñ–æ–Ω, –ª–µ–≥–∫–∏–π –≤—ñ–¥—Å—Ç—É–ø, –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏, —Ç–æ–Ω–∫–∞ –Ω–∏–∂–Ω—è –º–µ–∂–∞.
hover:bg-gray-50 transition-colors: –õ–µ–¥—å –ø–æ–º—ñ—Ç–Ω–∏–π —Å—ñ—Ä–∏–π —Ñ–æ–Ω –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ.
text-gray-800 hover:text-green-600 font-medium: –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π —Ç–µ–∫—Å—Ç, –∑–µ–ª–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ.
2. client/pages/chats/[chat_id].js (–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ)
–°—Ç–≤–æ—Ä–∏–º–æ –Ω–æ–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º —Å—Ç–∏–ª–µ–º —ñ –∫–Ω–æ–ø–∫–æ—é "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è":

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function ChatMessages() {
    const [messages, setMessages] = useState([]);
    const [error, setError] = useState("");
    const router = useRouter();
    const { chat_id } = router.query;

    useEffect(() => {
        const fetchMessages = async () => {
            const token = localStorage.getItem("token");
            if (!token || !chat_id) {
                router.push("/login");
                return;
            }

            try {
                const res = await fetch(`http://localhost:8000/chats/${chat_id}/messages`, {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
                const data = await res.json();
                setMessages(data);
            } catch (err) {
                setError(err.message);
            }
        };

        if (chat_id) {
            fetchMessages();
        }
    }, [chat_id, router]);

    return (
        <div className="max-w-4xl mx-auto p-6">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-gray-800">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h1>
                <Link
                    href="/dashboard"
                    className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors"
                >
                    –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —á–∞—Ç—ñ–≤
                </Link>
            </div>

            {error && <p className="text-red-500 mb-4">{error}</p>}

            <div className="space-y-3">
                {messages.map((message) => (
                    <div
                        key={message.id}
                        className="bg-white p-3 rounded-md border-b border-gray-200 text-gray-700"
                    >
                        <p className="text-sm">{message.text}</p>
                        <p className="text-xs text-gray-500 mt-1">{new Date(message.date).toLocaleString()}</p>
                    </div>
                ))}
            </div>
        </div>
    );
}
–°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º):

bg-white p-3 rounded-md border-b border-gray-200: –ë—ñ–ª–∏–π —Ñ–æ–Ω, –≤—ñ–¥—Å—Ç—É–ø–∏, —Ç–æ–Ω–∫–∞ –Ω–∏–∂–Ω—è –º–µ–∂–∞.
text-gray-700: –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç—É.
text-sm —ñ text-xs text-gray-500: –ú–µ–Ω—à–∏–π —Ä–æ–∑–º—ñ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç—É —ñ –¥–∞—Ç–∏, —Å–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π –¥–ª—è –¥–∞—Ç–∏.
–ö–Ω–æ–ø–∫–∞ "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è":

bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600: –ó–µ–ª–µ–Ω–∏–π —Ñ–æ–Ω, –±—ñ–ª–∏–π —Ç–µ–∫—Å—Ç, –µ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ.
–Ø–∫ —Ü–µ –≤–∏–≥–ª—è–¥–∞—î?
–ß–∞—Ç–∏: –ü—Ä–æ—Å—Ç—ñ –±—ñ–ª—ñ –∫–∞—Ä—Ç–∫–∏ –∑ –Ω–∏–∂–Ω—å–æ—é –º–µ–∂–µ—é, –±–µ–∑ –∑–∞–π–≤–∏—Ö —Ç—ñ–Ω–µ–π, —ñ–∑ –ø–ª–∞–≤–Ω–∏–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫–æ–ª—å–æ—Ä—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ.
–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: –¢–∞–∫—ñ –∂ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ –∫–∞—Ä—Ç–∫–∏, —ñ–∑ —Ç–µ–∫—Å—Ç–æ–º —ñ –¥–∞—Ç–æ—é –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ.
–ö–Ω–æ–ø–∫–∞: –ó–µ–ª–µ–Ω–∞, —É —Å—Ç–∏–ª—ñ —Ä–µ—à—Ç–∏ –∫–Ω–æ–ø–æ–∫, —Ä–æ–∑–º—ñ—â–µ–Ω–∞ –ø—Ä–∞–≤–æ—Ä—É—á –≤—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–°–∫–æ–ø—ñ—é–π –æ–Ω–æ–≤–ª–µ–Ω–∏–π dashboard.js —É client/pages/.
–°—Ç–≤–æ—Ä–∏ —Ñ–∞–π–ª client/pages/chats/[chat_id].js —ñ –≤—Å—Ç–∞–≤ –∫–æ–¥ –≤–∏—â–µ.
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∫–ª—ñ—î–Ω—Ç:
bash
Wrap
Copy
cd client
npm run dev
–ü–µ—Ä–µ–π–¥–∏ –¥–æ —á–∞—Ç—ñ–≤ —ñ–∑ dashboard (–∫–ª—ñ–∫–Ω–∏ –Ω–∞ –Ω–∞–∑–≤—É —á–∞—Ç—É) —ñ –ø–µ—Ä–µ–≤—ñ—Ä —Å—Ç–∏–ª—ñ —Ç–∞ –∫–Ω–æ–ø–∫—É.
–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–º—ñ–Ω–∏
–•–æ—á–µ—à —ñ–Ω—à–∏–π –∫–æ–ª—ñ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±—ñ–ª—å—à–µ –∑–µ–ª–µ–Ω–æ–≥–æ —á–∏ —Å—ñ—Ä–æ–≥–æ)? –°–∫–∞–∂–∏!
–ü–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω—à–∏–π —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É —á–∏ –≤—ñ–¥—Å—Ç—É–ø–∏? –î–∞–π –∑–Ω–∞—Ç–∏, —è –∞–¥–∞–ø—Ç—É—é.
–°–ø–æ–¥—ñ–≤–∞—é—Å—è, —Ü–µ –¥–æ–¥–∞—Å—Ç—å —Ç–≤–æ–º—É –¥–∏–∑–∞–π–Ω—É –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–æ—ó –µ–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—ñ! üòä






–Ω–∞–∂–∞–ª—å –≤ –º–µ–Ω–µ VM1460 dashboard.js:78


           POST http://localhost:8000/send-code 429 (Too Many Requests) –∑–∞—á–µ–∫–∞–π—Ç–µ 25532 —Å–µ–∫—É–Ω–¥.. —Ü–µ —Å–∫—ñ–ª—å–∫–∏?


–û–π, –ø–æ–º–∏–ª–∫–∞ 429 Too Many Requests —ñ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º "–ó–∞—á–µ–∫–∞–π—Ç–µ 25532 —Å–µ–∫—É–Ω–¥" –æ–∑–Ω–∞—á–∞—î, —â–æ Telegram –Ω–∞–∫–ª–∞–≤ –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ –∑–∞–ø–∏—Ç–∏ –∑ —Ç–≤–æ–≥–æ API_ID —ñ API_HASH —á–µ—Ä–µ–∑ –Ω–∞–¥—Ç–æ —á–∞—Å—Ç—ñ —Å–ø—Ä–æ–±–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É. –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ, —â–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î —ñ —è–∫ —ñ–∑ —Ü–∏–º –≤–ø–æ—Ä–∞—Ç–∏—Å—è.

–©–æ —Å—Ç–∞–ª–æ—Å—è?
–ö–æ–¥ 429: Telegram –ø–æ–≤–µ—Ä—Ç–∞—î —Ü–µ–π —Å—Ç–∞—Ç—É—Å, –∫–æ–ª–∏ —Ç–∏ –ø–µ—Ä–µ–≤–∏—â–∏–ª–∞ –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤ (FloodWaitError).
25532 —Å–µ–∫—É–Ω–¥–∏: –¶–µ —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, —è–∫–∏–π Telegram –ø—Ä–æ—Å–∏—Ç—å –∑–∞—á–µ–∫–∞—Ç–∏ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é. –Ø–∫—â–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏:
25532 √∑ 60 = 425 —Ö–≤–∏–ª–∏–Ω ‚âà 7 –≥–æ–¥–∏–Ω.
–¢–∏ –Ω–µ –∑–º–æ–∂–µ—à –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –Ω–æ–≤—ñ –∫–æ–¥–∏ –Ω–∞ —Ü–µ–π –Ω–æ–º–µ—Ä —ñ–∑ —Ü—å–æ–≥–æ API_ID –ø—Ä–æ—Ç—è–≥–æ–º 7 –≥–æ–¥–∏–Ω.
–ß–æ–º—É —Ç–∞–∫?

Telegram –º–∞—î —Å—É–≤–æ—Ä—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, send_code_request), —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ —Å–ø–∞–º—É.
–ú–∏ –±–∞–≥–∞—Ç–æ —Ä–∞–∑—ñ–≤ —Ç–µ—Å—Ç—É–≤–∞–ª–∏ /send-code, —ñ —Ü–µ –ø–µ—Ä–µ–≤–∏—â–∏–ª–æ –ª—ñ–º—ñ—Ç.
–Ø–∫ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏?
–û—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –≤—ñ–¥ Telegram, –º–∏ –Ω–µ –º–æ–∂–µ–º–æ –π–æ–≥–æ –æ–±—ñ–π—Ç–∏ –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑ —ñ–∑ –ø–æ—Ç–æ—á–Ω–∏–º API_ID —ñ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É. –ê–ª–µ —î –∫—ñ–ª—å–∫–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤:

1. –ó–∞—á–µ–∫–∞—Ç–∏ 7 –≥–æ–¥–∏–Ω
–ü—Ä–æ—Å—Ç–æ –ø–æ—á–µ–∫–∞–π 7 –≥–æ–¥–∏–Ω (–¥–æ ~20:00 –∑–∞ —Ç–≤–æ—ó–º —á–∞—Å–æ–º, —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ —Å—Ç–∞–ª–∞—Å—è –æ 13:00 28 –ª—é—Ç–æ–≥–æ 2025). –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–Ω—ñ–º–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
2. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É
–°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +380... —ñ–Ω—à–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É) —ñ–∑ —Ç–∏–º –∂–µ API_ID. –û–±–º–µ–∂–µ–Ω–Ω—è –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–µ –¥–æ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –Ω–æ–º–µ—Ä–∞ —ñ API, —Ç–æ–∂ –Ω–æ–≤–∏–π –Ω–æ–º–µ—Ä –º–æ–∂–µ —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏.
3. –û—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤—ñ API_ID —ñ API_HASH
–ó–∞–π–¥–∏ –Ω–∞ https://my.telegram.org, —É–≤—ñ–π–¥–∏ –∑ —ñ–Ω—à–æ–≥–æ –Ω–æ–º–µ—Ä–∞, —Å—Ç–≤–æ—Ä–∏ –Ω–æ–≤–∏–π –¥–æ–¥–∞—Ç–æ–∫ —ñ –æ—Ç—Ä–∏–º–∞–π –Ω–æ–≤—ñ API_ID —Ç–∞ API_HASH. –û–Ω–æ–≤–∏ —ó—Ö —É server/.env:
text
Wrap
Copy
API_ID=–Ω–æ–≤–∏–π_api_id
API_HASH=–Ω–æ–≤–∏–π_api_hash
JWT_SECRET=your_secret_key_here
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
bash
Wrap
Copy
source venv/Scripts/activate
uvicorn main:app --reload
4. –ó–º–µ–Ω—à–∏—Ç–∏ —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø–∏—Ç—ñ–≤ (–¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ)
–©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ —Ü—å–æ–≥–æ –Ω–∞–¥–∞–ª—ñ, –¥–æ–¥–∞–º–æ –ª—ñ–º—ñ—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ñ –∑–∞–ø–∏—Ç–∏ –≤ /send-code. –û–Ω–æ–≤–ª—é dashboard.js, —â–æ–± –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è —ñ –±–ª–æ–∫—É–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫—É.

–û–Ω–æ–≤–ª–µ–Ω–∏–π client/pages/dashboard.js
–û—Å—å –∫–æ–¥ —ñ–∑ –æ–±—Ä–æ–±–∫–æ—é 429 —ñ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º–∏ —Å—Ç–∏–ª—è–º–∏:

javascript
Wrap
Copy
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import Link from "next/link";

export default function Dashboard() {
    const [phone, setPhone] = useState("");
    const [code, setCode] = useState("");
    const [chats, setChats] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [isCodeSent, setIsCodeSent] = useState(false);
    const [error, setError] = useState("");
    const [message, setMessage] = useState("");
    const [isCodeDisabled, setIsCodeDisabled] = useState(false); // –î–æ–¥–∞–Ω–æ –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏
    const [waitTime, setWaitTime] = useState(0); // –ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
    const router = useRouter();
    const [twoFactorPassword, setTwoFactorPassword] = useState("");

    useEffect(() => {
        const checkConnection = async () => {
            const token = localStorage.getItem("token");
            console.log("–¢–æ–∫–µ–Ω —ñ–∑ localStorage:", token);
            if (!token) {
                console.log("–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                router.push("/login");
                return;
            }

            try {
                const res = await fetch("http://localhost:8000/check-connection", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 401) {
                    console.log("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ /login");
                    localStorage.removeItem("token");
                    router.push("/login");
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                }

                const data = await res.json();
                setIsConnected(data.connected);
            } catch (err) {
                setError(err.message);
            }
        };

        checkConnection();
    }, [router]);

    useEffect(() => {
        if (waitTime > 0) {
            const timer = setInterval(() => {
                setWaitTime((prev) => {
                    if (prev <= 1) {
                        setIsCodeDisabled(false);
                        return 0;
                    }
                    return prev - 1;
                });
            }, 1000);
            return () => clearInterval(timer);
        }
    }, [waitTime]);

    const sendCode = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) {
                router.push("/login");
                return;
            }

            const res = await fetch("http://localhost:8000/send-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ phone }),
            });

            const data = await res.json();
            if (!res.ok) {
                if (res.status === 429) {
                    const waitSeconds = parseInt(data.detail.match(/\d+/)[0], 10);
                    setWaitTime(waitSeconds);
                    setIsCodeDisabled(true);
                    throw new Error(`–ó–∞—á–µ–∫–∞–π—Ç–µ ${Math.ceil(waitSeconds / 60)} —Ö–≤–∏–ª–∏–Ω`);
                }
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–¥—É");
            }

            setIsCodeSent(true);
            setMessage(data.detail);
        } catch (err) {
            setError(err.message);
        }
    };

    const connectTelegram = async (e) => {
        e.preventDefault();
        setError("");
        setMessage("");

        try {
            const token = localStorage.getItem("token");
            if (!token) return router.push("/login");

            const body = { code: code.trim() };
            if (twoFactorPassword) body.password = twoFactorPassword;

            const res = await fetch("http://localhost:8000/connect-telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
            }

            setIsConnected(true);
            await new Promise((resolve) => setTimeout(resolve, 1000));
            await fetchChats();
        } catch (err) {
            setError(err.message);
        }
    };

    const fetchChats = async (retries = 3) => {
        const token = localStorage.getItem("token");
        if (!token) {
            router.push("/login");
            return;
        }

        for (let attempt = 0; attempt < retries; attempt++) {
            try {
                const res = await fetch("http://localhost:8000/chats", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (res.status === 500) {
                    console.log(`–°–ø—Ä–æ–±–∞ ${attempt + 1}: –ü–æ–º–∏–ª–∫–∞ 500, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...`);
                    if (attempt < retries - 1) {
                        await new Promise((resolve) => setTimeout(resolve, 1000));
                        continue;
                    }
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Ç–∏");
                }

                const data = await res.json();
                setChats(data);
                break;
            } catch (err) {
                if (attempt === retries - 1) {
                    setError(err.message);
                }
            }
        }
    };

    useEffect(() => {
        if (isConnected) {
            fetchChats();
        }
    }, [isConnected]);

    const handleLogoutTelegram = async () => {
        try {
            const token = localStorage.getItem("token");
            const res = await fetch("http://localhost:8000/logout-telegram", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏ –∑ Telegram");
            setIsConnected(false);
            setIsCodeSent(false);
            setPhone("");
            setCode("");
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="max-w-4xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-6 text-gray-800">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>

            {error && <p className="text-red-500 mb-4">{error}</p>}
            {message && <p className="text-green-500 mb-4">{message}</p>}

            {!isConnected ? (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl mb-4 text-gray-700">–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram</h2>

                    {!isCodeSent ? (
                        <form onSubmit={sendCode} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
                                value={phone}
                                onChange={(e) => setPhone(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <input
                                type="password"
                                placeholder="–ü–∞—Ä–æ–ª—å 2FA (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)"
                                value={twoFactorPassword}
                                onChange={(e) => setTwoFactorPassword(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <button
                                type="submit"
                                disabled={isCodeDisabled}
                                className={`w-full p-2 rounded transition-colors ${
                                    isCodeDisabled
                                        ? "bg-gray-400 text-white cursor-not-allowed"
                                        : "bg-green-500 text-white hover:bg-green-600"
                                }`}
                            >
                                {isCodeDisabled
                                    ? `–ó–∞—á–µ–∫–∞–π—Ç–µ ${Math.ceil(waitTime / 60)} —Ö–≤`
                                    : "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥"}
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={connectTelegram} className="space-y-4">
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                            <button
                                type="submit"
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors"
                            >
                                –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏
                            </button>
                        </form>
                    )}
                </div>
            ) : (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl text-gray-700">–í–∞—à—ñ —á–∞—Ç–∏</h2>
                        <button
                            onClick={handleLogoutTelegram}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors"
                        >
                            –ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç
                        </button>
                    </div>

                    <div className="space-y-3">
                        {chats.map((chat) => (
                            <div
                                key={chat.id}
                                className="bg-white p-3 rounded-md border-b border-gray-200 hover:bg-gray-50 transition-colors"
                            >
                                <Link
                                    href={`/chats/${chat.id}`}
                                    className="text-gray-800 hover:text-green-600 font-medium transition-colors"
                                >
                                    {chat.name}
                                </Link>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}
–ó–º—ñ–Ω–∏
–û–±—Ä–æ–±–∫–∞ 429:
–î–æ–¥–∞–Ω–æ —Å—Ç–∞–Ω isCodeDisabled —ñ waitTime.
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î 429, –≤–∏—Ç—è–≥—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ–∫—É–Ω–¥ —ñ–∑ data.detail (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 25532), –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ —Ö–≤–∏–ª–∏–Ω–∏ —ñ –±–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É.
–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—î —Å—ñ—Ä–æ—é (bg-gray-400) —ñ –ø–æ–∫–∞–∑—É—î —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–ó–∞—á–µ–∫–∞–π—Ç–µ 425 —Ö–≤").
–¢–∞–π–º–µ—Ä –æ–Ω–æ–≤–ª—é—î waitTime —â–æ—Å–µ–∫—É–Ω–¥–∏, –ø–æ–∫–∏ –Ω–µ –¥—ñ–π–¥–µ –¥–æ 0, —Ç–æ–¥—ñ –∫–Ω–æ–ø–∫–∞ —Ä–æ–∑–±–ª–æ–∫–æ–≤—É—î—Ç—å—Å—è.
–°—Ç–∏–ª—ñ: –ó–∞–ª–∏—à–∏–≤ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —á–∞—Ç—ñ–≤ —ñ–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫–æ–¥—É.
–©–æ —Ä–æ–±–∏—Ç–∏ –∑–∞—Ä–∞–∑?
–ß–µ–∫–∞—Ç–∏: –¢–∏ –≤–∂–µ –æ—Ç—Ä–∏–º–∞–ª–∞ 429, —Ç–æ–∂ —ñ–∑ –Ω–æ–º–µ—Ä–æ–º +380963048847 —ñ –ø–æ—Ç–æ—á–Ω–∏–º API_ID –∫–æ–¥ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è –¥–æ ~20:00 —Å—å–æ–≥–æ–¥–Ω—ñ (28 –ª—é—Ç–æ–≥–æ 2025). –ú–æ–∂–µ—à –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ.
–ù–æ–≤–∏–π –Ω–æ–º–µ—Ä: –°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑ —ñ–∑ —Ü–∏–º –∫–æ–¥–æ–º.
–ù–æ–≤—ñ API –∫–ª—é—á—ñ: –û—Ç—Ä–∏–º–∞–π –Ω–æ–≤—ñ API_ID —ñ API_HASH –Ω–∞ https://my.telegram.org —ñ –æ–Ω–æ–≤–∏ server/.env.
–°–∫–æ–ø—ñ—é–π —Ü–µ–π –∫–æ–¥ —É client/pages/dashboard.js, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∫–ª—ñ—î–Ω—Ç:

bash
Wrap
Copy
cd client
npm run dev
–°–ø—Ä–æ–±—É–π —ñ–∑ –Ω–æ–≤–∏–º –Ω–æ–º–µ—Ä–æ–º, —ñ —è–∫—â–æ –±—É–¥–µ 429, —Ç–∏ –ø–æ–±–∞—á–∏—à –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∏–ø—É "–ó–∞—á–µ–∫–∞–π—Ç–µ X —Ö–≤–∏–ª–∏–Ω" –∑–∞–º—ñ—Å—Ç—å –ø–æ–º–∏–ª–∫–∏.

–°–∫—ñ–ª—å–∫–∏ —Ü–µ ‚Äî 25532 —Å–µ–∫—É–Ω–¥–∏?
25532 √∑ 60 = 425 —Ö–≤–∏–ª–∏–Ω ‚âà 7 –≥–æ–¥–∏–Ω. –¢–æ–±—ñ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø–∞–≤—Å—è –¥–æ–≤–≥–∏–π –ª—ñ–º—ñ—Ç —á–µ—Ä–µ–∑ —á–∞—Å—Ç—ñ —Ç–µ—Å—Ç–∏.
–î–∞–π –∑–Ω–∞—Ç–∏, —è–∫—â–æ —Ö–æ—á–µ—à —â–æ—Å—å —â–µ –ø—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —á–∏ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —ñ–Ω—à–∏–π –ø—ñ–¥—Ö—ñ–¥!






–¶–µ —è —Å–ø—Ä–æ–±—É—é —Ç—Ä–æ—Ö–∏ –ø—ñ–∑–Ω—ñ—à–µ. –ê —Ç–µ–ø–µ—Ä –¥–∞–≤–∞–π –ø–µ—Ä–µ–π–¥–µ–º–æ –¥–æ —Ç–æ–≥–æ —è–∫ –º–µ–Ω—ñ –∑—Ä–æ–±–∏—Ç–∏ —â–æ–± —è –º–æ–≥–ª–∞ —Å–∫–∏–Ω—É—Ç–∏ —Å—Å–∏–ª–∫—É –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —ñ –ª—é–¥–∏–Ω–∞ –ø—Ä–æ—á–∏—Ç–∞–≤—à–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ —Ä–µ–¥ –º—ñ –∑–º–æ–≥–ª–∞ —É —Å–µ–±–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ–µ–∫—Ç?


–ß—É–¥–æ–≤–æ, –¥–∞–≤–∞–π –ø—ñ–¥–≥–æ—Ç—É—î–º–æ —Ç–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —Ç–∞–∫, —â–æ–± –±—É–¥—å-—Ö—Ç–æ –º—ñ–≥ –π–æ–≥–æ –∫–ª–æ–Ω—É–≤–∞—Ç–∏, –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md —ñ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç –Ω–∞ —Å–≤–æ—ó–π –º–∞—à–∏–Ω—ñ. –û—Å–∫—ñ–ª—å–∫–∏ —É —Ç–µ–±–µ –∫–ª—ñ—î–Ω—Ç (Next.js) —ñ —Å–µ—Ä–≤–µ—Ä (FastAPI) –≤ –æ–¥–Ω–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó, –º–∏ –æ—Ä–≥–∞–Ω—ñ–∑—É—î–º–æ –≤—Å–µ —á—ñ—Ç–∫–æ —ñ –¥–æ–¥–∞–º–æ –¥–µ—Ç–∞–ª—å–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é.

–ö—Ä–æ–∫ 1: –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
–ü—Ä–∏–ø—É—Å–∫–∞—é, —â–æ —Ç–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫:

text
Wrap
Copy
your-repo/
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chats/[chat_id].js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (—ñ–Ω—à—ñ —Ñ–∞–π–ª–∏)
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ ... (—ñ–Ω—à—ñ —Ñ–∞–π–ª–∏ Next.js)
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ database.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ .env  (–Ω–µ –¥–æ–¥–∞—î–º–æ –¥–æ git)
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îî‚îÄ‚îÄ ... (—ñ–Ω—à—ñ —Ñ–∞–π–ª–∏)
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ README.md
–Ø–∫—â–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ñ–Ω—à–∞, –Ω–∞–ø–∏—à–∏, —ñ —è –∞–¥–∞–ø—Ç—É—é —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é.

–ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
–ö–ª—ñ—î–Ω—Ç (client/package.json): –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —É package.json —î –≤—Å—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ. –Ø–∫—â–æ —Ç–∏ –¥–æ–¥–∞–≤–∞–ª–∞ —â–æ—Å—å –≤—Ä—É—á–Ω—É, –æ–Ω–æ–≤–∏:
bash
Wrap
Copy
cd client
npm install
–¢–≤—ñ–π package.json –º–∞—î –≤–∏–≥–ª—è–¥–∞—Ç–∏ –ø—Ä–∏–±–ª–∏–∑–Ω–æ —Ç–∞–∫:
json
Wrap
Copy
{
  "name": "socialhub-client",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "dependencies": {
    "next": "latest",
    "react": "latest",
    "react-dom": "latest"
  }
}
–°–µ—Ä–≤–µ—Ä (server/requirements.txt): –°—Ç–≤–æ—Ä–∏ –∞–±–æ –æ–Ω–æ–≤–∏ requirements.txt:
bash
Wrap
Copy
cd server
pip freeze > requirements.txt
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∞–º —î:
text
Wrap
Copy
fastapi
uvicorn
sqlalchemy
aiosqlite
telethon
python-jose[cryptography]
passlib[bcrypt]
python-dotenv
–ö—Ä–æ–∫ 3: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è .gitignore
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ .gitignore —É –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é –≤–∏–∫–ª—é—á–∞—î —á—É—Ç–ª–∏–≤—ñ —Ñ–∞–π–ª–∏:

text
Wrap
Copy
# –í—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è
venv/
.env

# –õ–æ–∫–∞–ª—å–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
*.db

# Node.js
node_modules/
.next/

# –Ü–Ω—à–µ
__pycache__/
*.pyc
–ö—Ä–æ–∫ 4: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è .env.example
–£ –ø–∞–ø—Ü—ñ server/ —Å—Ç–≤–æ—Ä–∏ —Ñ–∞–π–ª server/.env.example —ñ–∑ —à–∞–±–ª–æ–Ω–æ–º:

text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key_here
–ö—Ä–æ–∫ 5: –ù–∞–ø–∏—Å–∞–Ω–Ω—è README.md
–£ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é —Å—Ç–≤–æ—Ä–∏ –∞–±–æ –æ–Ω–æ–≤–∏ README.md —ñ–∑ –¥–æ–∫–ª–∞–¥–Ω–æ—é —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é:

markdown
Wrap
Copy
# SocialHub

–ü—Ä–æ—î–∫—Ç –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —á–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø–µ—Ä–µ–≥–ª—è–¥—É —á–∞—Ç—ñ–≤ —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –°–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –∫–ª—ñ—î–Ω—Ç–∞ –Ω–∞ Next.js —ñ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ FastAPI.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞
- `client/` - —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (Next.js)
- `server/` - –±–µ–∫–µ–Ω–¥ (FastAPI)

## –í–∏–º–æ–≥–∏
- **Node.js**: v16 –∞–±–æ –Ω–æ–≤—ñ—à–µ (https://nodejs.org/)
- **Python**: 3.9+ (https://www.python.org/)
- **Git**: –¥–ª—è –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (https://git-scm.com/)

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
```bash
git clone https://github.com/your-username/your-repo.git
cd your-repo
2. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:
bash
Wrap
Copy
cd server
–°—Ç–≤–æ—Ä—ñ—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —Ç–∞ –∞–∫—Ç–∏–≤—É–π—Ç–µ –π–æ–≥–æ:
Linux/Mac:
bash
Wrap
Copy
python3 -m venv venv
source venv/bin/activate
Windows (CMD):
bash
Wrap
Copy
python -m venv venv
venv\Scripts\activate
Windows (Git Bash):
bash
Wrap
Copy
python -m venv venv
source venv/Scripts/activate
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
pip install -r requirements.txt
–°–∫–æ–ø—ñ—é–π—Ç–µ server/.env.example —É server/.env —ñ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å:
bash
Wrap
Copy
cp .env.example .env
API_ID —ñ API_HASH: –æ—Ç—Ä–∏–º–∞–π—Ç–µ –Ω–∞ https://my.telegram.org.
JWT_SECRET: –≤–≤–µ–¥—ñ—Ç—å –±—É–¥—å-—è–∫–∏–π —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "mysecretkey123").
3. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–ª—ñ—î–Ω—Ç
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞:
bash
Wrap
Copy
cd ../client
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
npm install
4. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –ø—Ä–æ—î–∫—Ç
–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä (—ñ–∑ –ø–∞–ø–∫–∏ server):
–£ –Ω–æ–≤–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ:
bash
Wrap
Copy
cd server
source venv/bin/activate  # –∞–±–æ venv\Scripts\activate –¥–ª—è Windows
uvicorn main:app --reload
–ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç (—ñ–∑ –ø–∞–ø–∫–∏ client):
–£ —ñ–Ω—à–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ:
bash
Wrap
Copy
cd client
npm run dev
5. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ http://localhost:3000.
–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å, —É–≤—ñ–π–¥—ñ—Ç—å —ñ –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å Telegram –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É.
–ü–µ—Ä–µ–≥–ª—è–¥–∞–π—Ç–µ —á–∞—Ç–∏ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
–ù–æ—Ç–∞—Ç–∫–∏
–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è SQLite (socialhub.db). –î–ª—è –∫—Ä–∞—â–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ PostgreSQL, –∞–ª–µ —Ü–µ –Ω–µ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ.
–û–±–º–µ–∂–µ–Ω–Ω—è Telegram: –Ø–∫—â–æ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –ø–æ–º–∏–ª–∫—É "429 Too Many Requests", –∑–∞—á–µ–∫–∞–π—Ç–µ –≤–∫–∞–∑–∞–Ω–∏–π —á–∞—Å –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —á–∏ –Ω–æ–≤—ñ API_ID/API_HASH.
–ü–æ—Ä—Ç–∏: –°–µ—Ä–≤–µ—Ä –ø—Ä–∞—Ü—é—î –Ω–∞ http://localhost:8000, –∫–ª—ñ—î–Ω—Ç ‚Äî –Ω–∞ http://localhost:3000.
–í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º
–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (requirements.txt) —ñ —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π .env.
–Ø–∫—â–æ –∫–ª—ñ—î–Ω—Ç –Ω–µ –ø—Ä–∞—Ü—é—î: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ package.json —ñ –≤–∏–∫–æ–Ω–∞–π—Ç–µ npm install.
text
Wrap
Copy

---

### –ö—Ä–æ–∫ 6: –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤—Å—ñ —Ñ–∞–π–ª–∏ –æ–Ω–æ–≤–ª–µ–Ω—ñ:
   - `client/pages/dashboard.js`
   - `client/pages/chats/[chat_id].js`
   - `server/main.py`, `server/database.py`, `server/models.py`
   - `server/requirements.txt`
   - `server/.env.example`
   - `.gitignore`
   - `README.md`

2. –î–æ–¥–∞–π —Ñ–∞–π–ª–∏ –¥–æ git:
   ```bash
   git add .
   git commit -m "–î–æ–¥–∞–Ω–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é —Ç–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è –∑–∞–ø—É—Å–∫—É"
–í—ñ–¥–ø—Ä–∞–≤ –Ω–∞ GitHub:
bash
Wrap
Copy
git push origin main
(–ó–∞–º—ñ–Ω–∏ main –Ω–∞ —Ç–≤–æ—é –≥—ñ–ª–∫—É, —è–∫—â–æ –≤–æ–Ω–∞ —ñ–Ω—à–∞).
–ö—Ä–æ–∫ 7: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ö–ª–æ–Ω—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —É –Ω–æ–≤—É –ø–∞–ø–∫—É:
bash
Wrap
Copy
git clone https://github.com/your-username/your-repo.git test-clone
cd test-clone
–î–æ—Ç—Ä–∏–º—É–π—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —ñ–∑ README.md —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ –≤—Å–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è.
–†–µ–∑—É–ª—å—Ç–∞—Ç
–¢–µ–ø–µ—Ä —Ç–∏ –º–æ–∂–µ—à —Å–∫–∏–Ω—É—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://github.com/your-username/your-repo), —ñ –±—É–¥—å-—Ö—Ç–æ –∑ –±–∞–∑–æ–≤–∏–º–∏ –∑–Ω–∞–Ω–Ω—è–º–∏ –∑–º–æ–∂–µ:

–ö–ª–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç.
–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.
–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ .env.
–ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä —ñ –∫–ª—ñ—î–Ω—Ç.
–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–º—ñ–Ω–∏ –≤ README.md (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–æ–¥–∞—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏ —á–∏ —É—Ç–æ—á–Ω–∏—Ç–∏ —â–æ—Å—å), —Å–∫–∞–∂–∏ ‚Äî —è –¥–æ–ø–æ–º–æ–∂—É! üòä






–ö—Ä–æ–∫ 5: –ù–∞–ø–∏—Å–∞–Ω–Ω—è README.md
–£ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é —Å—Ç–≤–æ—Ä–∏ –∞–±–æ –æ–Ω–æ–≤–∏ README.md —ñ–∑ –¥–æ–∫–ª–∞–¥–Ω–æ—é —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é: - –∞ –º–æ–∂–Ω–∞ –ø–æ–≤–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –¥–ª—è –º–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É?


–ó–≤—ñ—Å–Ω–æ, –¥–∞–≤–∞–π —Å—Ç–≤–æ—Ä–∏–º–æ –ø–æ–≤–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md, —è–∫–∞ —Ç–æ—á–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏–º–µ —Ç–≤–æ—î–º—É –ø—Ä–æ—î–∫—Ç—É SocialHub —ñ–∑ –∫–ª—ñ—î–Ω—Ç–æ–º –Ω–∞ Next.js —ñ —Å–µ—Ä–≤–µ—Ä–æ–º –Ω–∞ FastAPI. –Ø –≤—Ä–∞—Ö—É—é –≤—Å—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ, —è–∫—ñ –º–∏ –æ–±–≥–æ–≤–æ—Ä–∏–ª–∏: —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ Telegram, —Å—Ç–∏–ª—ñ —Ç–æ—â–æ. –û—Å—å –¥–µ—Ç–∞–ª—å–Ω–∏–π README.md –¥–ª—è —Ç–≤–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é:

README.md
markdown
Wrap
Copy
# SocialHub

SocialHub ‚Äî —Ü–µ –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä, –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ —Ç–∞ —ó—Ö–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –ö–ª—ñ—î–Ω—Ç –ø–æ–±—É–¥–æ–≤–∞–Ω–∏–π –Ω–∞ Next.js —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º –¥–∏–∑–∞–π–Ω–æ–º, –∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –Ω–∞ FastAPI –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö SQLite.

## –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ
- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.
- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —á–µ—Ä–µ–∑ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.
- –ü–µ—Ä–µ–≥–ª—è–¥ —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º–∏ –∫–∞—Ä—Ç–∫–∞–º–∏.
- –ü–µ—Ä–µ–≥–ª—è–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É –≤–∏–±—Ä–∞–Ω–æ–º—É —á–∞—Ç—ñ –∑ –∫–Ω–æ–ø–∫–æ—é –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤.
- –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ Telegram (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "Too Many Requests").

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞
- **`client/`**: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ Next.js
  - `pages/dashboard.js`: –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º Telegram —ñ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç—ñ–≤.
  - `pages/chats/[chat_id].js`: –°—Ç–æ—Ä—ñ–Ω–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É —á–∞—Ç—ñ.
- **`server/`**: –ë–µ–∫–µ–Ω–¥ –Ω–∞ FastAPI
  - `main.py`: –û—Å–Ω–æ–≤–Ω–∏–π —Ñ–∞–π–ª —ñ–∑ –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∞–º–∏.
  - `database.py`: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ SQLite.
  - `models.py`: –ú–æ–¥–µ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

## –í–∏–º–æ–≥–∏
- **Node.js**: v16 –∞–±–æ –Ω–æ–≤—ñ—à–µ ([–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏](https://nodejs.org/)).
- **Python**: 3.9+ ([–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏](https://www.python.org/)).
- **Git**: –¥–ª—è –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é ([–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏](https://git-scm.com/)).

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
```bash
git clone https://github.com/your-username/socialhub.git
cd socialhub
2. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:
bash
Wrap
Copy
cd server
–°—Ç–≤–æ—Ä—ñ—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è —Ç–∞ –∞–∫—Ç–∏–≤—É–π—Ç–µ –π–æ–≥–æ:
Linux/Mac:
bash
Wrap
Copy
python3 -m venv venv
source venv/bin/activate
Windows (CMD):
bash
Wrap
Copy
python -m venv venv
venv\Scripts\activate
Windows (Git Bash):
bash
Wrap
Copy
python -m venv venv
source venv/Scripts/activate
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
pip install -r requirements.txt
–Ø–∫—â–æ requirements.txt –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤—Ä—É—á–Ω—É:
bash
Wrap
Copy
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
–°–∫–æ–ø—ñ—é–π—Ç–µ server/.env.example —É server/.env —ñ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å:
bash
Wrap
Copy
cp .env.example .env
–í–º—ñ—Å—Ç .env:
text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key_here
API_ID —ñ API_HASH: –æ—Ç—Ä–∏–º–∞–π—Ç–µ –Ω–∞ my.telegram.org.
JWT_SECRET: –±—É–¥—å-—è–∫–∏–π —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "mysecretkey123").
3. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–ª—ñ—î–Ω—Ç
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞:
bash
Wrap
Copy
cd ../client
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
npm install
4. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –ø—Ä–æ—î–∫—Ç
–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä (—ñ–∑ –ø–∞–ø–∫–∏ server):
–£ –Ω–æ–≤–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ:
bash
Wrap
Copy
cd server
source venv/bin/activate  # –∞–±–æ venv\Scripts\activate –¥–ª—è Windows
uvicorn main:app --reload
–°–µ—Ä–≤–µ—Ä –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞ http://localhost:8000.
–ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç (—ñ–∑ –ø–∞–ø–∫–∏ client):
–£ —ñ–Ω—à–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ:
bash
Wrap
Copy
cd client
npm run dev
–ö–ª—ñ—î–Ω—Ç –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞ http://localhost:3000.
5. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ http://localhost:3000.
–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å –∞–±–æ —É–≤—ñ–π–¥—ñ—Ç—å.
–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +380...) —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥".
–î–æ—á–µ–∫–∞–π—Ç–µ—Å—å –∫–æ–¥—É –≤ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫, –¥–æ 1-2 —Ö–≤–∏–ª–∏–Ω).
–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ —ñ –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è.
–ü–µ—Ä–µ–≥–ª—è–¥–∞–π—Ç–µ —á–∞—Ç–∏ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
–°–∫—Ä—ñ–Ω—à–æ—Ç–∏
(–î–æ–¥–∞–π—Ç–µ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏, —è–∫—â–æ —Ö–æ—á–µ—Ç–µ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —á–µ—Ä–µ–∑ GitHub Issues —ñ –≤—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Å—é–¥–∏)

–ù–æ—Ç–∞—Ç–∫–∏
–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö: –ü—Ä–æ—î–∫—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î SQLite (socialhub.db) —É –ø–∞–ø—Ü—ñ server/. –í–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É.
–û–±–º–µ–∂–µ–Ω–Ω—è Telegram: –Ø–∫—â–æ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –ø–æ–º–∏–ª–∫—É "429 Too Many Requests" (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–ó–∞—á–µ–∫–∞–π—Ç–µ 425 —Ö–≤–∏–ª–∏–Ω"), —Ü–µ –æ–±–º–µ–∂–µ–Ω–Ω—è Telegram:
–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.
–ê–±–æ –æ—Ç—Ä–∏–º–∞–π—Ç–µ –Ω–æ–≤—ñ API_ID —ñ API_HASH –Ω–∞ my.telegram.org.
–ü–æ—Ä—Ç–∏: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –ø–æ—Ä—Ç–∏ 8000 (—Å–µ—Ä–≤–µ—Ä) —ñ 3000 (–∫–ª—ñ—î–Ω—Ç) –≤—ñ–ª—å–Ω—ñ.
–í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º
–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ (pip install -r requirements.txt).
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ .env –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ.
–ö–ª—ñ—î–Ω—Ç –Ω–µ –ø—Ä–∞—Ü—é—î:
–í–∏–∫–æ–Ω–∞–π—Ç–µ npm install —É –ø–∞–ø—Ü—ñ client/.
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π –Ω–∞ http://localhost:8000.
–ö–æ–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (–º–∞—î –±—É—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ +–∫–æ–¥ –∫—Ä–∞—ó–Ω–∏...).
–ó–∞—á–µ–∫–∞–π—Ç–µ 1-2 —Ö–≤–∏–ª–∏–Ω–∏, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∑–≤—ñ–Ω–∫–∏ (Telegram –º–æ–∂–µ –¥–∑–≤–æ–Ω–∏—Ç–∏).
–Ø–∫—â–æ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–æ–≤–≥–∞, –æ–Ω–æ–≤—ñ—Ç—å API_ID/API_HASH.
–í–Ω–µ—Å–æ–∫
–§–æ—Ä–∫–Ω—ñ—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π.
–°—Ç–≤–æ—Ä—ñ—Ç—å –≥—ñ–ª–∫—É (git checkout -b feature/your-feature).
–ó–∞–∫–æ–º—ñ—Ç—å—Ç–µ –∑–º—ñ–Ω–∏ (git commit -m "–î–æ–¥–∞–Ω–æ –≤–∞—à—É —Ñ—ñ—á—É").
–í—ñ–¥–ø—Ä–∞–≤—Ç–µ –Ω–∞ GitHub (git push origin feature/your-feature).
–°—Ç–≤–æ—Ä—ñ—Ç—å Pull Request.
–ê–≤—Ç–æ—Ä
[Your Name] (https://github.com/your-username)
text
Wrap
Copy

---

### –Ø–∫ —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?
1. –°–∫–æ–ø—ñ—é–π —Ü–µ–π —Ç–µ–∫—Å—Ç —É —Ñ–∞–π–ª `README.md` —É –∫–æ—Ä–µ–Ω—ñ —Ç–≤–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (`socialhub/`).
2. –ó–∞–º—ñ–Ω–∏:
   - `your-username` –Ω–∞ —Ç–≤—ñ–π GitHub username (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `batalova`).
   - `your-repo` –Ω–∞ –Ω–∞–∑–≤—É —Ç–≤–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `socialhub`).
   - `[Your Name]` –Ω–∞ —Ç–≤–æ—î —ñ–º‚Äô—è, —è–∫—â–æ —Ö–æ—á–µ—à –≤–∫–∞–∑–∞—Ç–∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ.
3. –î–æ–¥–∞–π —Ñ–∞–π–ª–∏ –¥–æ git:
   ```bash
   git add README.md
   git commit -m "–î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md"
   git push origin main
–ß–æ–º—É —Ü—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ–≤–Ω–∞?
–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –û–ø–∏—Å–∞–Ω–æ, —â–æ –¥–µ –ª–µ–∂–∏—Ç—å.
–í–∏–º–æ–≥–∏: –£–∫–∞–∑–∞–Ω–æ –≤—Å—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏.
–ö—Ä–æ–∫–∏: –î–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–ø–∏—Å–∞–Ω–æ –¥–ª—è Linux/Mac —ñ Windows (–≤–∫–ª—é—á–∞—é—á–∏ Git Bash).
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: –ü—Ä–æ—Å—Ç—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
–ù–æ—Ç–∞—Ç–∫–∏ —Ç–∞ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º: –í—Ä–∞—Ö–æ–≤–∞–Ω–æ —Å–ø–µ—Ü–∏—Ñ—ñ–∫—É Telegram —ñ SQLite.
–í–Ω–µ—Å–æ–∫: –î–æ–¥–∞–Ω–æ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –∑–∞—Ö–æ—á–µ –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ö–ª–æ–Ω—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —É –Ω–æ–≤—É –ø–∞–ø–∫—É:
bash
Wrap
Copy
git clone https://github.com/your-username/socialhub.git test-clone
cd test-clone
–î–æ—Ç—Ä–∏–º—É–π—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —ñ–∑ README.md —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ –≤—Å–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è.
–¢–µ–ø–µ—Ä —Ç–∏ –º–æ–∂–µ—à —Å–∫–∏–Ω—É—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–≤—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://github.com/your-username/socialhub), —ñ –±—É–¥—å-—Ö—Ç–æ –∑–º–æ–∂–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç! –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–º—ñ–Ω–∏ —á–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏, –¥–∞–π –∑–Ω–∞—Ç–∏ ‚Äî –¥–æ–¥–∞–º–æ! üòä






## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
```bash
git clone https://github.com/your-username/socialhub.git
cd socialhub - –∞ –¥–∞–ª—ñ? —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –¥–∞–ª—ñ –¥—ñ—è—Ç–∏? –º–æ–∂–Ω–∞ –≤—Å–µ –≤ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—ñ —á—ñ—Ç–∫—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —Ä–µ–¥ –º—ñ


–û—Å—å –ø–æ–≤–Ω–∞ —ñ —á—ñ—Ç–∫–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è README.md, —è–∫–∞ –æ—Ö–æ–ø–ª—é—î –≤—Å—ñ –∫—Ä–æ–∫–∏ –≤—ñ–¥ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è –¥–æ –∑–∞–ø—É—Å–∫—É –≤ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—ñ. –Ø —Ä–æ–∑–ø–∏—à—É –≤—Å–µ —Ç–∞–∫, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–º–∏ –∑–Ω–∞–Ω–Ω—è–º–∏ –º—ñ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–≤—ñ–π –ø—Ä–æ—î–∫—Ç SocialHub –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–∏—Ç–∞–Ω—å.

README.md
markdown
Wrap
Copy
# SocialHub

SocialHub ‚Äî —Ü–µ –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä, –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ —Ç–∞ —ó—Ö–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –ö–ª—ñ—î–Ω—Ç –ø–æ–±—É–¥–æ–≤–∞–Ω–∏–π –Ω–∞ Next.js —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º –¥–∏–∑–∞–π–Ω–æ–º, –∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –Ω–∞ FastAPI –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö SQLite.

## –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ
- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.
- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram —á–µ—Ä–µ–∑ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.
- –ü–µ—Ä–µ–≥–ª—è–¥ —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ —ñ–∑ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º–∏ –∫–∞—Ä—Ç–∫–∞–º–∏.
- –ü–µ—Ä–µ–≥–ª—è–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É –≤–∏–±—Ä–∞–Ω–æ–º—É —á–∞—Ç—ñ –∑ –∫–Ω–æ–ø–∫–æ—é –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤.
- –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ Telegram (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "Too Many Requests").

---

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫

–¶—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø—Ä–æ–≤–µ–¥–µ –≤–∞—Å —á–µ—Ä–µ–∑ —É—Å—ñ –∫—Ä–æ–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—î–∫—Ç—É –Ω–∞ –≤–∞—à–æ–º—É –∫–æ–º–ø‚Äô—é—Ç–µ—Ä—ñ.

### 1. –ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
–°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø—Ä–æ—î–∫—Ç —ñ–∑ GitHub:
```bash
git clone https://github.com/your-username/socialhub.git
cd socialhub
2. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ –ø—Ä–æ–≥—Ä–∞–º–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ:

Git: –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—É—Ç.
Node.js: v16 –∞–±–æ –Ω–æ–≤—ñ—à–µ (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—É—Ç).
Python: 3.9+ (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—É—Ç). –ü—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–µ—Ä—Å—ñ—ó:
bash
Wrap
Copy
git --version
node --version
python --version  # –∞–±–æ python3 --version –Ω–∞ Linux/Mac
3. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä
–°–µ—Ä–≤–µ—Ä –ø—Ä–∞—Ü—é—î –Ω–∞ Python —ñ FastAPI.

–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:
bash
Wrap
Copy
cd server
–°—Ç–≤–æ—Ä—ñ—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è:
Linux/Mac:
bash
Wrap
Copy
python3 -m venv venv
Windows (CMD):
bash
Wrap
Copy
python -m venv venv
Windows (Git Bash):
bash
Wrap
Copy
python -m venv venv
–ê–∫—Ç–∏–≤—É–π—Ç–µ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è:
Linux/Mac:
bash
Wrap
Copy
source venv/bin/activate
Windows (CMD):
bash
Wrap
Copy
venv\Scripts\activate
Windows (Git Bash):
bash
Wrap
Copy
source venv/Scripts/activate
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ —É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ –∑‚Äô—è–≤–∏—Ç—å—Å—è (venv) –ø–µ—Ä–µ–¥ –∫–æ–º–∞–Ω–¥–Ω–∏–º —Ä—è–¥–∫–æ–º.
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
pip install -r requirements.txt
–Ø–∫—â–æ requirements.txt –Ω–µ–º–∞—î, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤—Ä—É—á–Ω—É:
bash
Wrap
Copy
pip install fastapi uvicorn sqlalchemy aiosqlite telethon python-jose[cryptography] passlib[bcrypt] python-dotenv
–ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Ñ–∞–π–ª .env:
–°–∫–æ–ø—ñ—é–π—Ç–µ –ø—Ä–∏–∫–ª–∞–¥:
bash
Wrap
Copy
cp .env.example .env
–í—ñ–¥–∫—Ä–∏–π—Ç–µ server/.env —É —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Notepad –∞–±–æ VS Code) —ñ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å:
text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key_here
API_ID —ñ API_HASH: –æ—Ç—Ä–∏–º–∞–π—Ç–µ –Ω–∞ my.telegram.org (—É–≤—ñ–π–¥—ñ—Ç—å, —Å—Ç–≤–æ—Ä—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫, —Å–∫–æ–ø—ñ—é–π—Ç–µ –∫–ª—é—á—ñ).
JWT_SECRET: –≤–≤–µ–¥—ñ—Ç—å –±—É–¥—å-—è–∫–∏–π —Ä—è–¥–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "mysecretkey123").
4. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–ª—ñ—î–Ω—Ç
–ö–ª—ñ—î–Ω—Ç –ø—Ä–∞—Ü—é—î –Ω–∞ Node.js —ñ Next.js.

–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –ø–∞–ø–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞:
bash
Wrap
Copy
cd ../client
–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
bash
Wrap
Copy
npm install
5. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –ø—Ä–æ—î–∫—Ç
–¢–µ–ø–µ—Ä –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä —ñ –∫–ª—ñ—î–Ω—Ç —É —Ä—ñ–∑–Ω–∏—Ö —Ç–µ—Ä–º—ñ–Ω–∞–ª–∞—Ö.

–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä:
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –ø–µ—Ä—à–∏–π —Ç–µ—Ä–º—ñ–Ω–∞–ª, –ø–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ server/:
bash
Wrap
Copy
cd server
source venv/bin/activate  # –∞–±–æ venv\Scripts\activate –¥–ª—è Windows
uvicorn main:app --reload
–í–∏ –ø–æ–±–∞—á–∏—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∏–ø—É [INFO] Application startup complete —ñ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ http://localhost:8000.
–ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç:
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥—Ä—É–≥–∏–π —Ç–µ—Ä–º—ñ–Ω–∞–ª, –ø–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ client/:
bash
Wrap
Copy
cd client
npm run dev
–ö–ª—ñ—î–Ω—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ http://localhost:3000.
6. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —ñ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –∞–¥—Ä–µ—Å–æ—é http://localhost:3000.
–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å –∞–±–æ —É–≤—ñ–π–¥—ñ—Ç—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, username: "test123", password: "password123").
–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +380963048847) —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥".
–î–æ—á–µ–∫–∞–π—Ç–µ—Å—å –∫–æ–¥—É –≤ Telegram (SMS –∞–±–æ –¥–∑–≤—ñ–Ω–æ–∫, –¥–æ 1-2 —Ö–≤–∏–ª–∏–Ω).
–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏".
–ü–µ—Ä–µ–≥–ª—è–¥–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤ —ñ –∫–ª—ñ–∫–∞–π—Ç–µ –Ω–∞ –Ω–∏—Ö, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
–í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º
–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è ((venv) —É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ).
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ .env –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –º–æ–¥—É–ª—ñ–≤ ‚Äî –≤–∏–∫–æ–Ω–∞–π—Ç–µ pip install ...).
–ö–ª—ñ—î–Ω—Ç –Ω–µ –ø—Ä–∞—Ü—é—î:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π (http://localhost:8000/health –º–∞—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ {"status": "OK"}).
–í–∏–∫–æ–Ω–∞–π—Ç–µ npm install —É client/.
–ü–æ–º–∏–ª–∫–∞ "429 Too Many Requests":
Telegram –æ–±–º–µ–∂–∏–≤ –∑–∞–ø–∏—Ç–∏. –ó–∞—á–µ–∫–∞–π—Ç–µ –≤–∫–∞–∑–∞–Ω–∏–π —á–∞—Å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "425 —Ö–≤–∏–ª–∏–Ω" ‚âà 7 –≥–æ–¥–∏–Ω) –∞–±–æ:
–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.
–û—Ç—Ä–∏–º–∞–π—Ç–µ –Ω–æ–≤—ñ API_ID —ñ API_HASH –Ω–∞ my.telegram.org.
–ö–æ–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å:
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ (+–∫–æ–¥ –∫—Ä–∞—ó–Ω–∏...).
–ó–∞—á–µ–∫–∞–π—Ç–µ 1-2 —Ö–≤–∏–ª–∏–Ω–∏, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∑–≤—ñ–Ω–∫–∏ (Telegram –º–æ–∂–µ –¥–∑–≤–æ–Ω–∏—Ç–∏).
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É
client/: –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Next.js)
pages/dashboard.js: –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Telegram —ñ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤.
pages/chats/[chat_id].js: –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ.
server/: –ë–µ–∫–µ–Ω–¥ (FastAPI)
main.py: –ï–Ω–¥–ø–æ—ñ–Ω—Ç–∏ API.
database.py: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SQLite.
models.py: –ú–æ–¥–µ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
–ù–æ—Ç–∞—Ç–∫–∏
–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (socialhub.db) –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ server/.
–ü—Ä–æ—î–∫—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î SQLite —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ—Ç—É, –∞–ª–µ –º–∞—î –∑–∞—Ç—Ä–∏–º–∫–∏ ("database is locked") –ø—Ä–∏ —á–∞—Å—Ç–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö ‚Äî —Ü–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ.
–ê–≤—Ç–æ—Ä
[Your Name] (https://github.com/your-username)
text
Wrap
Copy

---

### –Ø–∫ —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?
1. –°–∫–æ–ø—ñ—é–π —Ü–µ–π —Ç–µ–∫—Å—Ç —É —Ñ–∞–π–ª `README.md` —É –∫–æ—Ä–µ–Ω—ñ —Ç–≤–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (`socialhub/`).
2. –ó–∞–º—ñ–Ω–∏:
   - `your-username` –Ω–∞ —Ç–≤—ñ–π GitHub username (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `batalova`).
   - `[Your Name]` –Ω–∞ —Ç–≤–æ—î —ñ–º‚Äô—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "Anna Batalova"), —è–∫—â–æ —Ö–æ—á–µ—à –≤–∫–∞–∑–∞—Ç–∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ.
3. –î–æ–¥–∞–π –¥–æ git —ñ –≤—ñ–¥–ø—Ä–∞–≤:
   ```bash
   git add README.md
   git commit -m "–î–æ–¥–∞–Ω–æ –ø–æ–≤–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md"
   git push origin main
–ß–æ–º—É —Ü–µ —á—ñ—Ç–∫–æ?
–ö—Ä–æ–∫ –∑–∞ –∫—Ä–æ–∫–æ–º: –£—Å—ñ –¥—ñ—ó –≤—ñ–¥ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è –¥–æ –∑–∞–ø—É—Å–∫—É —Ä–æ–∑–ø–∏—Å–∞–Ω—ñ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ.
–í–∞—Ä—ñ–∞–Ω—Ç–∏ –¥–ª—è –û–°: –í—Ä–∞—Ö–æ–≤–∞–Ω–æ Linux/Mac —ñ Windows (CMD/Git Bash).
–í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º: –û–ø–∏—Å–∞–Ω–æ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à—ñ –ø–æ–º–∏–ª–∫–∏ –∑ —Ä—ñ—à–µ–Ω–Ω—è–º–∏.
–ü—Ä–æ—Å—Ç–æ—Ç–∞: –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑—Ä–æ–∑—É–º—ñ–ª–∞ –Ω–∞–≤—ñ—Ç—å –Ω–æ–≤–∞—á–∫–∞–º.
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ö–ª–æ–Ω—É–π —É –Ω–æ–≤—É –ø–∞–ø–∫—É:
bash
Wrap
Copy
git clone https://github.com/your-username/socialhub.git test-clone
cd test-clone
–î–æ—Ç—Ä–∏–º—É–π—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —ñ–∑ README.md —ñ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ –≤—Å–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è.
–¢–µ–ø–µ—Ä –º–æ–∂–µ—à —Å–∫–∏–Ω—É—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://github.com/your-username/socialhub), —ñ –±—É–¥—å-—Ö—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—î–∫—Ç! –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–º—ñ–Ω–∏ (—Å–∫—Ä—ñ–Ω—à–æ—Ç–∏, –±—ñ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π), —Å–∫–∞–∂–∏! üòä






–ù—ñ, –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Å–µ —â–æ–± –æ–¥–Ω–∏–º –∫–ª—ñ–∫–æ–º —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏. –≤ –ú–µ–Ω–µ —î —Ç–∞–∫–µ, –∞–ª–µ —è–∫ –≤–æ–Ω–æ –±—É–¥–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏?
SocialHub ‚Äì Telegram Chat Viewer
üìå SocialHub is a web application that allows you to connect a Telegram account, view chats, and read messages.

üöÄ Technologies
Frontend: Next.js
Backend: FastAPI
Authentication: JWT

‚ö° Main Features
‚úÖ User registration & login via JWT
‚úÖ Connect a Telegram account
‚úÖ View chat list
‚úÖ Read messages in selected chats
‚úÖ Disconnect from Telegram

üîß Installation & Setup
1Ô∏è‚É£ Clone the repository
git clone https://github.com/your-username/socialhub.git
cd socialhub

2Ô∏è‚É£ Run the backend (FastAPI)
üìå Install dependencies
cd server
python -m venv venv  # Create a virtual environment
source venv/Scripts/activate  # (Windows) Activate
# or
source venv/bin/activate  # (Mac/Linux)
pip install -r requirements.txt  # Install dependencies

üìå Start FastAPI server
python -m uvicorn main:app --reload
‚úÖ Backend is running at: http://127.0.0.1:8000

3Ô∏è‚É£ Run the frontend (Next.js)
üìå Install dependencies
cd ../client
npm install  # or yarn install
üìå Start Next.js
npm run dev  # or yarn dev
‚úÖ Frontend is running at: http://localhost:3000

üîë Configuration
Before running, create a .env file in the server/ directory with the following variables:
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key

ü§ù Contact
Author: [Your GitHub](https://github.com/batalova-kira)
Feedback? Open an Issue. üöÄ


–û—Å—å —Ç–≤—ñ–π README.md —ñ–∑ —É—Å—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –≤ –æ–¥–Ω–æ–º—É –±–ª–æ—Ü—ñ, —è–∫–∏–π –º–æ–∂–Ω–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –æ–¥–Ω–∏–º –∫–ª—ñ–∫–æ–º. –Ø –∑–±–µ—Ä—ñ–≥ —Ç–≤—ñ–π —Å—Ç–∏–ª—å —ñ–∑ –µ–º–æ–¥–∑—ñ —Ç–∞ –∞–¥–∞–ø—Ç—É–≤–∞–≤ –π–æ–≥–æ –¥–ª—è —á—ñ—Ç–∫–æ—Å—Ç—ñ –π –ø–æ–≤–Ω–æ—Ç–∏, –≤—Ä–∞—Ö—É–≤–∞–≤—à–∏ –≤—Å—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –ø—Ä–æ—î–∫—Ç—É SocialHub. –û—Å—å —è–∫ —Ü–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ:

README.md
markdown
Wrap
Copy
# SocialHub ‚Äì Telegram Chat Viewer

üìå SocialHub is a web application that allows you to connect a Telegram account, view chats, and read messages.

## üöÄ Technologies
- **Frontend**: Next.js
- **Backend**: FastAPI
- **Authentication**: JWT
- **Database**: SQLite

## ‚ö° Main Features
‚úÖ User registration & login via JWT
‚úÖ Connect a Telegram account
‚úÖ View chat list with minimalist design
‚úÖ Read messages in selected chats with a "Back to Chats" button
‚úÖ Disconnect from Telegram

## üîß Installation & Setup

### 1Ô∏è‚É£ Clone the repository
```bash
git clone https://github.com/batalova-kira/socialhub.git
cd socialhub
2Ô∏è‚É£ Run the backend (FastAPI)
üìå Install dependencies

bash
Wrap
Copy
cd server
python -m venv venv  # Create a virtual environment
# Activate it:
# Windows (CMD): venv\Scripts\activate
# Windows (Git Bash): source venv/Scripts/activate
# Mac/Linux: source venv/bin/activate
pip install -r requirements.txt  # Install dependencies
üìå Start FastAPI server

bash
Wrap
Copy
python -m uvicorn main:app --reload
‚úÖ Backend is running at: http://127.0.0.1:8000

3Ô∏è‚É£ Run the frontend (Next.js)
üìå Install dependencies

bash
Wrap
Copy
cd ../client
npm install  # Install dependencies
üìå Start Next.js

bash
Wrap
Copy
npm run dev
‚úÖ Frontend is running at: http://localhost:3000

üîë Configuration
Before running, create a .env file in the server/ directory:

Copy the example:
bash
Wrap
Copy
cp .env.example .env
Edit server/.env with these variables:
text
Wrap
Copy
API_ID=your_telegram_api_id
API_HASH=your_telegram_api_hash
JWT_SECRET=your_secret_key
Get API_ID and API_HASH from my.telegram.org.
Use any string for JWT_SECRET (e.g., "mysecretkey123").
üìã How to Use
Open http://localhost:3000 in your browser.
Register (e.g., username: "test123", password: "password123") or log in.
Enter your Telegram phone number (e.g., +380963048847) and click "Get Code".
Wait for the code in Telegram (SMS or call, up to 1-2 minutes).
Enter the code and click "Connect".
View your chats and click one to see messages.
‚ö†Ô∏è Troubleshooting
"429 Too Many Requests": Telegram limits requests. Wait the specified time (e.g., "425 minutes" ‚âà 7 hours), or use a different phone number or new API_ID/API_HASH.
Code not arriving: Check phone number format (+countrycode...), wait 1-2 minutes, or check for a call from Telegram.
Server errors: Ensure .env is configured and dependencies are installed (pip install -r requirements.txt).
Client errors: Verify the backend is running (http://127.0.0.1:8000/health should return {"status": "OK"}).
ü§ù Contact
Author: Kira Batalova

Feedback? Open an Issue. üöÄ

text
Wrap
Copy

---

### –Ø–∫ —Ü–µ –≤–∏–≥–ª—è–¥–∞—î?
- **–ó–∞–≥–æ–ª–æ–≤–æ–∫**: "SocialHub ‚Äì Telegram Chat Viewer" ‚Äî —á—ñ—Ç–∫–æ —ñ –∑ –Ω–∞–∑–≤–æ—é.
- **–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó**: –ü–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–æ –∑ SQLite –¥–ª—è –ø–æ–≤–Ω–æ—Ç–∏.
- **–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª**: –£—Å—ñ –∫–ª—é—á–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑ –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –¥–∏–∑–∞–π–Ω —ñ –∫–Ω–æ–ø–∫—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è.
- **–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è**: –ö–æ–º–ø–∞–∫—Ç–Ω–æ, —ñ–∑ –∫–æ–º–∞–Ω–¥–∞–º–∏ –≤ –±–ª–æ–∫–∞—Ö –∫–æ–¥—É, –≤—Ä–∞—Ö–æ–≤–∞–Ω–æ Windows/Linux/Mac.
- **–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è**: –û–∫—Ä–µ–º–∏–π —Ä–æ–∑–¥—ñ–ª —ñ–∑ –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º–∏.
- **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**: –ü–æ–∫—Ä–æ–∫–æ–≤–∏–π –æ–ø–∏—Å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
- **Troubleshooting**: –í—Ä–∞—Ö–æ–≤–∞–Ω–æ –Ω–∞—à—ñ –ø–æ–º–∏–ª–∫–∏ (429, –∑–∞—Ç—Ä–∏–º–∫–∏ –∫–æ–¥—É).
- **–ö–æ–Ω—Ç–∞–∫—Ç**: –¢–≤—ñ–π GitHub —ñ–∑ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º –¥–æ –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤‚Äô—è–∑–∫—É.

---

### –Ø–∫ –¥–æ–¥–∞—Ç–∏?
1. –°–∫–æ–ø—ñ—é–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç –≤–∏—â–µ –æ–¥–Ω–∏–º –∫–ª—ñ–∫–æ–º (Ctrl+A, Ctrl+C).
2. –í—ñ–¥–∫—Ä–∏–π `README.md` —É –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (`socialhub/`) —É —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, VS Code).
3. –í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç (Ctrl+V) —ñ –∑–±–µ—Ä–µ–∂–∏.
4. –î–æ–¥–∞–π –¥–æ git —ñ –≤—ñ–¥–ø—Ä–∞–≤:
   ```bash
   git add README.md
   git commit -m "–î–æ–¥–∞–Ω–æ –ø–æ–≤–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ README.md"
   git push origin main
–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
–ö–ª–æ–Ω—É–π —É –Ω–æ–≤—É –ø–∞–ø–∫—É:
bash
Wrap
Copy
git clone https://github.com/batalova-kira/socialhub.git test-clone
cd test-clone
–î–æ—Ç—Ä–∏–º—É–π—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —ñ–∑ README.md.
–¢–µ–ø–µ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ README.md –æ–¥–Ω–∏–º –∫–ª—ñ–∫–æ–º —ñ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç! –Ø–∫—â–æ —Ö–æ—á–µ—à –¥–æ–¥–∞—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏ —á–∏ –∑–º—ñ–Ω–∏—Ç–∏ —â–æ—Å—å, —Å–∫–∞–∂–∏! üòä






–ø—ñ—Å–ª—è  Clone the repository –≤—Å–µ –≤ –æ–¥–Ω–æ–º—É –≤–µ–ª–∏–∫–æ–º—É –≤—ñ–∫–Ω—ñ


–û—Å—å –æ–Ω–æ–≤–ª–µ–Ω–∏–π README.md, –¥–µ –ø—ñ—Å–ª—è "Clone the repository" —É—Å—ñ –∫—Ä–æ–∫–∏ –æ–±‚Äô—î–¥–Ω–∞–Ω—ñ –≤ –æ–¥–∏–Ω –≤–µ–ª–∏–∫–∏–π –±–ª–æ–∫ –∫–æ–¥—É –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –æ–¥–Ω–∏–º –∫–ª—ñ–∫–æ–º. –Ø –∑–±–µ—Ä—ñ–≥ —Ç–≤—ñ–π —Å—Ç–∏–ª—å —ñ–∑ –µ–º–æ–¥–∑—ñ —Ç–∞ –∞–¥–∞–ø—Ç—É–≤–∞–≤ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é:

README.md
markdown
Wrap
Copy
# SocialHub ‚Äì Telegram Chat Viewer

üìå SocialHub is a web application that allows you to connect a Telegram account, view chats, and read messages.

## üöÄ Technologies
- **Frontend**: Next.js
- **Backend**: FastAPI
- **Authentication**: JWT
- **Database**: SQLite

## ‚ö° Main Features
‚úÖ User registration & login via JWT
‚úÖ Connect a Telegram account
‚úÖ View chat list with minimalist design
‚úÖ Read messages in selected chats with a "Back to Chats" button
‚úÖ Disconnect from Telegram

## üîß Installation & Setup

### 1Ô∏è‚É£ Clone the repository
```bash
git clone https://github.com/batalova-kira/socialhub.git
cd socialhub
2Ô∏è‚É£ Setup and Run
bash
Wrap
Copy
# Install required software:
# - Git: https://git-scm.com/
# - Node.js (v16+): https://nodejs.org/
# - Python (3.9+): https://www.python.org/
# Check versions:
git --version
node --version
python --version  # or python3 --version on Linux/Mac

# Setup backend (FastAPI):
cd server
python -m venv venv  # Create virtual environment
# Activate it:
# Windows (CMD): venv\Scripts\activate
# Windows (Git Bash): source venv/Scripts/activate
# Mac/Linux: source venv/bin/activate
pip install -r requirements.txt  # Install dependencies (fastapi, uvicorn, sqlalchemy, aiosqlite, telethon, python-jose[cryptography], passlib[bcrypt], python-dotenv)
# Create and configure .env:
cp .env.example .env
# Edit server/.env with your text editor (e.g., Notepad or VS Code):
# API_ID=your_telegram_api_id (get from https://my.telegram.org)
# API_HASH=your_telegram_api_hash (get from https://my.telegram.org)
# JWT_SECRET=your_secret_key (e.g., "mysecretkey123")
# Start FastAPI server (in this terminal):
python -m uvicorn main:app --reload
# Backend runs at: http://127.0.0.1:8000

# Setup frontend (Next.js):
cd ../client
npm install  # Install dependencies
# Start Next.js (open a new terminal for this):
npm run dev
# Frontend runs at: http://localhost:3000

# How to use:
# 1. Open http://localhost:3000 in your browser
# 2. Register (e.g., username: "test123", password: "password123") or login
# 3. Enter Telegram phone number (e.g., +380963048847) and click "Get Code"
# 4. Wait for code in Telegram (SMS or call, up to 1-2 minutes)
# 5. Enter code and click "Connect"
# 6. View chats and messages

ü§ù Contact
Author: https://github.com/batalova-kira

Feedback? Open an https://github.com/batalova-kira/socialhub/issues. üöÄ

````
